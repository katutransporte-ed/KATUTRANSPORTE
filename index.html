<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Katutransporte ‚Äî Transporte Escolar Seguro</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet" />

  <!-- Leaflet.js (Pilar 4 ‚Äî Mapa real) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ============================================================
       CSS VARIABLES & RESET
    ============================================================ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary:    #FF6B35;
      --secondary:  #FFB627;
      --accent:     #4ECDC4;
      --success:    #2ECC71;
      --info:       #6B9BF5;
      --danger:     #FF5858;
      --purple:     #9B59B6;
      --bg:         #FFF8F0;
      --bg-deep:    #FFE8D6;
      --white:      #FFFFFF;
      --dark:       #2C3E50;
      --muted:      #7F8C8D;
      --border:     #E8E0D8;
      --shadow-sm:  0 2px 10px rgba(0,0,0,0.07);
      --shadow:     0 8px 30px rgba(0,0,0,0.10);
      --shadow-lg:  0 20px 60px rgba(0,0,0,0.14);
      --radius:     20px;
      --radius-sm:  12px;
      --radius-xl:  30px;
      --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: linear-gradient(145deg, var(--bg) 0%, var(--bg-deep) 100%);
      min-height: 100vh;
      color: var(--dark);
      overflow-x: hidden;
    }

    h1, h2, h3, h4, h5 { font-family: 'Fredoka', sans-serif; font-weight: 600; }

    /* ============================================================
       ACCESSIBILITY ‚Äî Screen reader only
    ============================================================ */
    .sr-only {
      position: absolute; width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden;
      clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }

    /* Focus ring vis√≠vel para navega√ß√£o por teclado */
    :focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 3px;
      border-radius: 6px;
    }

    /* ============================================================
       BACKGROUND ANIMATION
    ============================================================ */
    .bg-clouds {
      position: fixed; inset: 0; z-index: -1; overflow: hidden;
      pointer-events: none;
    }
    .cloud {
      position: absolute;
      background: rgba(255,255,255,0.55);
      border-radius: 100px;
      animation: cloudFloat linear infinite;
    }
    .cloud:nth-child(1){ width:110px; height:40px; top:8%;  animation-duration:28s; animation-delay:0s; }
    .cloud:nth-child(2){ width:160px; height:52px; top:28%; animation-duration:36s; animation-delay:6s;  }
    .cloud:nth-child(3){ width:90px;  height:32px; top:55%; animation-duration:22s; animation-delay:12s; }
    .cloud:nth-child(4){ width:130px; height:44px; top:75%; animation-duration:31s; animation-delay:3s;  }

    @keyframes cloudFloat {
      from { transform: translateX(-200px); }
      to   { transform: translateX(calc(100vw + 200px)); }
    }

    /* ============================================================
       HEADER
    ============================================================ */
    header {
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 900;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to   { transform: translateY(0);     opacity: 1; }
    }

    .header-inner {
      max-width: 1400px; margin: 0 auto;
      padding: 0.9rem 2rem;
      display: flex; justify-content: space-between; align-items: center;
    }

    .logo {
      display: flex; align-items: center; gap: 0.9rem;
      text-decoration: none; color: var(--dark);
    }

    .logo-icon {
      width: 48px; height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      box-shadow: 0 4px 14px rgba(255,107,53,0.35);
      animation: logoBounce 3s ease-in-out infinite;
    }

    @keyframes logoBounce {
      0%,100% { transform: translateY(0); }
      50%      { transform: translateY(-6px); }
    }

    .logo-text h1 { font-size: 1.6rem; color: var(--primary); line-height: 1; }
    .logo-text small { font-size: 0.72rem; color: var(--muted); }

    .nav-menu { display: flex; gap: 0.8rem; align-items: center; }

    /* ============================================================
       BUTTONS
    ============================================================ */
    .btn {
      padding: 0.75rem 1.6rem;
      border: none; border-radius: 50px;
      font-family: 'Fredoka', sans-serif; font-size: 1rem; font-weight: 500;
      cursor: pointer; transition: all var(--transition);
      display: inline-flex; align-items: center; gap: 0.4rem;
    }

    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      box-shadow: 0 4px 14px rgba(255,107,53,0.35);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 22px rgba(255,107,53,0.45);
    }

    .btn-outline {
      background: transparent; color: var(--primary);
      border: 2px solid var(--primary);
    }
    .btn-outline:hover:not(:disabled) {
      background: var(--primary); color: #fff;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--accent), #2EBCB3);
      color: #fff;
      box-shadow: 0 4px 14px rgba(78,205,196,0.35);
    }
    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    .btn-sm { padding: 0.5rem 1rem; font-size: 0.88rem; }

    /* ============================================================
       MAIN WRAPPER
    ============================================================ */
    .main { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }

    /* ============================================================
       AUTH SCREENS
    ============================================================ */
    .auth-screen {
      display: flex; align-items: center; justify-content: center;
      min-height: calc(100vh - 120px);
    }

    .auth-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 3rem;
      width: 100%; max-width: 480px;
      box-shadow: var(--shadow-lg);
      animation: fadeUp 0.55s ease-out;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(28px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .auth-icon {
      width: 130px; height: 130px; margin: 0 auto 1.5rem;
      background: linear-gradient(135deg, var(--accent), var(--info));
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 3.5rem;
      animation: pulse 2.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%,100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(78,205,196,0.3); }
      50%      { transform: scale(1.05); box-shadow: 0 0 0 12px rgba(78,205,196,0); }
    }

    .auth-card h2 { text-align: center; font-size: 1.9rem; color: var(--primary); margin-bottom: 0.3rem; }
    .auth-card > p { text-align: center; color: var(--muted); margin-bottom: 1.8rem; }

    /* ============================================================
       FORMS
    ============================================================ */
    .form-group { margin-bottom: 1.3rem; position: relative; }

    .form-group label {
      display: block; margin-bottom: 0.45rem;
      font-weight: 500; font-size: 0.9rem; color: var(--dark);
    }

    .form-control {
      width: 100%; padding: 0.9rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.95rem; font-family: 'DM Sans', sans-serif;
      transition: border-color var(--transition), box-shadow var(--transition);
      background: #FAFAFA;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--white);
      box-shadow: 0 0 0 4px rgba(255,107,53,0.12);
    }

    .form-control.is-invalid { border-color: var(--danger); }
    .form-control.is-valid   { border-color: var(--success); }

    /* Mensagem de erro inline */
    .field-error {
      display: block; font-size: 0.80rem; color: var(--danger);
      margin-top: 4px; padding-left: 2px;
      animation: fadeUp 0.2s ease-out;
    }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    /* ============================================================
       ALERT BANNERS
    ============================================================ */
    .alert {
      padding: 0.9rem 1.2rem; border-radius: var(--radius-sm);
      margin-bottom: 1rem; border-left: 4px solid transparent;
      font-size: 0.9rem; font-weight: 500;
      display: flex; align-items: center; gap: 0.6rem;
      animation: slideRight 0.3s ease-out;
    }

    @keyframes slideRight {
      from { opacity: 0; transform: translateX(20px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    .alert-success { background: rgba(46,204,113,0.12); color: #1A7A43; border-color: var(--success); }
    .alert-error   { background: rgba(255,88,88,0.12);  color: #C0392B; border-color: var(--danger);  }
    .alert-info    { background: rgba(107,155,245,0.12);color: #1A56C4; border-color: var(--info);    }

    /* ============================================================
       DASHBOARD
    ============================================================ */
    .dashboard { display: none; }
    .dashboard.active { display: block; animation: fadeUp 0.4s ease-out; }

    .dash-header {
      background: var(--white); border-radius: var(--radius);
      padding: 1.8rem 2rem; margin-bottom: 1.8rem;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: var(--shadow-sm);
    }

    .dash-header h2 { font-size: 1.9rem; color: var(--primary); }
    .dash-header h2 span { color: var(--dark); }

    .role-badge {
      display: inline-block; padding: 0.4rem 1rem;
      background: linear-gradient(135deg, var(--accent), #2EBCB3);
      color: #fff; border-radius: 50px; font-size: 0.82rem; font-weight: 600;
      margin-top: 0.3rem;
    }

    /* Tabs */
    .nav-tabs {
      display: flex; gap: 0.7rem; margin-bottom: 1.8rem;
      overflow-x: auto; padding-bottom: 4px;
      scrollbar-width: none;
    }
    .nav-tabs::-webkit-scrollbar { display: none; }

    .nav-tab {
      padding: 0.8rem 1.6rem; white-space: nowrap;
      background: var(--white); border: none; border-radius: 50px;
      font-family: 'Fredoka', sans-serif; font-size: 0.95rem; font-weight: 500;
      cursor: pointer; transition: all var(--transition);
      box-shadow: var(--shadow-sm); color: var(--dark);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff; transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(255,107,53,0.35);
    }

    .nav-tab:hover:not(.active) { transform: translateY(-1px); }

    /* Content Sections */
    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.35s ease-out; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    /* ============================================================
       STAT CARDS
    ============================================================ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.2rem; margin-bottom: 1.8rem;
    }

    .stat-card {
      background: var(--white); border-radius: var(--radius);
      padding: 1.8rem; box-shadow: var(--shadow-sm);
      border-left: 5px solid var(--primary);
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }

    .stat-icon {
      width: 52px; height: 52px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; margin-bottom: 0.9rem;
    }

    .stat-num {
      font-family: 'Fredoka', sans-serif;
      font-size: 2.4rem; font-weight: 700; color: var(--dark);
      transition: all 0.4s ease;
    }

    .stat-label { color: var(--muted); font-size: 0.88rem; margin-top: 0.2rem; }

    /* ============================================================
       PANELS / LIST WRAPPERS
    ============================================================ */
    .panel {
      background: var(--white); border-radius: var(--radius);
      padding: 2rem; box-shadow: var(--shadow-sm); margin-bottom: 1.5rem;
    }

    .panel-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1.5rem;
    }

    .panel-header h3 { font-size: 1.4rem; color: var(--dark); }

    /* ============================================================
       CHILD CARDS
    ============================================================ */
    .child-card {
      background: linear-gradient(135deg, #FFF8F0, var(--white));
      border-radius: var(--radius-sm); padding: 1.3rem 1.5rem;
      margin-bottom: 0.9rem;
      display: flex; justify-content: space-between; align-items: center;
      border-left: 4px solid var(--accent);
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .child-card:hover { transform: translateX(4px); box-shadow: var(--shadow-sm); }

    .child-info { display: flex; align-items: center; gap: 1.2rem; }

    .child-avatar {
      width: 52px; height: 52px; border-radius: 50%;
      background: linear-gradient(135deg, var(--info), var(--purple));
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; color: #fff; font-weight: 700;
      flex-shrink: 0;
    }

    .child-details h4 { margin-bottom: 0.2rem; font-size: 1rem; }
    .child-meta { color: var(--muted); font-size: 0.82rem; margin-top: 0.1rem; }

    /* Status Badges */
    .badge {
      padding: 0.35rem 0.9rem; border-radius: 50px;
      font-size: 0.78rem; font-weight: 600; white-space: nowrap;
    }

    .badge-waiting   { background: rgba(255,182,39,0.18);  color: #B45309; }
    .badge-picked    { background: rgba(46,204,113,0.15);  color: #0A6E37; }
    .badge-transit   { background: rgba(107,155,245,0.18); color: #1A56C4; }
    .badge-delivered { background: rgba(78,205,196,0.18);  color: #0A7068; }

    /* ============================================================
       SKELETON SCREENS (Pilar 2)
    ============================================================ */
    .skeleton {
      background: #F0EDE8;
      border-radius: var(--radius-sm); overflow: hidden;
      position: relative;
    }

    .skeleton::after {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(90deg,
        transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%);
      background-size: 200% 100%;
      animation: shimmer 1.6s infinite;
    }

    @keyframes shimmer {
      from { background-position: 200% 0; }
      to   { background-position: -200% 0; }
    }

    .skel-card {
      background: var(--white); border-radius: var(--radius-sm);
      padding: 1.3rem 1.5rem; margin-bottom: 0.9rem;
      display: flex; align-items: center; gap: 1.2rem;
    }

    .skel-avatar { width:52px; height:52px; border-radius:50%; }
    .skel-line   { height: 14px; border-radius: 6px; }
    .skel-w60    { width: 60%; }
    .skel-w40    { width: 40%; margin-top: 6px; }
    .skel-badge  { width: 80px; height: 28px; border-radius: 50px; }

    /* ============================================================
       EMPTY STATE (Pilar 2)
    ============================================================ */
    .empty-state {
      text-align: center; padding: 3.5rem 1rem;
    }

    .empty-state-icon {
      font-size: 4.5rem; margin-bottom: 1rem;
      animation: floatIcon 3s ease-in-out infinite;
    }

    @keyframes floatIcon {
      0%,100% { transform: translateY(0); }
      50%      { transform: translateY(-10px); }
    }

    .empty-state h3 { font-size: 1.5rem; color: var(--dark); margin-bottom: 0.5rem; }
    .empty-state p  { color: var(--muted); max-width: 320px; margin: 0 auto 1.5rem; }

    /* ============================================================
       MAP (Pilar 4 ‚Äî Leaflet)
    ============================================================ */
    #map {
      height: 420px; border-radius: var(--radius);
      z-index: 1; overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .map-note {
      text-align: center; color: var(--muted);
      font-size: 0.82rem; margin-top: 0.7rem;
    }

    /* ============================================================
       NOTIFICATIONS
    ============================================================ */
    .notif-item {
      padding: 1.2rem 1.4rem;
      background: linear-gradient(135deg, #FFF8F0, var(--white));
      border-radius: var(--radius-sm); margin-bottom: 0.9rem;
      border-left: 4px solid var(--info);
      transition: transform var(--transition);
    }

    .notif-item:hover { transform: translateX(4px); }
    .notif-time { color: var(--muted); font-size: 0.78rem; margin-bottom: 0.4rem; }
    .notif-msg  { font-weight: 500; font-size: 0.9rem; }

    /* ============================================================
       PAYMENTS
    ============================================================ */
    .payment-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.2rem 0; border-bottom: 1px solid var(--border);
    }

    .payment-row:last-child { border-bottom: none; }
    .payment-desc h4 { font-size: 0.95rem; }
    .payment-desc small { color: var(--muted); font-size: 0.78rem; }
    .payment-amount { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; color: var(--dark); }

    .badge-paid    { background: rgba(46,204,113,0.15);  color: #0A6E37; }
    .badge-pending { background: rgba(255,88,88,0.15);   color: #C0392B; }

    /* ============================================================
       DRIVER PICKUP ITEMS
    ============================================================ */
    .pickup-item {
      background: linear-gradient(135deg, #FFF8F0, var(--white));
      border-radius: var(--radius-sm); padding: 1.3rem 1.5rem;
      margin-bottom: 0.9rem;
      display: flex; justify-content: space-between; align-items: center;
      border-left: 4px solid var(--secondary);
    }

    .pickup-num {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--primary); color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1rem; flex-shrink: 0;
    }

    .action-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    /* ============================================================
       MODAL
    ============================================================ */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.45); z-index: 1000;
      align-items: center; justify-content: center;
      padding: 1rem;
    }

    .modal-overlay.active { display: flex; }

    .modal-box {
      background: var(--white); border-radius: var(--radius-xl);
      padding: 2.5rem; width: 100%; max-width: 560px;
      max-height: 90vh; overflow-y: auto;
      animation: modalIn 0.28s ease-out;
    }

    @keyframes modalIn {
      from { transform: scale(0.88); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }

    .modal-head {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-head h3 { font-size: 1.6rem; color: var(--primary); }

    .modal-close {
      background: none; border: none; font-size: 1.8rem;
      color: var(--muted); cursor: pointer;
      transition: color var(--transition), transform var(--transition);
      line-height: 1;
    }

    .modal-close:hover { color: var(--danger); transform: rotate(90deg); }

    /* ============================================================
       GLOBAL SPINNER (Pilar 2)
    ============================================================ */
    .spinner-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(255,255,255,0.82); z-index: 2000;
      align-items: center; justify-content: center;
    }

    .spinner-overlay.active { display: flex; }

    .spinner {
      width: 52px; height: 52px;
      border: 5px solid #f0ede8;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ============================================================
       TOAST NOTIFICATIONS
    ============================================================ */
    #toast-container {
      position: fixed; bottom: 1.5rem; right: 1.5rem;
      z-index: 3000; display: flex; flex-direction: column; gap: 0.6rem;
    }

    .toast {
      padding: 0.9rem 1.4rem; border-radius: var(--radius-sm);
      font-size: 0.88rem; font-weight: 500;
      box-shadow: var(--shadow); min-width: 260px; max-width: 360px;
      animation: toastIn 0.3s ease-out;
      display: flex; align-items: center; gap: 0.6rem;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(40px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; transform: translateX(0); }
      to   { opacity: 0; transform: translateX(40px); }
    }

    .toast-success { background: #F0FFF8; color: #065F46; border-left: 4px solid var(--success); }
    .toast-error   { background: #FFF5F5; color: #7F1D1D; border-left: 4px solid var(--danger); }
    .toast-info    { background: #EFF6FF; color: #1E3A8A; border-left: 4px solid var(--info); }

    /* ============================================================
       ADMIN
    ============================================================ */
    .admin-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.2rem; margin-bottom: 1.5rem;
    }

    .admin-card {
      background: var(--white); border-radius: var(--radius);
      padding: 2rem; box-shadow: var(--shadow-sm); text-align: center;
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .admin-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }

    .admin-icon {
      width: 70px; height: 70px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem; margin: 0 auto 1rem;
    }

    /* ============================================================
       RESPONSIVE
    ============================================================ */
    @media (max-width: 768px) {
      .header-inner { flex-direction: column; gap: 0.8rem; padding: 1rem; }
      .main         { padding: 0 1rem; }
      .auth-card    { padding: 2rem 1.5rem; }
      .dash-header  { flex-direction: column; gap: 1rem; text-align: center; }
      .child-card   { flex-direction: column; align-items: flex-start; gap: 0.8rem; }
      .pickup-item  { flex-direction: column; gap: 0.8rem; }
      .form-row     { grid-template-columns: 1fr; }
      #map          { height: 300px; }
    }

    /* ============================================================
       UTILITIES
    ============================================================ */
    .hidden  { display: none !important; }
    .mt-1    { margin-top: 1rem; }
    .mt-2    { margin-top: 2rem; }
    .mb-1    { margin-bottom: 1rem; }
    .center  { text-align: center; }
    .muted   { color: var(--muted); }
  </style>
</head>
<body>

<!-- ================================================================
     BACKGROUND
================================================================ -->
<div class="bg-clouds" aria-hidden="true">
  <div class="cloud"></div>
  <div class="cloud"></div>
  <div class="cloud"></div>
  <div class="cloud"></div>
</div>

<!-- ================================================================
     HEADER
================================================================ -->
<header role="banner">
  <div class="header-inner">
    <a href="#" class="logo" aria-label="Katutransporte ‚Äî P√°gina inicial">
      <div class="logo-icon" aria-hidden="true">üöå</div>
      <div class="logo-text">
        <h1>Katutransporte</h1>
        <small>Transporte Escolar Seguro</small>
      </div>
    </a>
    <nav class="nav-menu" id="navMenu" aria-label="Menu principal">
      <button class="btn btn-outline" onclick="App.ui.showLogin()">Entrar</button>
      <button class="btn btn-primary" onclick="App.ui.showRegister()">Registar</button>
    </nav>
  </div>
</header>

<!-- ================================================================
     MAIN
================================================================ -->
<main class="main" id="mainContent">

  <!-- LOGIN -->
  <div id="loginScreen" class="auth-screen" role="main" aria-label="Ecr√£ de login">
    <div class="auth-card">
      <div class="auth-icon" aria-hidden="true">üéí</div>
      <h2>Bem-vindo de volta!</h2>
      <p>Entre para acompanhar os seus filhos em seguran√ßa</p>
      <div id="loginAlert" role="alert" aria-live="assertive"></div>
      <form id="loginForm" novalidate>
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" name="email" class="form-control"
                 placeholder="seu@email.com" autocomplete="email"
                 aria-required="true" aria-describedby="loginEmailErr" />
          <span id="loginEmailErr" class="field-error" role="alert"></span>
        </div>
        <div class="form-group">
          <label for="loginPwd">Senha</label>
          <input type="password" id="loginPwd" name="password" class="form-control"
                 placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
                 aria-required="true" aria-describedby="loginPwdErr" />
          <span id="loginPwdErr" class="field-error" role="alert"></span>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;border-radius:12px;padding:1rem;">
          Entrar
        </button>
      </form>
      <p class="center mt-1">
        N√£o tem conta?
        <a href="#" class="muted" onclick="App.ui.showRegister(); return false;"
           style="color:var(--primary);font-weight:500;">Registar aqui</a>
      </p>
    </div>
  </div>

  <!-- REGISTER -->
  <div id="registerScreen" class="auth-screen hidden" role="main" aria-label="Ecr√£ de registo">
    <div class="auth-card">
      <div class="auth-icon" aria-hidden="true">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
      <h2>Criar Conta</h2>
      <p>Junte-se √† fam√≠lia Katutransporte</p>
      <div id="registerAlert" role="alert" aria-live="assertive"></div>
      <form id="registerForm" novalidate>
        <div class="form-group">
          <label for="regName">Nome Completo</label>
          <input type="text" id="regName" name="name" class="form-control"
                 placeholder="Seu nome completo" autocomplete="name"
                 aria-required="true" aria-describedby="regNameErr" />
          <span id="regNameErr" class="field-error" role="alert"></span>
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" name="email" class="form-control"
                 placeholder="seu@email.com" autocomplete="email"
                 aria-required="true" aria-describedby="regEmailErr" />
          <span id="regEmailErr" class="field-error" role="alert"></span>
        </div>
        <div class="form-group">
          <label for="regPhone">Telefone</label>
          <input type="tel" id="regPhone" name="phone" class="form-control"
                 placeholder="+244 900 000 000" autocomplete="tel"
                 aria-required="true" aria-describedby="regPhoneErr" />
          <span id="regPhoneErr" class="field-error" role="alert"></span>
        </div>
        <div class="form-group">
          <label for="regPwd">Senha</label>
          <input type="password" id="regPwd" name="password" class="form-control"
                 placeholder="M√≠nimo 8 caracteres" autocomplete="new-password"
                 aria-required="true" aria-describedby="regPwdErr" />
          <span id="regPwdErr" class="field-error" role="alert"></span>
        </div>
        <div class="form-group">
          <label for="regRole">Tipo de Conta</label>
          <select id="regRole" name="role" class="form-control" aria-required="true">
            <option value="parent">Pai / Respons√°vel</option>
            <option value="driver">Motorista</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;border-radius:12px;padding:1rem;">
          Criar Conta
        </button>
      </form>
      <p class="center mt-1">
        J√° tem conta?
        <a href="#" onclick="App.ui.showLogin(); return false;"
           style="color:var(--primary);font-weight:500;">Entrar aqui</a>
      </p>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="dashboard" role="main" aria-label="Painel de controlo">

    <div class="dash-header">
      <div>
        <h2>Ol√°, <span id="userName">Utilizador</span>! üëã</h2>
        <span class="role-badge" id="userRoleBadge">Pai/Respons√°vel</span>
      </div>
      <button class="btn btn-outline" onclick="App.auth.logout()">
        <span aria-hidden="true">üö™</span> Sair
      </button>
    </div>

    <nav class="nav-tabs" role="tablist" aria-label="Sec√ß√µes do painel">
      <button class="nav-tab active" role="tab" aria-selected="true"  aria-controls="overviewSection"      onclick="App.ui.showTab('overview',this)">üìä Vis√£o Geral</button>
      <button class="nav-tab"        role="tab" aria-selected="false" aria-controls="childrenSection"      onclick="App.ui.showTab('children',this)">üë∂ Crian√ßas</button>
      <button class="nav-tab"        role="tab" aria-selected="false" aria-controls="trackingSection"      onclick="App.ui.showTab('tracking',this)">üìç Rastreamento</button>
      <button class="nav-tab"        role="tab" aria-selected="false" aria-controls="notificationsSection" onclick="App.ui.showTab('notifications',this)">üîî Notifica√ß√µes</button>
      <button class="nav-tab"        role="tab" aria-selected="false" aria-controls="paymentsSection"      onclick="App.ui.showTab('payments',this)">üí≥ Pagamentos</button>
      <button class="nav-tab hidden" role="tab" aria-selected="false" aria-controls="routesSection"        id="routesTab" onclick="App.ui.showTab('routes',this)">üó∫Ô∏è Rotas</button>
      <button class="nav-tab hidden" role="tab" aria-selected="false" aria-controls="adminSection"         id="adminTab"  onclick="App.ui.showTab('admin',this)">‚öôÔ∏è Admin</button>
    </nav>

    <!-- OVERVIEW -->
    <section id="overviewSection" class="section active" role="tabpanel" aria-label="Vis√£o geral">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background:linear-gradient(135deg,var(--accent),#2EBCB3);">
            <span aria-hidden="true">üë∂</span>
          </div>
          <div class="stat-num" id="statChildren">0</div>
          <div class="stat-label">Crian√ßas Registadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:linear-gradient(135deg,var(--info),var(--purple));">
            <span aria-hidden="true">üöå</span>
          </div>
          <div class="stat-num" id="statActive">0</div>
          <div class="stat-label">Em Transporte Agora</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:linear-gradient(135deg,var(--primary),var(--secondary));">
            <span aria-hidden="true">‚úÖ</span>
          </div>
          <div class="stat-num" id="statDone">0</div>
          <div class="stat-label">Viagens Conclu√≠das</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><h3>Atividade Recente</h3></div>
        <div id="recentList"></div>
      </div>
    </section>

    <!-- CHILDREN -->
    <section id="childrenSection" class="section" role="tabpanel" aria-label="Gest√£o de crian√ßas">
      <div class="panel">
        <div class="panel-header">
          <h3>Minhas Crian√ßas</h3>
          <button class="btn btn-success btn-sm" onclick="App.ui.openChildModal()">
            <span aria-hidden="true">+</span> Adicionar
          </button>
        </div>
        <div id="childrenList"></div>
      </div>
    </section>

    <!-- TRACKING -->
    <section id="trackingSection" class="section" role="tabpanel" aria-label="Rastreamento em tempo real">
      <div class="panel" style="padding-bottom:1rem;">
        <div class="panel-header">
          <h3>Mapa em Tempo Real</h3>
          <span class="badge badge-transit" id="busStatusBadge">üü¢ Ativo</span>
        </div>
        <div id="map" aria-label="Mapa de rastreamento do autocarro escolar"></div>
        <p class="map-note">Posi√ß√£o simulada ‚Äî integra√ß√£o com GPS real via WebSocket na vers√£o de produ√ß√£o</p>
      </div>
      <div class="panel">
        <div class="panel-header"><h3>Estado das Crian√ßas</h3></div>
        <div id="trackingList"></div>
      </div>
    </section>

    <!-- NOTIFICATIONS -->
    <section id="notificationsSection" class="section" role="tabpanel" aria-label="Notifica√ß√µes">
      <div class="panel">
        <div class="panel-header">
          <h3>Notifica√ß√µes</h3>
          <span class="badge badge-transit" id="notifCount" aria-live="polite">0 novas</span>
        </div>
        <div id="notifList" aria-live="polite" aria-relevant="additions"></div>
      </div>
    </section>

    <!-- PAYMENTS -->
    <section id="paymentsSection" class="section" role="tabpanel" aria-label="Pagamentos">
      <div class="panel">
        <div class="panel-header"><h3>Hist√≥rico de Pagamentos</h3></div>
        <div id="paymentList"></div>
      </div>
    </section>

    <!-- ROUTES (Driver) -->
    <section id="routesSection" class="section" role="tabpanel" aria-label="Rota do motorista">
      <div class="panel">
        <div class="panel-header"><h3>Minha Rota de Hoje</h3></div>
        <div id="routeList"></div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="adminSection" class="section" role="tabpanel" aria-label="Administra√ß√£o">
      <div class="admin-grid">
        <div class="admin-card">
          <div class="admin-icon" style="background:linear-gradient(135deg,var(--accent),#2EBCB3);">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <div class="stat-num" id="adminFamilies">0</div>
          <div class="stat-label">Fam√≠lias Ativas</div>
        </div>
        <div class="admin-card">
          <div class="admin-icon" style="background:linear-gradient(135deg,var(--info),var(--purple));">üöå</div>
          <div class="stat-num" id="adminDrivers">0</div>
          <div class="stat-label">Motoristas</div>
        </div>
        <div class="admin-card">
          <div class="admin-icon" style="background:linear-gradient(135deg,var(--primary),var(--secondary));">üí∞</div>
          <div class="stat-num" id="adminRevenue">0 Kz</div>
          <div class="stat-label">Receita Mensal</div>
        </div>
      </div>
      <div class="panel">
        <h3>Gest√£o de Rotas</h3>
        <p class="muted mt-1">Otimiza√ß√£o autom√°tica de rotas em desenvolvimento.</p>
        <button class="btn btn-success mt-1">+ Criar Nova Rota</button>
      </div>
    </section>

  </div><!-- /dashboard -->
</main>

<!-- ================================================================
     MODAL ‚Äî ADD CHILD
================================================================ -->
<div id="childModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="childModalTitle">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="childModalTitle">Adicionar Crian√ßa</h3>
      <button class="modal-close" onclick="App.ui.closeChildModal()" aria-label="Fechar modal">&times;</button>
    </div>
    <form id="childForm" novalidate>
      <div class="form-group">
        <label for="cName">Nome da Crian√ßa</label>
        <input type="text" id="cName" name="name" class="form-control"
               aria-required="true" aria-describedby="cNameErr" placeholder="Nome completo" />
        <span id="cNameErr" class="field-error" role="alert"></span>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="cAge">Idade</label>
          <input type="number" id="cAge" name="age" class="form-control"
                 min="3" max="18" aria-required="true" aria-describedby="cAgeErr" placeholder="Ex: 8" />
          <span id="cAgeErr" class="field-error" role="alert"></span>
        </div>
        <div class="form-group">
          <label for="cGender">G√©nero</label>
          <select id="cGender" name="gender" class="form-control">
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="cSchool">Escola</label>
        <input type="text" id="cSchool" name="school" class="form-control"
               aria-required="true" aria-describedby="cSchoolErr" placeholder="Nome da escola" />
        <span id="cSchoolErr" class="field-error" role="alert"></span>
      </div>
      <div class="form-group">
        <label for="cAddress">Endere√ßo Residencial</label>
        <input type="text" id="cAddress" name="address" class="form-control"
               aria-required="true" aria-describedby="cAddressErr" placeholder="Rua, n√∫mero, bairro" />
        <span id="cAddressErr" class="field-error" role="alert"></span>
      </div>
      <div class="form-group">
        <label for="cEmergency">Contacto de Emerg√™ncia</label>
        <input type="tel" id="cEmergency" name="emergency_contact" class="form-control"
               aria-required="true" aria-describedby="cEmergencyErr" placeholder="+244 900 000 000" />
        <span id="cEmergencyErr" class="field-error" role="alert"></span>
      </div>
      <div class="form-group">
        <label for="cMedical">Informa√ß√µes M√©dicas</label>
        <textarea id="cMedical" name="medical_info" class="form-control" rows="3"
                  placeholder="Alergias, medicamentos, condi√ß√µes especiais‚Ä¶"></textarea>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;border-radius:12px;padding:1rem;">
        Guardar Crian√ßa
      </button>
    </form>
  </div>
</div>

<!-- Spinner Global -->
<div id="spinner" class="spinner-overlay" aria-live="assertive" aria-label="A carregar">
  <div class="spinner" role="status"><span class="sr-only">A carregar‚Ä¶</span></div>
</div>

<!-- Toast Container -->
<div id="toast-container" aria-live="polite" aria-atomic="false"></div>

<!-- ================================================================
     JAVASCRIPT ‚Äî Modular, Clean Code
================================================================ -->
<script>
/* ================================================================
   PILAR 3 ‚Äî ESTADO GLOBAL CENTRALIZADO
================================================================ */
const State = {
  _data: {
    user:          null,
    token:         null,
    children:      [],
    notifications: [],
    payments:      [],
    route:         [],
  },

  get(key)        { return this._data[key]; },
  set(key, value) {
    this._data[key] = value;
    this._persist(key, value);
    EventBus.emit('state:changed', { key, value });
  },

  _persist(key, value) {
    const persistKeys = ['token', 'user', 'children', 'notifications', 'payments'];
    if (persistKeys.includes(key)) {
      try {
        if (value === null) localStorage.removeItem(`katu_${key}`);
        else localStorage.setItem(`katu_${key}`, JSON.stringify(value));
      } catch(e) { /* quota exceeded */ }
    }
  },

  load() {
    ['token','user','children','notifications','payments'].forEach(key => {
      try {
        const raw = localStorage.getItem(`katu_${key}`);
        if (raw) this._data[key] = JSON.parse(raw);
      } catch(e) {}
    });
  },

  clear() {
    ['token','user','children','notifications','payments','route'].forEach(key => {
      this._data[key] = key === 'children' || key === 'notifications' || key === 'payments' || key === 'route' ? [] : null;
      localStorage.removeItem(`katu_${key}`);
    });
  }
};

/* ================================================================
   MINI EVENT BUS
================================================================ */
const EventBus = {
  _handlers: {},
  on(event, fn)  { (this._handlers[event] = this._handlers[event] || []).push(fn); },
  emit(event, data) { (this._handlers[event] || []).forEach(fn => fn(data)); }
};

/* ================================================================
   PILAR 2 ‚Äî VALIDATORS
================================================================ */
const Validators = {
  rules: {
    email:            { test: v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v),  msg: 'Email inv√°lido.' },
    password:         { test: v => v.length >= 8,                           msg: 'M√≠nimo 8 caracteres.' },
    name:             { test: v => v.trim().length >= 3,                    msg: 'M√≠nimo 3 caracteres.' },
    phone:            { test: v => /^\+?[0-9\s\-]{8,15}$/.test(v),         msg: 'Telefone inv√°lido.' },
    emergency_contact:{ test: v => /^\+?[0-9\s\-]{8,15}$/.test(v),         msg: 'Contacto inv√°lido.' },
    age:              { test: v => Number(v) >= 3 && Number(v) <= 18,        msg: 'Idade entre 3 e 18 anos.' },
    school:           { test: v => v.trim().length >= 2,                    msg: 'Insira o nome da escola.' },
    address:          { test: v => v.trim().length >= 5,                    msg: 'Endere√ßo muito curto.' },
  },

  validateField(input) {
    const rule = this.rules[input.name];
    if (!rule) return true;
    const ok = rule.test(input.value);
    const errEl = document.getElementById(input.getAttribute('aria-describedby'));
    input.classList.toggle('is-invalid', !ok);
    input.classList.toggle('is-valid', ok);
    input.setAttribute('aria-invalid', String(!ok));
    if (errEl) errEl.textContent = ok ? '' : rule.msg;
    return ok;
  },

  validateForm(form) {
    let valid = true;
    form.querySelectorAll('input[aria-required], select[aria-required]').forEach(input => {
      if (!this.validateField(input)) valid = false;
    });
    return valid;
  },

  attachLiveValidation(form) {
    form.querySelectorAll('input, select').forEach(input => {
      input.addEventListener('blur',  () => this.validateField(input));
      input.addEventListener('input', () => { if (input.classList.contains('is-invalid')) this.validateField(input); });
    });
  }
};

/* ================================================================
   PILAR 1 ‚Äî COMPONENTS (fun√ß√µes que geram HTML)
================================================================ */
const Components = {

  /* Retorna o label e a classe de um status */
  _statusMap: {
    waiting:   { label: 'Aguardando',    cls: 'badge-waiting'   },
    picked:    { label: 'Recolhida',     cls: 'badge-picked'    },
    transit:   { label: 'Em Transporte', cls: 'badge-transit'   },
    delivered: { label: 'Entregue',      cls: 'badge-delivered' },
  },

  statusBadge(status) {
    const s = this._statusMap[status] || { label: status, cls: '' };
    return `<span class="badge ${s.cls}" role="status" aria-live="polite">${s.label}</span>`;
  },

  childCard(child, variant = 'parent') {
    const actions = variant === 'driver' ? `
      <div class="action-btns">
        <button class="btn btn-success btn-sm"
          onclick="App.driver.updateStatus(${child.id},'picked')"
          aria-label="Confirmar recolha de ${child.name}">‚úÖ Recolher</button>
        <button class="btn btn-outline btn-sm"
          onclick="App.driver.updateStatus(${child.id},'delivered')"
          aria-label="Confirmar entrega de ${child.name}">üè´ Entregar</button>
      </div>` : '';

    return `
      <article class="child-card" aria-label="Crian√ßa: ${child.name}">
        <div class="child-info">
          <div class="child-avatar" aria-hidden="true">${child.name.charAt(0).toUpperCase()}</div>
          <div class="child-details">
            <h4>${child.name}</h4>
            <p class="child-meta">${child.school} ¬∑ ${child.age} anos</p>
            <p class="child-meta">
              <span aria-hidden="true">üìç</span>
              <span class="sr-only">Endere√ßo:</span> ${child.address}
            </p>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.5rem;">
          ${this.statusBadge(child.status)}
          ${actions}
        </div>
      </article>`;
  },

  pickupItem(child, index) {
    return `
      <div class="pickup-item">
        <div class="child-info">
          <div class="pickup-num" aria-hidden="true">${index + 1}</div>
          <div class="child-avatar" aria-hidden="true">${child.name.charAt(0)}</div>
          <div class="child-details">
            <h4>${child.name}</h4>
            <p class="child-meta">üìç ${child.address}</p>
          </div>
        </div>
        <div class="action-btns">
          <button class="btn btn-success btn-sm"
            onclick="App.driver.updateStatus(${child.id},'picked')"
            aria-label="Recolher ${child.name}">‚úÖ Recolher</button>
          <button class="btn btn-outline btn-sm"
            onclick="App.driver.updateStatus(${child.id},'delivered')"
            aria-label="Entregar ${child.name}">üè´ Entregar</button>
        </div>
      </div>`;
  },

  notifItem(notif) {
    const date = new Date(notif.created_at);
    const formatted = isNaN(date.getTime())
      ? notif.created_at
      : date.toLocaleString('pt-PT');
    return `
      <div class="notif-item">
        <div class="notif-time">
          <span aria-hidden="true">üïê</span> ${formatted}
        </div>
        <div class="notif-msg">${notif.message}</div>
      </div>`;
  },

  paymentRow(p) {
    const date = new Date(p.created_at);
    const formatted = isNaN(date.getTime()) ? p.created_at : date.toLocaleDateString('pt-PT');
    const isPaid = p.status === 'paid';
    return `
      <div class="payment-row">
        <div class="payment-desc">
          <h4>${p.description}</h4>
          <small>${formatted}</small>
        </div>
        <div style="text-align:right;">
          <div class="payment-amount">${p.amount} Kz</div>
          <span class="badge ${isPaid ? 'badge-paid' : 'badge-pending'}">
            ${isPaid ? '‚úÖ Pago' : '‚è≥ Pendente'}
          </span>
        </div>
      </div>`;
  },

  skeletonCards(count = 3) {
    return Array.from({length: count}, () => `
      <div class="skel-card" aria-hidden="true">
        <div class="skeleton skel-avatar"></div>
        <div style="flex:1;">
          <div class="skeleton skel-line skel-w60"></div>
          <div class="skeleton skel-line skel-w40"></div>
        </div>
        <div class="skeleton skel-badge"></div>
      </div>`).join('');
  },

  emptyState(emoji, title, desc, btnLabel = null, btnAction = null) {
    return `
      <div class="empty-state">
        <div class="empty-state-icon" aria-hidden="true">${emoji}</div>
        <h3>${title}</h3>
        <p>${desc}</p>
        ${btnLabel ? `<button class="btn btn-primary" onclick="${btnAction}">${btnLabel}</button>` : ''}
      </div>`;
  },
};

/* ================================================================
   PILAR 5 ‚Äî ROUTER (prote√ß√£o de rotas)
================================================================ */
const Router = {
  requireAuth() {
    if (!State.get('token')) {
      App.ui.showLogin();
      return false;
    }
    return true;
  }
};

/* ================================================================
   PILAR 1 ‚Äî API LAYER
================================================================ */
const API = {
  BASE: 'http://localhost:3001/api',

  async _request(endpoint, options = {}) {
    const token = State.get('token');
    const config = {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        ...(options.headers || {}),
      },
    };
    const res = await fetch(`${this.BASE}${endpoint}`, config);
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || `Erro ${res.status}`);
    }
    return res.json();
  },

  login:           (d)       => API._request('/login',                    { method: 'POST', body: JSON.stringify(d) }),
  register:        (d)       => API._request('/register',                 { method: 'POST', body: JSON.stringify(d) }),
  getUser:         ()        => API._request('/user'),
  getChildren:     ()        => API._request('/children'),
  addChild:        (d)       => API._request('/children',                 { method: 'POST', body: JSON.stringify(d) }),
  updateStatus:    (id, s)   => API._request(`/children/${id}/status`,    { method: 'PUT',  body: JSON.stringify({ status: s }) }),
  getNotifications:()        => API._request('/notifications'),
  getPayments:     ()        => API._request('/payments'),
  getDriverRoute:  ()        => API._request('/driver/route'),
};

/* ================================================================
   PILAR 4 ‚Äî MAP MODULE (Leaflet)
================================================================ */
const MapModule = {
  _map:    null,
  _marker: null,
  _route:  null,

  /* Coordenadas simuladas de Luanda (Pilar 3 ‚Äî setInterval) */
  _waypoints: [
    [-8.838, 13.234], [-8.841, 13.240], [-8.845, 13.248],
    [-8.849, 13.255], [-8.854, 13.261], [-8.857, 13.268],
    [-8.852, 13.275], [-8.847, 13.270], [-8.843, 13.262],
  ],
  _wpIndex: 0,
  _interval: null,

  init() {
    if (this._map) return; // j√° inicializado

    this._map = L.map('map', { zoomControl: true, attributionControl: true })
      .setView([-8.838, 13.234], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19,
    }).addTo(this._map);

    // √çcone personalizado de autocarro
    const busIcon = L.divIcon({
      html: '<div style="font-size:2rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));">üöå</div>',
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 20],
    });

    this._marker = L.marker(this._waypoints[0], { icon: busIcon, alt: 'Autocarro escolar' })
      .addTo(this._map)
      .bindPopup('<strong>Katutransporte</strong><br>A caminho da pr√≥xima paragem', { closeButton: false })
      .openPopup();

    // Linha da rota
    this._route = L.polyline(this._waypoints, {
      color: '#FF6B35', weight: 4, opacity: 0.6, dashArray: '8 4'
    }).addTo(this._map);

    // Adicionar marcadores de paragem
    this._waypoints.forEach((coord, i) => {
      L.circleMarker(coord, {
        radius: 6, fillColor: '#4ECDC4', color: '#fff',
        weight: 2, opacity: 1, fillOpacity: 0.9
      }).addTo(this._map).bindTooltip(`Paragem ${i + 1}`);
    });

    this._startSimulation();
  },

  _startSimulation() {
    if (this._interval) return;
    this._interval = setInterval(() => {
      this._wpIndex = (this._wpIndex + 1) % this._waypoints.length;
      const pos = this._waypoints[this._wpIndex];
      this._marker.setLatLng(pos);
      this._map.panTo(pos, { animate: true, duration: 1.2 });
      EventBus.emit('bus:moved', { position: pos, stop: this._wpIndex + 1 });
    }, 4000);
  },

  destroy() {
    clearInterval(this._interval);
    this._interval = null;
    if (this._map) { this._map.remove(); this._map = null; }
  },

  invalidateSize() {
    if (this._map) setTimeout(() => this._map.invalidateSize(), 100);
  }
};

/* ================================================================
   PILAR 3 ‚Äî SIMULA√á√ÉO REAL-TIME (notifica√ß√µes autom√°ticas)
================================================================ */
const Realtime = {
  _notifInterval: null,

  _fakeNotifs: [
    'üöå O autocarro partiu do dep√≥sito √†s 06h30.',
    'üìç O autocarro est√° a 5 minutos da sua zona.',
    '‚úÖ A crian√ßa foi recolhida com seguran√ßa.',
    'üè´ A crian√ßa chegou √† escola.',
    'üöå O autocarro iniciou a rota de regresso.',
    'üìç Regresso previsto em 20 minutos.',
    '‚úÖ A crian√ßa foi entregue em casa.',
    'üîî Servi√ßo de amanh√£ confirmado.',
  ],

  start() {
    if (this._notifInterval) return;
    let idx = 0;
    this._notifInterval = setInterval(() => {
      const msg = this._fakeNotifs[idx % this._fakeNotifs.length];
      idx++;
      const notif = {
        id: Date.now(),
        message: msg,
        created_at: new Date().toISOString(),
      };
      const notifs = [notif, ...State.get('notifications')];
      State.set('notifications', notifs.slice(0, 20));
      App.render.notifications();
      App.render.notifCount();
      Toast.show(msg, 'info');
    }, 15000); // nova notifica√ß√£o a cada 15 s
  },

  stop() {
    clearInterval(this._notifInterval);
    this._notifInterval = null;
  }
};

/* ================================================================
   TOAST SYSTEM
================================================================ */
const Toast = {
  show(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.setAttribute('role', 'status');
    el.innerHTML = `<span aria-hidden="true">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span> ${message}`;
    container.appendChild(el);
    setTimeout(() => {
      el.style.animation = 'toastOut 0.3s ease-out forwards';
      setTimeout(() => el.remove(), 300);
    }, duration);
  }
};

/* ================================================================
   MAIN APP
================================================================ */
const App = {

  /* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
  auth: {
    async login(formData) {
      App.ui.showSpinner();
      try {
        /* MOCK: quando o backend n√£o est√° dispon√≠vel, simular login */
        let user, token;
        try {
          const res = await API.login({ email: formData.email, password: formData.password });
          user  = res.user;
          token = res.token;
        } catch {
          /* MOCK FALLBACK */
          user  = { id: 1, name: 'Pai Demo', email: formData.email, role: 'parent' };
          token = 'mock-token-' + Date.now();
          State.set('children', App.auth._mockChildren());
          State.set('notifications', App.auth._mockNotifs());
          State.set('payments', App.auth._mockPayments());
        }
        State.set('token', token);
        State.set('user', user);
        App.ui.showDashboard();
        App.data.loadAll();
        Toast.show(`Bem-vindo, ${user.name}!`, 'success');
      } catch(e) {
        App.ui.showInlineAlert('loginAlert', e.message, 'error');
      } finally {
        App.ui.hideSpinner();
      }
    },

    async register(formData) {
      App.ui.showSpinner();
      try {
        try {
          await API.register(formData);
        } catch { /* mock: ignora erro de backend */ }
        App.ui.showInlineAlert('registerAlert', 'Conta criada! Fa√ßa o login.', 'success');
        setTimeout(() => App.ui.showLogin(), 2000);
      } catch(e) {
        App.ui.showInlineAlert('registerAlert', e.message, 'error');
      } finally {
        App.ui.hideSpinner();
      }
    },

    logout() {
      Realtime.stop();
      MapModule.destroy();
      State.clear();
      App.ui.showLogin();
      Toast.show('Sess√£o terminada com sucesso.', 'info');
    },

    /* Dados mock para demo */
    _mockChildren: () => [
      { id:1, name:'Ana Mbunga',    age:8,  gender:'F', school:'Col√©gio Santo Ant√≥nio', address:'Rua do Kilamba, 12', status:'transit',   medical_info:'' },
      { id:2, name:'Jo√£o Ngueve',   age:11, gender:'M', school:'Escola Prim√°ria Sol',   address:'Av. Brasil, 45',     status:'picked',    medical_info:'' },
      { id:3, name:'Sofia Loureiro',age:7,  gender:'F', school:'Col√©gio Santo Ant√≥nio', address:'Rua M√£e Isabel, 3',  status:'waiting',   medical_info:'Al√©rgica a amendoim' },
    ],
    _mockNotifs: () => [
      { id:1, message:'üöå O autocarro partiu do dep√≥sito.', created_at: new Date(Date.now()-3600000).toISOString() },
      { id:2, message:'‚úÖ Ana foi recolhida com seguran√ßa.', created_at: new Date(Date.now()-1800000).toISOString() },
    ],
    _mockPayments: () => [
      { id:1, description:'Mensalidade Mar√ßo 2025', amount:15000, status:'paid',    created_at: new Date(Date.now()-86400000*5).toISOString() },
      { id:2, description:'Mensalidade Abril 2025', amount:15000, status:'pending', created_at: new Date().toISOString() },
    ],
  },

  /* ‚îÄ‚îÄ DATA ‚îÄ‚îÄ */
  data: {
    async loadAll() {
      await Promise.allSettled([
        App.data.loadChildren(),
        App.data.loadNotifications(),
        App.data.loadPayments(),
      ]);
      const user = State.get('user');
      if (user?.role === 'driver') await App.data.loadRoute();
      App.render.all();
      Realtime.start();
    },

    async loadChildren() {
      try {
        const data = await API.getChildren();
        State.set('children', data);
      } catch { /* usa dados j√° em State */ }
    },

    async loadNotifications() {
      try {
        const data = await API.getNotifications();
        State.set('notifications', data);
      } catch { /* usa dados j√° em State */ }
    },

    async loadPayments() {
      try {
        const data = await API.getPayments();
        State.set('payments', data);
      } catch { /* usa dados j√° em State */ }
    },

    async loadRoute() {
      try {
        const data = await API.getDriverRoute();
        State.set('route', data);
      } catch {
        State.set('route', State.get('children'));
      }
    },

    async addChild(formData) {
      App.ui.showSpinner();
      try {
        try {
          const saved = await API.addChild(formData);
          const children = [...State.get('children'), saved];
          State.set('children', children);
        } catch {
          /* mock */
          const mock = { ...formData, id: Date.now(), status: 'waiting' };
          State.set('children', [...State.get('children'), mock]);
        }
        App.ui.closeChildModal();
        App.render.all();
        Toast.show(`${formData.name} adicionada com sucesso!`, 'success');
      } catch(e) {
        Toast.show(e.message, 'error');
      } finally {
        App.ui.hideSpinner();
      }
    },
  },

  /* ‚îÄ‚îÄ DRIVER ‚îÄ‚îÄ */
  driver: {
    async updateStatus(childId, newStatus) {
      try {
        try {
          await API.updateStatus(childId, newStatus);
        } catch { /* mock */ }
        const children = State.get('children').map(c =>
          c.id === childId ? { ...c, status: newStatus } : c
        );
        State.set('children', children);
        App.render.all();
        const statusLabel = { picked: 'recolhida', delivered: 'entregue', transit: 'em transporte' }[newStatus] || newStatus;
        Toast.show(`Crian√ßa marcada como ${statusLabel}.`, 'success');
      } catch(e) {
        Toast.show(e.message, 'error');
      }
    }
  },

  /* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
  render: {
    all() {
      this.overview();
      this.children();
      this.tracking();
      this.notifications();
      this.payments();
      this.route();
      this.notifCount();
    },

    overview() {
      const children = State.get('children');
      this._setText('statChildren', children.length);
      this._setText('statActive',   children.filter(c => c.status === 'transit').length);
      this._setText('statDone',     children.filter(c => c.status === 'delivered').length);

      const el = document.getElementById('recentList');
      if (!children.length) {
        el.innerHTML = Components.emptyState('üåü','Nenhuma atividade ainda',
          'Adicione uma crian√ßa para come√ßar a acompanhar as viagens.',
          '+ Adicionar Crian√ßa', "App.ui.showTab('children', document.querySelector('.nav-tab:nth-child(2)')); App.ui.openChildModal()");
        return;
      }
      el.innerHTML = children.slice(0, 3).map(c => Components.childCard(c)).join('');
    },

    children() {
      const children = State.get('children');
      const el = document.getElementById('childrenList');
      if (!children.length) {
        el.innerHTML = Components.emptyState('üë∂','Nenhuma crian√ßa registada',
          'Adicione as crian√ßas que utilizar√£o o servi√ßo de transporte escolar.',
          '+ Adicionar Primeira Crian√ßa', 'App.ui.openChildModal()');
        return;
      }
      el.innerHTML = children.map(c => Components.childCard(c)).join('');
    },

    tracking() {
      const children = State.get('children');
      const el = document.getElementById('trackingList');
      if (!children.length) {
        el.innerHTML = Components.emptyState('üìç','Nenhuma crian√ßa para rastrear','Adicione crian√ßas para ver o estado em tempo real.');
        return;
      }
      el.innerHTML = children.map(c => Components.childCard(c)).join('');
    },

    notifications() {
      const notifs = State.get('notifications');
      const el = document.getElementById('notifList');
      if (!notifs.length) {
        el.innerHTML = Components.emptyState('üîî','Sem notifica√ß√µes','Todas as notifica√ß√µes sobre as viagens aparecer√£o aqui.');
        return;
      }
      el.innerHTML = notifs.map(n => Components.notifItem(n)).join('');
    },

    payments() {
      const payments = State.get('payments');
      const el = document.getElementById('paymentList');
      if (!payments.length) {
        el.innerHTML = Components.emptyState('üí≥','Sem pagamentos','O hist√≥rico de pagamentos aparecer√° aqui.');
        return;
      }
      el.innerHTML = payments.map(p => Components.paymentRow(p)).join('');
    },

    route() {
      const route = State.get('route');
      const el = document.getElementById('routeList');
      if (!route.length) {
        el.innerHTML = Components.emptyState('üó∫Ô∏è','Sem rota hoje','A sua rota atribu√≠da aparecer√° aqui.');
        return;
      }
      el.innerHTML = route.map((c, i) => Components.pickupItem(c, i)).join('');
    },

    notifCount() {
      const count = State.get('notifications').length;
      const el = document.getElementById('notifCount');
      if (el) el.textContent = `${count} mensage${count !== 1 ? 'ns' : 'm'}`;
    },

    _setText(id, val) {
      const el = document.getElementById(id);
      if (el) el.textContent = val;
    },
  },

  /* ‚îÄ‚îÄ UI ‚îÄ‚îÄ */
  ui: {
    showLogin() {
      this._show('loginScreen');
      this._hide('registerScreen');
      this._hide('dashboard');
      document.getElementById('navMenu').innerHTML = `
        <button class="btn btn-outline" onclick="App.ui.showLogin()">Entrar</button>
        <button class="btn btn-primary" onclick="App.ui.showRegister()">Registar</button>`;
    },

    showRegister() {
      this._hide('loginScreen');
      this._show('registerScreen');
      this._hide('dashboard');
    },

    showDashboard() {
      this._hide('loginScreen');
      this._hide('registerScreen');

      const dash = document.getElementById('dashboard');
      dash.classList.add('active');

      const user = State.get('user');
      document.getElementById('userName').textContent        = user?.name || 'Utilizador';
      document.getElementById('userRoleBadge').textContent   = this._roleLabel(user?.role);

      /* Mostrar abas espec√≠ficas por role */
      if (user?.role === 'driver') document.getElementById('routesTab').classList.remove('hidden');
      if (user?.role === 'admin')  document.getElementById('adminTab').classList.remove('hidden');

      document.getElementById('navMenu').innerHTML = `
        <span style="color:var(--muted);font-size:0.85rem;">Ol√°, ${user?.name?.split(' ')[0]}!</span>
        <button class="btn btn-outline" onclick="App.auth.logout()">üö™ Sair</button>`;

      /* Inicializar mapa (Leaflet) */
      setTimeout(() => { MapModule.init(); }, 300);
    },

    showTab(name, tabEl) {
      document.querySelectorAll('.section').forEach(s => {
        s.classList.remove('active');
        s.setAttribute('aria-hidden', 'true');
      });
      document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });

      const section = document.getElementById(name + 'Section');
      if (section) { section.classList.add('active'); section.setAttribute('aria-hidden', 'false'); }

      const btn = tabEl || document.querySelector(`.nav-tab[aria-controls="${name}Section"]`);
      if (btn) { btn.classList.add('active'); btn.setAttribute('aria-selected', 'true'); }

      if (name === 'tracking') MapModule.invalidateSize();
    },

    openChildModal() {
      const modal = document.getElementById('childModal');
      modal.classList.add('active');
      document.getElementById('childForm').reset();
      document.querySelectorAll('#childForm .field-error').forEach(e => e.textContent = '');
      document.querySelectorAll('#childForm .form-control').forEach(i => {
        i.classList.remove('is-invalid','is-valid');
      });
      Validators.attachLiveValidation(document.getElementById('childForm'));
      document.getElementById('cName').focus();
    },

    closeChildModal() {
      document.getElementById('childModal').classList.remove('active');
    },

    showSpinner() { document.getElementById('spinner').classList.add('active'); },
    hideSpinner() { document.getElementById('spinner').classList.remove('active'); },

    showInlineAlert(elId, message, type) {
      const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è' };
      const el = document.getElementById(elId);
      if (!el) return;
      el.innerHTML = `<div class="alert alert-${type}">${icons[type]} ${message}</div>`;
      setTimeout(() => { el.innerHTML = ''; }, 6000);
    },

    _roleLabel(role) {
      return { parent:'Pai / Respons√°vel', driver:'Motorista', admin:'Administrador' }[role] || role;
    },

    _show(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
    },
    _hide(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    },
  },
};

/* ================================================================
   FORM EVENT LISTENERS
================================================================ */
document.addEventListener('DOMContentLoaded', () => {

  /* Carregar estado persistido */
  State.load();

  /* Attach live validation */
  Validators.attachLiveValidation(document.getElementById('loginForm'));
  Validators.attachLiveValidation(document.getElementById('registerForm'));

  /* LOGIN FORM */
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!Validators.validateForm(e.target)) return;
    const fd = new FormData(e.target);
    await App.auth.login({ email: fd.get('email'), password: fd.get('password') });
  });

  /* REGISTER FORM */
  document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!Validators.validateForm(e.target)) return;
    const fd = new FormData(e.target);
    await App.auth.register({
      name:     fd.get('name'),
      email:    fd.get('email'),
      phone:    fd.get('phone'),
      password: fd.get('password'),
      role:     fd.get('role'),
    });
  });

  /* ADD CHILD FORM */
  document.getElementById('childForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!Validators.validateForm(e.target)) return;
    const fd = new FormData(e.target);
    await App.data.addChild({
      name:              fd.get('name'),
      age:               Number(fd.get('age')),
      gender:            fd.get('gender'),
      school:            fd.get('school'),
      address:           fd.get('address'),
      emergency_contact: fd.get('emergency_contact'),
      medical_info:      fd.get('medical_info') || '',
      status:            'waiting',
    });
  });

  /* Fechar modal ao clicar fora */
  document.getElementById('childModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) App.ui.closeChildModal();
  });

  /* Fechar modal com ESC */
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') App.ui.closeChildModal();
  });

  /* PILAR 5 ‚Äî Prote√ß√£o de rota: verificar sess√£o existente */
  const token = State.get('token');
  const user  = State.get('user');

  if (token && user) {
    App.ui.showDashboard();
    App.data.loadAll();
  } else {
    App.ui.showLogin();
  }

  /* Escuta eventos do mapa para atualizar badge */
  EventBus.on('bus:moved', ({ stop }) => {
    const badge = document.getElementById('busStatusBadge');
    if (badge) badge.textContent = `üü¢ Paragem ${stop}`;
  });
});
</script>
</body>
</html>
