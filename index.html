<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Katutransporte</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --navy:#0B2447;--navy2:#19376D;--blue:#1565C0;--blue-l:#1E88E5;
  --orange:#F4511E;--orange-l:#FF7043;--orange-pale:#FFF3EF;
  --teal:#00796B;--teal-l:#26A69A;--teal-pale:#E0F2F1;
  --violet:#5C35CC;--violet-l:#7E57C2;--violet-pale:#EDE7F6;
  --amber:#E65100;--green:#2E7D32;--green-l:#43A047;
  --red:#C62828;--white:#fff;
  --bg:#F4F6FB;--surface:#fff;--surface2:#F8FAFF;
  --border:#E3E8F4;--border2:#EEF2FA;
  --txt:#0B1929;--muted:#607590;--light:#95A8BE;
  --sh0:0 1px 4px rgba(11,36,71,.08);
  --sh1:0 4px 16px rgba(11,36,71,.11);
  --sh2:0 12px 40px rgba(11,36,71,.16);
  --sh3:0 24px 64px rgba(11,36,71,.2);
  --r:10px;--rm:14px;--rl:20px;
  --ease:cubic-bezier(.4,0,.2,1);
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden;font-size:14px;line-height:1.5}
h1,h2,h3,h4,h5{font-family:'Syne',sans-serif;line-height:1.2}
input,select,textarea,button{font-family:inherit}
:focus-visible{outline:2px solid var(--blue-l);outline-offset:2px;border-radius:4px}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap}
.hidden{display:none!important}

/* ═══════════ AUTH ═══════════ */
.auth-screen{min-height:100vh;display:none;flex-direction:column;position:relative;overflow:hidden;background:var(--navy)}
.auth-screen.active{display:flex}

/* Animated gradient sky */
.auth-sky{position:absolute;inset:0;background:linear-gradient(160deg,#0B2447 0%,#19376D 35%,#0277BD 65%,#00838F 100%);animation:skyAnim 14s ease-in-out infinite alternate;z-index:0}
@keyframes skyAnim{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(20deg)}}

/* Stars */
.auth-stars{position:absolute;inset:0;z-index:1;pointer-events:none}
.star{position:absolute;background:#fff;border-radius:50%;animation:twinkle ease-in-out infinite}
@keyframes twinkle{0%,100%{opacity:.2;transform:scale(1)}50%{opacity:.9;transform:scale(1.4)}}

/* Sun/circle accent */
.auth-sun{position:absolute;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(255,152,0,.25) 0%,rgba(244,81,30,.1) 50%,transparent 70%);top:-180px;right:-100px;z-index:1;animation:sunPulse 6s ease-in-out infinite}
@keyframes sunPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}

/* Road strip at bottom */
.auth-road{position:absolute;bottom:0;left:0;right:0;height:220px;z-index:2;pointer-events:none}

/* Auth card floating */
.auth-card-wrap{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:1.5rem}
.auth-card{background:rgba(255,255,255,.97);border-radius:24px;width:100%;max-width:420px;box-shadow:var(--sh3);overflow:hidden;animation:cardRise .6s var(--ease)}
@keyframes cardRise{from{opacity:0;transform:translateY(32px) scale(.97)}to{opacity:1;transform:none}}

/* Card top illustration strip */
.auth-card-banner{height:130px;position:relative;overflow:hidden;background:linear-gradient(135deg,var(--navy),var(--blue))}
.auth-card-banner-pattern{position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.08) 1.5px,transparent 1.5px);background-size:22px 22px}
.auth-card-bus-scene{position:absolute;bottom:0;left:0;right:0;display:flex;align-items:flex-end;justify-content:center;padding-bottom:4px}
.auth-card-title-bar{position:absolute;top:0;left:0;right:0;padding:1rem 1.5rem;display:flex;align-items:center;gap:.75rem}
.auth-logo-badge{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--orange),var(--orange-l));display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(244,81,30,.45);flex-shrink:0}
.auth-logo-text{color:#fff}
.auth-logo-text h1{font-size:1.1rem;font-weight:800;line-height:1}
.auth-logo-text small{font-size:.62rem;opacity:.65;letter-spacing:.08em;text-transform:uppercase}

.auth-card-body{padding:1.6rem 1.8rem}
.auth-tabs{display:flex;background:var(--bg);border-radius:var(--r);padding:3px;margin-bottom:1.4rem}
.auth-tab-btn{flex:1;padding:.55rem;border:none;background:transparent;border-radius:8px;font-size:.83rem;font-weight:700;cursor:pointer;transition:all .2s;color:var(--muted);font-family:inherit}
.auth-tab-btn.active{background:#fff;color:var(--navy);box-shadow:var(--sh0)}
.auth-form-pane{display:none}.auth-form-pane.active{display:block}

.form-group{margin-bottom:.85rem}
.form-label{display:block;font-size:.74rem;font-weight:700;color:var(--txt);margin-bottom:.3rem;letter-spacing:.03em;text-transform:uppercase}
.form-input{width:100%;padding:.68rem 1rem;border:1.5px solid var(--border);border-radius:var(--r);font-size:.88rem;background:var(--surface);color:var(--txt);transition:all .2s;font-family:inherit}
.form-input:focus{outline:none;border-color:var(--blue-l);box-shadow:0 0 0 3px rgba(30,136,229,.12);background:#fff}
.form-input.invalid{border-color:var(--red);background:#FFF5F5}
.form-input.valid{border-color:var(--green)}
.field-err{font-size:.71rem;color:var(--red);margin-top:.22rem;display:block;min-height:14px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
select.form-input{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='%23607590' d='M5 6L0 0h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .9rem center;appearance:none}
textarea.form-input{resize:vertical;min-height:75px}

.btn{padding:.68rem 1.3rem;border:none;border-radius:var(--r);font-family:inherit;font-size:.86rem;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.45rem;position:relative;overflow:hidden;letter-spacing:.01em}
.btn:active:not(:disabled){transform:scale(.97)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--navy),var(--blue-l));color:#fff;box-shadow:0 4px 16px rgba(21,101,192,.35)}
.btn-primary:hover:not(:disabled){box-shadow:0 6px 22px rgba(21,101,192,.45);transform:translateY(-1px)}
.btn-orange{background:linear-gradient(135deg,var(--orange),var(--orange-l));color:#fff;box-shadow:0 4px 16px rgba(244,81,30,.35)}
.btn-orange:hover:not(:disabled){box-shadow:0 6px 22px rgba(244,81,30,.45);transform:translateY(-1px)}
.btn-teal{background:linear-gradient(135deg,var(--teal),var(--teal-l));color:#fff}
.btn-teal:hover:not(:disabled){transform:translateY(-1px)}
.btn-outline{background:transparent;color:var(--navy);border:1.5px solid var(--border)}
.btn-outline:hover:not(:disabled){border-color:var(--blue-l);background:rgba(30,136,229,.05)}
.btn-ghost{background:transparent;color:var(--muted);border:none}
.btn-ghost:hover:not(:disabled){background:var(--bg);color:var(--txt)}
.btn-sm{padding:.38rem .8rem;font-size:.76rem}
.btn-lg{padding:.88rem 1.8rem;font-size:.94rem}
.btn-block{width:100%;justify-content:center}
.icon-btn{padding:.46rem;border-radius:var(--r);background:var(--surface2);border:1px solid var(--border2);cursor:pointer;color:var(--muted);transition:all .2s;display:inline-flex;align-items:center}
.icon-btn:hover{background:var(--bg);color:var(--txt)}

.alert-box{padding:.72rem 1rem;border-radius:var(--r);margin-bottom:.85rem;border-left:3px solid;font-size:.8rem;font-weight:600;display:flex;align-items:center;gap:.5rem;animation:fadeUp .25s ease}
.alert-box.success{background:#F1FBF4;color:#1B5E20;border-color:var(--green)}
.alert-box.error{background:#FFF3F3;color:#B71C1C;border-color:var(--red)}
.alert-box.info{background:#E3F2FD;color:#0D47A1;border-color:var(--blue-l)}
@keyframes fadeUp{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:none}}

/* ═══════════ APP SHELL ═══════════ */
.app{display:none;min-height:100vh}
.app.active{display:flex}

/* Sidebar */
.sidebar{width:260px;background:linear-gradient(180deg,var(--navy) 0%,#0D1F3C 100%);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:300;transition:transform .3s var(--ease)}
.sidebar-logo-area{padding:1.3rem 1.4rem 1rem;border-bottom:1px solid rgba(255,255,255,.08);flex-shrink:0}
.sidebar-logo-row{display:flex;align-items:center;gap:.75rem}
.s-logo-badge{width:40px;height:40px;border-radius:11px;background:linear-gradient(135deg,var(--orange),var(--orange-l));display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(244,81,30,.4);flex-shrink:0}
.s-logo-text h2{font-size:1.05rem;color:#fff;font-weight:800;line-height:1}
.s-logo-text span{font-size:.62rem;color:rgba(255,255,255,.4);letter-spacing:.1em;text-transform:uppercase}

/* Sidebar illustration */
.sidebar-illo{margin:.9rem 1.2rem;border-radius:var(--rm);overflow:hidden;height:110px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);position:relative;flex-shrink:0}

.sidebar-nav{flex:1;overflow-y:auto;padding:.5rem 0;scrollbar-width:none}
.sidebar-nav::-webkit-scrollbar{display:none}
.nav-group-label{font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:rgba(255,255,255,.28);padding:.8rem 1.4rem .2rem;font-family:'Syne',sans-serif;font-weight:800}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.64rem 1.4rem;color:rgba(255,255,255,.58);cursor:pointer;transition:all .2s;font-size:.83rem;font-weight:600;border-left:3px solid transparent;user-select:none}
.nav-item:hover{color:#fff;background:rgba(255,255,255,.07)}
.nav-item.active{color:#fff;background:linear-gradient(90deg,rgba(244,81,30,.22),rgba(244,81,30,.05));border-left-color:var(--orange)}
.nav-item.active .nav-ico-wrap{background:var(--orange);box-shadow:0 3px 10px rgba(244,81,30,.4)}
.nav-ico-wrap{width:30px;height:30px;border-radius:8px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.nav-badge{margin-left:auto;background:var(--orange);color:#fff;font-size:.62rem;padding:.1rem .42rem;border-radius:50px;font-weight:800;min-width:18px;text-align:center}

.sidebar-user-area{padding:.9rem 1.2rem;border-top:1px solid rgba(255,255,255,.08);flex-shrink:0}
.sidebar-user-card{display:flex;align-items:center;gap:.65rem;background:rgba(255,255,255,.07);border-radius:var(--rm);padding:.65rem .85rem}
.s-user-av{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--orange),var(--violet-l));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.88rem;flex-shrink:0;border:2px solid rgba(255,255,255,.18)}
.s-user-name{font-size:.82rem;color:#fff;font-weight:700;line-height:1.2}
.s-user-role{font-size:.66rem;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.06em}
.s-logout-btn{margin-left:auto;background:rgba(255,255,255,.08);border:none;color:rgba(255,255,255,.45);cursor:pointer;padding:.35rem;border-radius:7px;transition:all .2s;display:flex;align-items:center}
.s-logout-btn:hover{background:rgba(198,40,40,.35);color:#fff}

/* Main */
.main-wrap{margin-left:260px;flex:1;display:flex;flex-direction:column;min-height:100vh;transition:margin .3s var(--ease)}
.topbar{height:58px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 1.8rem;position:sticky;top:0;z-index:100;box-shadow:var(--sh0);flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:.8rem}
.hamburger{display:none;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--r);padding:.45rem;cursor:pointer;color:var(--muted);transition:all .2s;align-items:center}
.hamburger:hover{background:var(--bg);color:var(--txt)}
.topbar-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;color:var(--txt)}
.topbar-right{display:flex;align-items:center;gap:.55rem}
.notif-trigger{position:relative;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--r);padding:.45rem;cursor:pointer;color:var(--muted);transition:all .2s;display:flex;align-items:center}
.notif-trigger:hover{border-color:var(--blue-l);color:var(--navy);background:#EEF5FF}
.notif-pip{position:absolute;top:-3px;right:-3px;width:16px;height:16px;background:var(--orange);border-radius:50%;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-size:.52rem;font-weight:800;color:#fff}
.user-pill{display:flex;align-items:center;gap:.5rem;background:var(--surface2);border:1px solid var(--border2);border-radius:50px;padding:.28rem .8rem .28rem .32rem}
.user-pill-av{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--blue-l));color:#fff;font-size:.72rem;font-weight:800;display:flex;align-items:center;justify-content:center}
.user-pill-name{font-size:.78rem;font-weight:700;color:var(--txt)}

.page-body{padding:1.6rem 2rem;flex:1}

/* Sidebar overlay for mobile */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(11,36,71,.55);z-index:299;backdrop-filter:blur(3px)}
.sidebar-overlay.active{display:block}

/* ═══════════ SECTION HERO STRIPS ═══════════ */
.page-hero{border-radius:var(--rl);margin-bottom:1.4rem;padding:1.5rem 1.8rem;position:relative;overflow:hidden;color:#fff;display:flex;justify-content:space-between;align-items:center;gap:1rem}
.page-hero-bg{position:absolute;inset:0;z-index:0}
.page-hero-dots{position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.09) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1}
.page-hero-content{position:relative;z-index:2}
.page-hero h2{font-size:1.35rem;font-weight:800;margin-bottom:.25rem}
.page-hero p{font-size:.82rem;opacity:.8;max-width:320px;line-height:1.6}
.page-hero-illo{position:relative;z-index:2;flex-shrink:0}

/* ═══════════ STATS ═══════════ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:1rem;margin-bottom:1.4rem}
.stat-card{background:#fff;border-radius:var(--rm);padding:1.2rem 1.3rem;border:1px solid var(--border2);box-shadow:var(--sh0);position:relative;overflow:hidden;transition:all .2s;cursor:default}
.stat-card:hover{transform:translateY(-3px);box-shadow:var(--sh1)}
.stat-card-glow{position:absolute;top:-30px;right:-30px;width:100px;height:100px;border-radius:50%;filter:blur(35px);opacity:.55;z-index:0;pointer-events:none}
.stat-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.7rem;position:relative;z-index:1}
.stat-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:700}
.stat-ico{width:36px;height:36px;border-radius:var(--r);display:flex;align-items:center;justify-content:center}
.stat-val{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;color:var(--txt);line-height:1;position:relative;z-index:1}
.stat-sub{font-size:.72rem;color:var(--light);margin-top:.3rem;position:relative;z-index:1}

/* ═══════════ PANELS ═══════════ */
.panel{background:#fff;border-radius:var(--rm);border:1px solid var(--border2);box-shadow:var(--sh0);margin-bottom:1.2rem;overflow:hidden}
.panel-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.4rem;border-bottom:1px solid var(--border2)}
.panel-head h3{font-size:.92rem;color:var(--txt);font-family:'Syne',sans-serif;font-weight:800}
.panel-body{padding:1.4rem}
.panel-body.np{padding:0}
.panel-accl{border-left:4px solid var(--orange)}
.panel-acct{border-left:4px solid var(--teal)}
.panel-accv{border-left:4px solid var(--violet)}
.panel-accb{border-left:4px solid var(--blue-l)}

/* ═══════════ LIST ITEMS ═══════════ */
.list-item{display:flex;align-items:center;gap:.85rem;padding:.9rem 1.4rem;border-bottom:1px solid var(--border2);transition:background .15s}
.list-item:last-child{border-bottom:none}
.list-item:hover{background:var(--surface2)}
.li-av{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.92rem;flex-shrink:0;border:2.5px solid rgba(255,255,255,.8)}
.li-info{flex:1;min-width:0}
.li-name{font-size:.88rem;font-weight:700;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-meta{font-size:.73rem;color:var(--muted);margin-top:.1rem}
.li-actions{display:flex;align-items:center;gap:.4rem;flex-shrink:0}

/* ═══════════ BADGES ═══════════ */
.badge{padding:.22rem .65rem;border-radius:5px;font-size:.68rem;font-weight:800;letter-spacing:.04em;text-transform:uppercase;white-space:nowrap;display:inline-block}
.b-waiting{background:#FFF8E1;color:#E65100;border:1px solid #FFCC02}
.b-picked{background:#E8F5E9;color:#1B5E20;border:1px solid #A5D6A7}
.b-transit{background:#E3F2FD;color:#0D47A1;border:1px solid #90CAF9}
.b-delivered{background:#E8F5E9;color:#1B5E20;border:1px solid #A5D6A7}
.b-paid{background:#E8F5E9;color:#1B5E20;border:1px solid #A5D6A7}
.b-pending{background:#FFEBEE;color:#B71C1C;border:1px solid #FFCDD2}
.b-info{background:#E3F2FD;color:#0D47A1;border:1px solid #90CAF9}
.b-violet{background:#EDE7F6;color:#4527A0;border:1px solid #CE93D8}
.b-teal{background:#E0F2F1;color:#004D40;border:1px solid #80CBC4}
.b-navy{background:var(--navy);color:#fff}

/* Status dot */
.sd{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:.35rem;flex-shrink:0}
.sd-g{background:#4CAF50;box-shadow:0 0 0 3px rgba(76,175,80,.2)}
.sd-a{background:#FF9800;box-shadow:0 0 0 3px rgba(255,152,0,.2)}
.sd-b{background:#2196F3;box-shadow:0 0 0 3px rgba(33,150,243,.2)}

/* ═══════════ MAP ═══════════ */
#map{height:340px;border-radius:var(--rm);overflow:hidden;z-index:1}
.map-legend{display:flex;gap:1.1rem;margin-top:.65rem;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:.4rem;font-size:.73rem;color:var(--muted);font-weight:600}
.legend-dot{width:10px;height:10px;border-radius:50%}

/* ═══════════ MODAL ═══════════ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(11,36,71,.55);z-index:1000;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px)}
.modal-ov.active{display:flex}
.modal-box{background:#fff;border-radius:var(--rl);width:100%;max-width:580px;max-height:92vh;overflow-y:auto;box-shadow:var(--sh3);animation:modalPop .22s cubic-bezier(.34,1.56,.64,1)}
@keyframes modalPop{from{transform:scale(.88);opacity:0}to{transform:scale(1);opacity:1}}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:1.2rem 1.5rem;border-bottom:1px solid var(--border)}
.modal-head h3{font-size:1rem;font-family:'Syne',sans-serif;font-weight:800}
.modal-body{padding:1.5rem}
.modal-foot{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:.6rem;background:var(--surface2);border-radius:0 0 var(--rl) var(--rl)}
.modal-close-btn{background:var(--surface2);border:1px solid var(--border);cursor:pointer;color:var(--muted);font-size:1.2rem;line-height:1;padding:.35rem .5rem;transition:all .2s;border-radius:var(--r);display:flex;align-items:center}
.modal-close-btn:hover{background:var(--red);border-color:var(--red);color:#fff}

/* ═══════════ NOTIF DRAWER ═══════════ */
.notif-drawer{position:fixed;top:58px;right:0;width:340px;height:calc(100vh - 58px);background:#fff;border-left:1px solid var(--border);z-index:200;transform:translateX(100%);transition:transform .3s var(--ease);display:flex;flex-direction:column;box-shadow:-6px 0 30px rgba(11,36,71,.12)}
.notif-drawer.open{transform:none}
.notif-drawer-head{padding:1rem 1.3rem;border-bottom:1px solid var(--border);background:linear-gradient(135deg,var(--navy),var(--navy2));display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.notif-drawer-head h3{font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;color:#fff}
.notif-scroll{overflow-y:auto;flex:1}
.notif-item{padding:.9rem 1.3rem;border-bottom:1px solid var(--border2);transition:background .15s;display:flex;align-items:flex-start;gap:.7rem}
.notif-item:hover{background:var(--surface2)}
.notif-item.unread{background:linear-gradient(90deg,#FFF8F5,#fff);border-left:3px solid var(--orange)}
.notif-ico-wrap{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:.1rem}
.notif-text{}
.notif-time{font-size:.68rem;color:var(--light);margin-bottom:.2rem}
.notif-msg{font-size:.8rem;color:var(--txt);line-height:1.5;font-weight:600}

/* ═══════════ DRIVER QUEUE ═══════════ */
.queue-item{border:1px solid var(--border2);border-radius:var(--rm);padding:1rem 1.2rem;margin-bottom:.7rem;background:#fff;transition:all .2s;position:relative;overflow:hidden}
.queue-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--orange);border-radius:0}
.queue-item:hover{box-shadow:var(--sh1);transform:translateX(2px)}
.queue-item.done{opacity:.6}
.queue-item.done::before{background:var(--green)}
.queue-num{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--blue-l));color:#fff;font-weight:800;font-size:.82rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(21,101,192,.3)}

/* ═══════════ PAYMENT CARDS ═══════════ */
.pay-card{border:1px solid var(--border2);border-radius:var(--rm);padding:1rem 1.3rem;margin-bottom:.7rem;display:flex;justify-content:space-between;align-items:center;background:#fff;transition:all .2s}
.pay-card:hover{box-shadow:var(--sh1)}
.pay-desc h4{font-size:.87rem;font-weight:700;margin-bottom:.15rem}
.pay-desc p{font-size:.73rem;color:var(--muted)}
.pay-val{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;text-align:right}

/* Finance summary */
.finance-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:.9rem;margin-bottom:1.3rem}
.fin-card{padding:1.1rem 1.3rem;border-radius:var(--rm);border:1px solid var(--border2);background:#fff;position:relative;overflow:hidden}
.fin-card-bar{position:absolute;top:0;left:0;right:0;height:4px}
.fin-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:700;margin-bottom:.6rem}
.fin-amount{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:800}

/* Progress bar */
.prog-bar{height:7px;background:var(--border);border-radius:50px;overflow:hidden;margin:.4rem 0}
.prog-fill{height:100%;border-radius:50px;transition:width 1s ease}
.pf-blue{background:linear-gradient(90deg,var(--blue),var(--blue-l))}
.pf-orange{background:linear-gradient(90deg,var(--orange),var(--orange-l))}
.pf-teal{background:linear-gradient(90deg,var(--teal),var(--teal-l))}
.pf-green{background:linear-gradient(90deg,var(--green),var(--green-l))}

/* QR cards */
.qr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:1rem}
.qr-card{border:1px solid var(--border2);border-radius:var(--rm);padding:1.2rem;text-align:center;background:#fff;transition:all .2s}
.qr-card:hover{box-shadow:var(--sh1)}
.qr-vis{width:110px;height:110px;margin:.8rem auto;border-radius:var(--r);display:flex;align-items:center;justify-content:center;border:2px dashed var(--border);background:var(--surface2);flex-direction:column;gap:.2rem}

/* Spinner */
.spin-ov{display:none;position:fixed;inset:0;background:rgba(255,255,255,.88);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.spin-ov.active{display:flex}
.spinner{width:44px;height:44px;border:3.5px solid var(--border);border-top-color:var(--blue-l);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toasts */
#toasts{position:fixed;bottom:1.3rem;right:1.3rem;z-index:3000;display:flex;flex-direction:column;gap:.4rem}
.toast{padding:.7rem 1.1rem;border-radius:var(--rm);font-size:.8rem;font-weight:700;box-shadow:var(--sh1);min-width:240px;max-width:340px;animation:toastIn .25s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;gap:.55rem;border:1px solid}
@keyframes toastIn{from{opacity:0;transform:translateX(30px) scale(.9)}to{opacity:1;transform:none}}
@keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateX(30px)}}
.toast.success{background:#F1FBF4;color:#1B5E20;border-color:#A5D6A7}
.toast.error{background:#FFF3F3;color:#B71C1C;border-color:#FFCDD2}
.toast.info{background:#E3F2FD;color:#0D47A1;border-color:#90CAF9}

/* Layout utils */
.section{display:none}.section.active{display:block}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem}
.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-s{gap:.5rem}.gap-m{gap:.9rem}.flex-1{flex:1}
.mt-s{margin-top:.5rem}.mt-m{margin-top:1rem}.mt-l{margin-top:1.5rem}
.mb-s{margin-bottom:.5rem}.mb-m{margin-bottom:1rem}
.text-r{text-align:right}.text-c{text-align:center}
.text-muted{color:var(--muted)}.text-sm{font-size:.76rem}
.sec-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:800;margin-bottom:.75rem;font-family:'Syne',sans-serif}
.divider{border:none;border-top:1px solid var(--border);margin:1rem 0}
.chip{display:inline-flex;align-items:center;gap:.35rem;background:var(--surface2);border:1px solid var(--border2);border-radius:50px;padding:.22rem .7rem;font-size:.72rem;font-weight:700;color:var(--muted)}

/* Empty state */
.empty-state{text-align:center;padding:2.8rem 1.5rem}
.empty-illo{margin:0 auto .9rem}
.empty-state h4{font-size:.95rem;color:var(--txt);margin-bottom:.35rem;font-family:'Syne',sans-serif;font-weight:800}
.empty-state p{font-size:.8rem;color:var(--muted);max-width:250px;margin:0 auto .9rem;line-height:1.6}

/* ═══════════ RESPONSIVE ═══════════ */
@media(max-width:900px){
  .sidebar{transform:translateX(-260px)}
  .sidebar.mobile-open{transform:none}
  .main-wrap{margin-left:0}
  .hamburger{display:flex}
  .two-col{grid-template-columns:1fr}
  .notif-drawer{width:100%;top:58px}
  #map{height:260px}
  .page-hero-illo{display:none}
}
@media(max-width:600px){
  .page-body{padding:1rem}
  .topbar{padding:0 1rem}
  .stats-grid{grid-template-columns:1fr 1fr}
  .auth-card-body{padding:1.2rem 1.4rem}
  .form-row{grid-template-columns:1fr}
  .finance-row{grid-template-columns:1fr 1fr}
  .qr-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
}
@media(max-width:380px){
  .stats-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- ╔═══════════════════════════════════════╗
     ║            AUTH SCREEN               ║
     ╚═══════════════════════════════════════╝ -->
<div id="authScreen" class="auth-screen active">
  <div class="auth-sky"></div>
  <div class="auth-sun"></div>
  <div class="auth-stars" id="authStars"></div>

  <!-- Animated road scene at bottom -->
  <div class="auth-road">
    <svg viewBox="0 0 1200 220" preserveAspectRatio="xMidYMax meet" style="position:absolute;bottom:0;left:0;width:100%;height:220px">
      <!-- Road surface -->
      <rect y="120" width="1200" height="100" fill="#1A2332"/>
      <rect y="116" width="1200" height="8" fill="#2C3E50"/>
      <!-- Road markings -->
      <rect x="50" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <rect x="200" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <rect x="350" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <rect x="500" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <rect x="650" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <rect x="800" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <rect x="950" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <rect x="1100" y="158" width="80" height="6" rx="3" fill="rgba(255,255,255,.25)"/>
      <!-- Sidewalk -->
      <rect y="108" width="1200" height="12" fill="#37474F"/>
      <!-- Trees -->
      <rect x="30" y="60" width="8" height="50" fill="#4E342E"/>
      <ellipse cx="34" cy="55" rx="20" ry="24" fill="#388E3C"/>
      <rect x="120" y="75" width="7" height="35" fill="#4E342E"/>
      <ellipse cx="123" cy="70" rx="16" ry="18" fill="#2E7D32"/>
      <rect x="220" y="65" width="8" height="45" fill="#4E342E"/>
      <ellipse cx="224" cy="60" rx="19" ry="22" fill="#43A047"/>
      <rect x="330" y="72" width="7" height="38" fill="#4E342E"/>
      <ellipse cx="333" cy="67" rx="17" ry="19" fill="#388E3C"/>
      <rect x="900" y="62" width="8" height="48" fill="#4E342E"/>
      <ellipse cx="904" cy="57" rx="21" ry="23" fill="#2E7D32"/>
      <rect x="1020" y="70" width="7" height="40" fill="#4E342E"/>
      <ellipse cx="1023" cy="65" rx="17" ry="20" fill="#43A047"/>
      <rect x="1140" y="64" width="8" height="46" fill="#4E342E"/>
      <ellipse cx="1144" cy="59" rx="20" ry="22" fill="#388E3C"/>
      <!-- Buildings bg -->
      <rect x="460" y="20" width="60" height="100" fill="#263238" rx="2"/>
      <rect x="470" y="30" width="10" height="10" fill="#90CAF9" rx="1"/>
      <rect x="490" y="30" width="10" height="10" fill="#90CAF9" rx="1"/>
      <rect x="470" y="50" width="10" height="10" fill="#80DEEA" rx="1"/>
      <rect x="490" y="50" width="10" height="10" fill="rgba(255,255,255,.15)" rx="1"/>
      <rect x="470" y="70" width="10" height="10" fill="#90CAF9" rx="1"/>
      <rect x="490" y="70" width="10" height="10" fill="#80DEEA" rx="1"/>
      <rect x="470" y="90" width="30" height="30" fill="#1A237E" rx="1"/>
      <rect x="540" y="40" width="50" height="80" fill="#1C313A" rx="2"/>
      <rect x="549" y="50" width="9" height="9" fill="#FFE082" rx="1"/>
      <rect x="566" y="50" width="9" height="9" fill="#90CAF9" rx="1"/>
      <rect x="549" y="67" width="9" height="9" fill="#80DEEA" rx="1"/>
      <rect x="566" y="67" width="9" height="9" fill="#FFE082" rx="1"/>
      <rect x="549" y="84" width="9" height="9" fill="#90CAF9" rx="1"/>
      <rect x="566" y="84" width="9" height="9" fill="#80DEEA" rx="1"/>
      <rect x="600" y="55" width="40" height="65" fill="#263238" rx="2"/>
      <rect x="608" y="63" width="8" height="8" fill="#90CAF9" rx="1"/>
      <rect x="623" y="63" width="8" height="8" fill="#FFE082" rx="1"/>
      <rect x="608" y="78" width="8" height="8" fill="#80DEEA" rx="1"/>
      <rect x="623" y="78" width="8" height="8" fill="#90CAF9" rx="1"/>
      <rect x="608" y="93" width="8" height="8" fill="#FFE082" rx="1"/>
      <rect x="623" y="93" width="8" height="8" fill="#80DEEA" rx="1"/>
      <!-- School building -->
      <rect x="680" y="38" width="90" height="82" fill="#1565C0" rx="3"/>
      <rect x="690" y="28" width="70" height="14" fill="#0D47A1" rx="2"/>
      <!-- Flag -->
      <rect x="722" y="4" width="3" height="26" fill="#F5F5F5"/>
      <rect x="725" y="4" width="18" height="12" fill="#F4511E"/>
      <!-- School windows -->
      <rect x="692" y="48" width="14" height="14" fill="#90CAF9" rx="1"/>
      <rect x="714" y="48" width="14" height="14" fill="#E3F2FD" rx="1"/>
      <rect x="736" y="48" width="14" height="14" fill="#90CAF9" rx="1"/>
      <rect x="758" y="48" width="14" height="14" fill="#E3F2FD" rx="1"/>
      <rect x="692" y="70" width="14" height="14" fill="#E3F2FD" rx="1"/>
      <rect x="714" y="70" width="14" height="14" fill="#90CAF9" rx="1"/>
      <rect x="736" y="70" width="14" height="14" fill="#E3F2FD" rx="1"/>
      <rect x="758" y="70" width="14" height="14" fill="#90CAF9" rx="1"/>
      <!-- School door -->
      <rect x="718" y="90" width="20" height="30" fill="#0D47A1" rx="1"/>
      <!-- Bus animated -->
      <g id="animBus" style="animation:busMove 12s linear infinite">
        <!-- Bus body -->
        <rect x="50" y="78" width="100" height="44" rx="6" fill="#F4511E"/>
        <rect x="52" y="80" width="96" height="8" fill="#FF7043"/>
        <!-- Windows -->
        <rect x="58" y="85" width="18" height="14" rx="2" fill="#E3F2FD"/>
        <rect x="82" y="85" width="18" height="14" rx="2" fill="#E3F2FD"/>
        <rect x="106" y="85" width="18" height="14" rx="2" fill="#E3F2FD"/>
        <rect x="130" y="85" width="14" height="14" rx="2" fill="#E3F2FD"/>
        <!-- Kids silhouettes in windows -->
        <circle cx="67" cy="90" r="5" fill="#1565C0"/>
        <circle cx="91" cy="90" r="5" fill="#7C3AED"/>
        <circle cx="115" cy="90" r="5" fill="#00796B"/>
        <!-- Stripes -->
        <rect x="52" y="104" width="96" height="4" fill="#E64A19"/>
        <!-- Wheels -->
        <circle cx="75" cy="122" r="10" fill="#212121"/>
        <circle cx="75" cy="122" r="5" fill="#424242"/>
        <circle cx="125" cy="122" r="10" fill="#212121"/>
        <circle cx="125" cy="122" r="5" fill="#424242"/>
        <!-- Headlight -->
        <ellipse cx="148" cy="95" rx="4" ry="6" fill="#FFEE58"/>
        <!-- Logo on bus -->
        <rect x="58" y="105" width="84" height="18" fill="#E64A19"/>
        <text x="100" y="117" text-anchor="middle" font-size="7" fill="white" font-family="sans-serif" font-weight="bold">KATUTRANSPORTE</text>
      </g>
      <style>
        @keyframes busMove{0%{transform:translateX(-160px)}100%{transform:translateX(1360px)}}
      </style>
      <!-- Children at stop -->
      <g>
        <circle cx="420" cy="102" r="8" fill="#FFCA28"/>
        <rect x="414" y="108" width="12" height="14" rx="3" fill="#1565C0"/>
        <circle cx="436" cy="105" r="7" fill="#FFAB40"/>
        <rect x="430" y="110" width="11" height="12" rx="3" fill="#7C3AED"/>
        <circle cx="450" cy="103" r="7" fill="#FFCA28"/>
        <rect x="444" y="108" width="11" height="13" rx="3" fill="#00796B"/>
        <!-- Backpacks -->
        <rect x="416" y="109" width="8" height="9" rx="2" fill="#F4511E"/>
        <rect x="432" y="110" width="7" height="8" rx="2" fill="#FF9800"/>
        <rect x="446" y="109" width="7" height="9" rx="2" fill="#26C6DA"/>
      </g>
    </svg>
  </div>

  <!-- Floating feature pills -->
  <div style="position:absolute;top:1.5rem;left:50%;transform:translateX(-50%);display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;z-index:5;padding:0 1rem">
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:50px;padding:.4rem 1rem;font-size:.74rem;color:#fff;font-weight:600;backdrop-filter:blur(10px);display:flex;align-items:center;gap:.5rem">
      <span class="sd sd-g"></span>Rastreamento GPS ao Vivo
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:50px;padding:.4rem 1rem;font-size:.74rem;color:#fff;font-weight:600;backdrop-filter:blur(10px);display:flex;align-items:center;gap:.5rem">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="white"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      Seguranca com QR Code
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:50px;padding:.4rem 1rem;font-size:.74rem;color:#fff;font-weight:600;backdrop-filter:blur(10px);display:flex;align-items:center;gap:.5rem">
      <svg width="10" height="10" viewBox="0 0 24 24" fill="white"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10" stroke="white" stroke-width="2"/></svg>
      Pagamentos Integrados
    </div>
  </div>

  <!-- Auth Card -->
  <div class="auth-card-wrap">
    <div class="auth-card">
      <!-- Card top banner -->
      <div class="auth-card-banner">
        <div class="auth-card-banner-pattern"></div>
        <div class="auth-card-title-bar">
          <div class="auth-logo-badge">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
          </div>
          <div class="auth-logo-text">
            <h1>Katutransporte</h1>
            <small>Transporte Escolar Seguro</small>
          </div>
        </div>
        <!-- Mini bus scene in banner -->
        <div class="auth-card-bus-scene">
          <svg width="360" height="75" viewBox="0 0 360 75">
            <rect y="50" width="360" height="25" fill="rgba(0,0,0,.25)"/>
            <rect y="47" width="360" height="5" fill="rgba(0,0,0,.3)"/>
            <!-- Mini bus -->
            <rect x="60" y="20" width="80" height="32" rx="5" fill="#FF7043"/>
            <rect x="62" y="22" width="76" height="6" fill="#FF8A65"/>
            <rect x="66" y="25" width="14" height="10" rx="1.5" fill="#B3E5FC"/>
            <rect x="84" y="25" width="14" height="10" rx="1.5" fill="#B3E5FC"/>
            <rect x="102" y="25" width="14" height="10" rx="1.5" fill="#B3E5FC"/>
            <circle cx="75" cy="52" r="8" fill="#212121"/><circle cx="75" cy="52" r="4" fill="#424242"/>
            <circle cx="125" cy="52" r="8" fill="#212121"/><circle cx="125" cy="52" r="4" fill="#424242"/>
            <ellipse cx="139" cy="33" rx="3" ry="4" fill="#FFEE58"/>
            <text x="100" y="43" text-anchor="middle" font-size="5.5" fill="white" font-family="sans-serif" font-weight="bold">KATUTRANSPORTE</text>
            <!-- Kids -->
            <circle cx="250" cy="36" r="7" fill="#FFCA28"/>
            <rect x="244" y="41" width="12" height="13" rx="3" fill="#1565C0"/>
            <circle cx="270" cy="39" r="6" fill="#FFAB40"/>
            <rect x="265" y="43" width="10" height="11" rx="3" fill="#7C3AED"/>
            <circle cx="288" cy="37" r="6" fill="#FFCA28"/>
            <rect x="283" y="41" width="10" height="11" rx="3" fill="#E53935"/>
            <!-- Stop sign -->
            <rect x="310" y="10" width="3" height="40" fill="#607D8B"/>
            <polygon points="311.5,10 320,18 320,28 311.5,36 303,28 303,18" fill="#E53935"/>
            <text x="311.5" y="26" text-anchor="middle" font-size="5" fill="white" font-family="sans-serif" font-weight="bold">STOP</text>
          </svg>
        </div>
      </div>

      <div class="auth-card-body">
        <div class="auth-tabs">
          <button class="auth-tab-btn active" id="tabEntrar" onclick="UI.authTab('login')">Entrar</button>
          <button class="auth-tab-btn" id="tabRegist" onclick="UI.authTab('register')">Criar Conta</button>
        </div>

        <!-- LOGIN PANE -->
        <div id="loginPane" class="auth-form-pane active">
          <div id="loginAlert"></div>
          <form id="loginForm" novalidate>
            <div class="form-group">
              <label class="form-label">Endereco de Email</label>
              <input type="email" id="lEmail" class="form-input" placeholder="utilizador@email.com" autocomplete="email"/>
              <span class="field-err" id="lEmailErr"></span>
            </div>
            <div class="form-group">
              <label class="form-label">Senha</label>
              <input type="password" id="lPwd" class="form-input" placeholder="A sua senha" autocomplete="current-password"/>
              <span class="field-err" id="lPwdErr"></span>
            </div>
            <button type="submit" class="btn btn-primary btn-block btn-lg" style="margin-top:.6rem">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10,17 15,12 10,7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
              Iniciar Sessao
            </button>
          </form>
        </div>

        <!-- REGISTER PANE -->
        <div id="registerPane" class="auth-form-pane">
          <div id="registerAlert"></div>
          <form id="registerForm" novalidate>
            <div class="form-group">
              <label class="form-label">Nome Completo</label>
              <input type="text" id="rName" class="form-input" placeholder="O seu nome completo" autocomplete="name"/>
              <span class="field-err" id="rNameErr"></span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="rEmail" class="form-input" placeholder="email@dominio.com"/>
                <span class="field-err" id="rEmailErr"></span>
              </div>
              <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="tel" id="rPhone" class="form-input" placeholder="+244 9XX XXX XXX"/>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Senha</label>
              <input type="password" id="rPwd" class="form-input" placeholder="Minimo 6 caracteres"/>
              <span class="field-err" id="rPwdErr"></span>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo de Conta</label>
              <select id="rRole" class="form-input">
                <option value="parent">Pai / Responsavel</option>
                <option value="driver">Motorista</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <button type="submit" class="btn btn-orange btn-block btn-lg" style="margin-top:.6rem">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
              Criar Conta
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ╔═══════════════════════════════════════╗
     ║              APP SHELL               ║
     ╚═══════════════════════════════════════╝ -->
<div id="appShell" class="app">
  <div id="sidebarOverlay" class="sidebar-overlay" onclick="UI.closeSidebar()"></div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo-area">
      <div class="sidebar-logo-row">
        <div class="s-logo-badge">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
        </div>
        <div class="s-logo-text">
          <h2>Katutransporte</h2>
          <span>Gestao Escolar</span>
        </div>
      </div>
    </div>

    <!-- Sidebar illustration: mini route map -->
    <div class="sidebar-illo">
      <svg width="100%" height="110" viewBox="0 0 220 110" preserveAspectRatio="xMidYMid meet">
        <rect width="220" height="110" fill="rgba(255,255,255,.03)"/>
        <!-- Road -->
        <rect x="20" y="50" width="180" height="12" rx="2" fill="#263238"/>
        <!-- Route dashes -->
        <line x1="30" y1="56" x2="190" y2="56" stroke="rgba(255,255,255,.2)" stroke-width="1.5" stroke-dasharray="8,6"/>
        <!-- Stops -->
        <circle cx="35" cy="56" r="5" fill="#26A69A" stroke="white" stroke-width="1.5"/>
        <circle cx="80" cy="56" r="5" fill="#26A69A" stroke="white" stroke-width="1.5"/>
        <circle cx="125" cy="56" r="5" fill="#26A69A" stroke="white" stroke-width="1.5"/>
        <circle cx="185" cy="56" r="6" fill="#F4511E" stroke="white" stroke-width="1.5"/>
        <!-- School icon at end -->
        <rect x="175" y="20" width="22" height="20" rx="2" fill="#1565C0"/>
        <polygon points="175,22 186,14 197,22" fill="#0D47A1"/>
        <rect x="181" y="28" width="10" height="12" fill="#1976D2"/>
        <line x1="186" y1="50" x2="186" y2="40" stroke="rgba(255,255,255,.4)" stroke-width="1"/>
        <!-- Mini bus on route -->
        <g style="animation:miniMove 5s linear infinite">
          <rect x="50" y="47" width="22" height="10" rx="2" fill="#FF7043"/>
          <rect x="53" y="49" width="5" height="4" rx="1" fill="#B3E5FC"/>
          <rect x="61" y="49" width="5" height="4" rx="1" fill="#B3E5FC"/>
          <circle cx="54" cy="57" r="2.5" fill="#212121"/>
          <circle cx="67" cy="57" r="2.5" fill="#212121"/>
        </g>
        <!-- Labels -->
        <text x="35" y="46" text-anchor="middle" font-size="6" fill="rgba(255,255,255,.5)" font-family="sans-serif">Casa</text>
        <text x="186" y="14" text-anchor="middle" font-size="6" fill="rgba(255,255,255,.5)" font-family="sans-serif">Escola</text>
        <!-- Kids stick figures -->
        <circle cx="35" cy="32" r="4" fill="#FFCA28"/>
        <rect x="31" y="35" width="8" height="10" rx="2" fill="#1565C0"/>
        <circle cx="80" cy="35" r="4" fill="#FFAB40"/>
        <rect x="76" y="38" width="8" height="10" rx="2" fill="#7C3AED"/>
      </svg>
      <style>@keyframes miniMove{0%{transform:translateX(0)}100%{transform:translateX(120px)}}</style>
    </div>

    <nav class="sidebar-nav" id="sidebarNav"></nav>

    <div class="sidebar-user-area">
      <div class="sidebar-user-card">
        <div class="s-user-av" id="sUserAv">?</div>
        <div style="flex:1;min-width:0">
          <div class="s-user-name" id="sUserName">Utilizador</div>
          <div class="s-user-role" id="sUserRole">Perfil</div>
        </div>
        <button class="s-logout-btn" onclick="Auth.logout()" title="Terminar sessao">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-wrap" id="mainWrap">
    <header class="topbar">
      <div class="topbar-left">
        <button class="hamburger icon-btn" id="hamburger" onclick="UI.toggleSidebar()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <span class="topbar-title" id="topbarTitle">Visao Geral</span>
      </div>
      <div class="topbar-right">
        <button class="notif-trigger" onclick="UI.toggleNotifDrawer()" title="Notificacoes">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span class="notif-pip hidden" id="notifPip">0</span>
        </button>
        <div class="user-pill">
          <div class="user-pill-av" id="topbarAv">?</div>
          <span class="user-pill-name" id="topbarName">Utilizador</span>
        </div>
        <button class="btn btn-outline btn-sm" onclick="Auth.logout()">Sair</button>
      </div>
    </header>

    <main class="page-body">

      <!-- ── OVERVIEW ── -->
      <div id="s-overview" class="section active">
        <div class="page-hero" style="background:linear-gradient(135deg,#0B2447,#1565C0)">
          <div class="page-hero-bg"></div>
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Bom dia! <span id="heroName">Utilizador</span></h2>
            <p>Tudo sob controlo. Veja o resumo do transporte de hoje.</p>
          </div>
          <div class="page-hero-illo">
            <svg width="140" height="80" viewBox="0 0 140 80">
              <!-- Sun -->
              <circle cx="110" cy="20" r="15" fill="#FFD600" opacity=".9"/>
              <line x1="110" y1="0" x2="110" y2="6" stroke="#FFD600" stroke-width="2"/>
              <line x1="110" y1="34" x2="110" y2="40" stroke="#FFD600" stroke-width="2"/>
              <line x1="90" y1="20" x2="96" y2="20" stroke="#FFD600" stroke-width="2"/>
              <line x1="124" y1="20" x2="130" y2="20" stroke="#FFD600" stroke-width="2"/>
              <!-- Bus -->
              <rect x="5" y="36" width="80" height="34" rx="6" fill="#F4511E"/>
              <rect x="7" y="38" width="76" height="8" fill="#FF7043"/>
              <rect x="12" y="42" width="14" height="11" rx="1.5" fill="#B3E5FC"/>
              <rect x="32" y="42" width="14" height="11" rx="1.5" fill="#E3F2FD"/>
              <rect x="52" y="42" width="14" height="11" rx="1.5" fill="#B3E5FC"/>
              <rect x="71" y="42" width="10" height="11" rx="1.5" fill="#E3F2FD"/>
              <rect x="7" y="58" width="76" height="4" fill="#E64A19"/>
              <circle cx="22" cy="70" r="8" fill="#212121"/><circle cx="22" cy="70" r="4" fill="#424242"/>
              <circle cx="65" cy="70" r="8" fill="#212121"/><circle cx="65" cy="70" r="4" fill="#424242"/>
              <ellipse cx="83" cy="46" rx="3" ry="4" fill="#FFEE58"/>
              <text x="42" y="56" text-anchor="middle" font-size="5" fill="white" font-family="sans-serif" font-weight="bold">KATUTRANSPORTE</text>
            </svg>
          </div>
        </div>
        <div class="stats-grid" id="overviewStats"></div>
        <div class="two-col">
          <div class="panel panel-accl">
            <div class="panel-head"><h3>Atividade Recente</h3></div>
            <div class="panel-body np" id="recentAct"></div>
          </div>
          <div class="panel panel-acct">
            <div class="panel-head"><h3>Estado das Criancas</h3></div>
            <div class="panel-body np" id="statusSum"></div>
          </div>
        </div>
      </div>

      <!-- ── CHILDREN ── -->
      <div id="s-children" class="section">
        <div class="page-hero" style="background:linear-gradient(135deg,#5C35CC,#1565C0)">
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Criancas Registadas</h2>
            <p>Gerencie as criancas inscritas no servico de transporte.</p>
          </div>
          <div class="page-hero-illo">
            <svg width="130" height="80" viewBox="0 0 130 80">
              <circle cx="30" cy="22" r="12" fill="#FFCA28"/>
              <rect x="20" y="32" width="20" height="22" rx="5" fill="#1565C0"/>
              <rect x="20" y="33" width="8" height="14" rx="3" fill="#F4511E"/>
              <circle cx="70" cy="25" r="11" fill="#FFAB40"/>
              <rect x="61" y="34" width="18" height="20" rx="5" fill="#7C3AED"/>
              <rect x="61" y="35" width="7" height="13" rx="3" fill="#26A69A"/>
              <circle cx="108" cy="20" r="12" fill="#FFCA28"/>
              <rect x="98" y="30" width="20" height="22" rx="5" fill="#E53935"/>
              <rect x="98" y="31" width="8" height="14" rx="3" fill="#FF9800"/>
              <line x1="30" y1="54" x2="30" y2="70" stroke="#1565C0" stroke-width="3" stroke-linecap="round"/>
              <line x1="22" y1="60" x2="38" y2="60" stroke="#1565C0" stroke-width="3" stroke-linecap="round"/>
              <line x1="70" y1="54" x2="70" y2="70" stroke="#7C3AED" stroke-width="3" stroke-linecap="round"/>
              <line x1="62" y1="60" x2="78" y2="60" stroke="#7C3AED" stroke-width="3" stroke-linecap="round"/>
              <line x1="108" y1="52" x2="108" y2="68" stroke="#E53935" stroke-width="3" stroke-linecap="round"/>
              <line x1="100" y1="58" x2="116" y2="58" stroke="#E53935" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <h3>Listagem de Criancas</h3>
            <button class="btn btn-primary btn-sm" onclick="UI.openModal('childModal')">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Adicionar
            </button>
          </div>
          <div class="panel-body np" id="childrenList"></div>
        </div>
      </div>

      <!-- ── TRACKING ── -->
      <div id="s-tracking" class="section">
        <div class="page-hero" style="background:linear-gradient(135deg,#00796B,#1565C0)">
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Rastreamento em Tempo Real</h2>
            <p>Localizacao GPS do veiculo e estado de cada crianca.</p>
          </div>
          <div class="page-hero-illo">
            <svg width="130" height="80" viewBox="0 0 130 80">
              <circle cx="65" cy="40" r="32" fill="rgba(255,255,255,.1)" stroke="rgba(255,255,255,.2)" stroke-width="1.5"/>
              <circle cx="65" cy="40" r="20" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.15)" stroke-width="1"/>
              <circle cx="65" cy="40" r="5" fill="white" opacity=".9"/>
              <circle cx="40" cy="25" r="5" fill="#FF7043" stroke="white" stroke-width="1.5"/>
              <circle cx="90" cy="30" r="5" fill="#26A69A" stroke="white" stroke-width="1.5"/>
              <circle cx="80" cy="60" r="5" fill="#26A69A" stroke="white" stroke-width="1.5"/>
              <circle cx="45" cy="55" r="5" fill="#26A69A" stroke="white" stroke-width="1.5"/>
              <circle cx="65" cy="18" r="4" fill="#FFD600" stroke="white" stroke-width="1.5"/>
              <line x1="65" y1="40" x2="40" y2="25" stroke="rgba(255,255,255,.3)" stroke-width="1" stroke-dasharray="3,2"/>
              <line x1="65" y1="40" x2="90" y2="30" stroke="rgba(255,255,255,.3)" stroke-width="1" stroke-dasharray="3,2"/>
              <line x1="65" y1="40" x2="80" y2="60" stroke="rgba(255,255,255,.3)" stroke-width="1" stroke-dasharray="3,2"/>
            </svg>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <h3>Mapa ao Vivo</h3>
            <span id="busBadge" class="badge b-teal"><span class="sd sd-g"></span>Activo</span>
          </div>
          <div class="panel-body">
            <div id="map"></div>
            <div class="map-legend">
              <div class="legend-item"><div class="legend-dot" style="background:#F4511E"></div>Veiculo</div>
              <div class="legend-item"><div class="legend-dot" style="background:#26A69A"></div>Paragens</div>
              <div class="legend-item"><div class="legend-dot" style="background:#1565C0"></div>Rota</div>
            </div>
            <p class="text-sm text-muted mt-s">Posicao simulada — GPS em tempo real disponivel na versao de producao.</p>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head"><h3>Estado das Criancas</h3></div>
          <div class="panel-body np" id="trackingList"></div>
        </div>
      </div>

      <!-- ── NOTIFICATIONS ── -->
      <div id="s-notifications" class="section">
        <div class="page-hero" style="background:linear-gradient(135deg,#0B2447,#5C35CC)">
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Notificacoes</h2>
            <p>Avisos de recolha, entrega, chegada e pagamentos.</p>
          </div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <h3>Todas as Notificacoes</h3>
            <button class="btn btn-ghost btn-sm" onclick="AppState.clearNotifs();Render.sNotifications()">Limpar tudo</button>
          </div>
          <div class="panel-body np" id="notifMain" aria-live="polite"></div>
        </div>
      </div>

      <!-- ── PAYMENTS ── -->
      <div id="s-payments" class="section">
        <div class="page-hero" style="background:linear-gradient(135deg,#E65100,#F4511E)">
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Pagamentos</h2>
            <p>Mensalidades, historico financeiro e metodos de pagamento.</p>
          </div>
          <div class="page-hero-illo">
            <svg width="110" height="80" viewBox="0 0 110 80">
              <rect x="10" y="15" width="90" height="55" rx="8" fill="rgba(255,255,255,.15)" stroke="rgba(255,255,255,.3)" stroke-width="1.5"/>
              <rect x="10" y="25" width="90" height="10" fill="rgba(255,255,255,.15)"/>
              <rect x="20" y="42" width="30" height="6" rx="3" fill="rgba(255,255,255,.4)"/>
              <rect x="20" y="54" width="20" height="5" rx="2.5" fill="rgba(255,255,255,.3)"/>
              <circle cx="80" cy="52" r="12" fill="rgba(255,255,255,.2)" stroke="rgba(255,255,255,.4)" stroke-width="1.5"/>
              <text x="80" y="56" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Kz</text>
            </svg>
          </div>
        </div>
        <div class="finance-row" id="financeSummary"></div>
        <div class="panel">
          <div class="panel-head">
            <h3>Historico de Pagamentos</h3>
            <button class="btn btn-orange btn-sm" onclick="UI.openModal('payModal')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Registar
            </button>
          </div>
          <div class="panel-body np" id="paymentList"></div>
        </div>
      </div>

      <!-- ── ROUTES ── -->
      <div id="s-routes" class="section">
        <div class="page-hero" style="background:linear-gradient(135deg,#2E7D32,#00796B)">
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Rota do Dia</h2>
            <p>Lista de recolhas e entregas ordenadas por percurso.</p>
          </div>
        </div>
        <div class="panel panel-acct">
          <div class="panel-head">
            <h3>Fila de Recolha</h3>
            <span id="routeProg" class="chip">0 / 0 entregues</span>
          </div>
          <div class="panel-body np" id="routeList"></div>
        </div>
      </div>

      <!-- ── SECURITY ── -->
      <div id="s-security" class="section">
        <div class="page-hero" style="background:linear-gradient(135deg,#0B2447,#5C35CC)">
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Seguranca e QR Codes</h2>
            <p>Cada crianca tem um PIN e QR Code exclusivo para entrega segura.</p>
          </div>
          <div class="page-hero-illo">
            <svg width="80" height="80" viewBox="0 0 80 80">
              <rect x="15" y="10" width="50" height="60" rx="8" fill="rgba(255,255,255,.15)" stroke="rgba(255,255,255,.3)" stroke-width="1.5"/>
              <rect x="22" y="20" width="36" height="36" rx="4" fill="rgba(255,255,255,.2)"/>
              <rect x="25" y="23" width="10" height="10" rx="1" fill="white" opacity=".7"/>
              <rect x="38" y="23" width="10" height="10" rx="1" fill="white" opacity=".5"/>
              <rect x="25" y="36" width="10" height="10" rx="1" fill="white" opacity=".5"/>
              <rect x="38" y="36" width="10" height="10" rx="1" fill="white" opacity=".7"/>
              <rect x="28" y="26" width="4" height="4" fill="rgba(0,0,0,.3)" rx=".5"/>
              <rect x="41" y="26" width="4" height="4" fill="rgba(0,0,0,.3)" rx=".5"/>
              <rect x="28" y="39" width="4" height="4" fill="rgba(0,0,0,.3)" rx=".5"/>
              <rect x="41" y="39" width="4" height="4" fill="rgba(0,0,0,.3)" rx=".5"/>
              <path d="M36 62 l-3-4 h6 z" fill="white" opacity=".6"/>
              <circle cx="40" cy="60" r="3" fill="white" opacity=".6"/>
            </svg>
          </div>
        </div>
        <div class="panel panel-accv">
          <div class="panel-head">
            <h3>QR Codes e Autorizacoes</h3>
          </div>
          <div class="panel-body" id="securityContent"></div>
        </div>
      </div>

      <!-- ── ADMIN ── -->
      <div id="s-admin" class="section">
        <div class="page-hero" style="background:linear-gradient(135deg,#0B2447,#19376D)">
          <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.07) 1.5px,transparent 1.5px);background-size:24px 24px;z-index:1"></div>
          <div class="page-hero-content">
            <h2>Painel Administrativo</h2>
            <p>Gestao de utilizadores, motoristas, rotas e relatorios.</p>
          </div>
        </div>
        <div class="stats-grid" id="adminStats"></div>
        <div class="two-col">
          <div class="panel panel-accb">
            <div class="panel-head"><h3>Utilizadores</h3></div>
            <div class="panel-body np" id="adminUsers"></div>
          </div>
          <div class="panel panel-accl">
            <div class="panel-head"><h3>Relatorio Financeiro</h3></div>
            <div class="panel-body" id="adminFinance"></div>
          </div>
        </div>
        <div class="panel mt-m">
          <div class="panel-head">
            <h3>Motoristas</h3>
            <button class="btn btn-primary btn-sm" onclick="UI.openModal('driverModal')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Adicionar
            </button>
          </div>
          <div class="panel-body np" id="adminDrivers"></div>
        </div>
      </div>

    </main>
  </div>

  <!-- Notification Drawer -->
  <div id="notifDrawer" class="notif-drawer">
    <div class="notif-drawer-head">
      <h3>Notificacoes</h3>
      <button class="icon-btn" style="background:rgba(255,255,255,.1);border-color:transparent;color:#fff" onclick="UI.toggleNotifDrawer()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="notif-scroll" id="notifSideList"></div>
  </div>
</div>

<!-- ══════════ MODALS ══════════ -->
<!-- Add Child -->
<div id="childModal" class="modal-ov" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Registar Crianca</h3>
      <button class="modal-close-btn" onclick="UI.closeModal('childModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="childForm" novalidate>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nome Completo</label>
            <input type="text" id="cName" class="form-input" placeholder="Nome da crianca"/>
            <span class="field-err" id="cNameErr"></span>
          </div>
          <div class="form-group">
            <label class="form-label">Idade</label>
            <input type="number" id="cAge" class="form-input" min="3" max="18" placeholder="3 – 18"/>
            <span class="field-err" id="cAgeErr"></span>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Genero</label>
            <select id="cGender" class="form-input"><option value="F">Feminino</option><option value="M">Masculino</option></select>
          </div>
          <div class="form-group">
            <label class="form-label">Grupo de Rota</label>
            <select id="cGroup" class="form-input">
              <option value="A1">Manha — Grupo A</option>
              <option value="A2">Manha — Grupo B</option>
              <option value="A3">Manha — Grupo C</option>
              <option value="P1">Tarde — Grupo A</option>
              <option value="P2">Tarde — Grupo B</option>
              <option value="P3">Tarde — Grupo C</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Escola</label>
          <input type="text" id="cSchool" class="form-input" placeholder="Nome da escola"/>
          <span class="field-err" id="cSchoolErr"></span>
        </div>
        <div class="form-group">
          <label class="form-label">Endereco Residencial</label>
          <input type="text" id="cAddress" class="form-input" placeholder="Rua, numero, bairro"/>
          <span class="field-err" id="cAddressErr"></span>
        </div>
        <div class="form-group">
          <label class="form-label">Contacto de Emergencia</label>
          <input type="tel" id="cEmergency" class="form-input" placeholder="+244 9XX XXX XXX"/>
        </div>
        <div class="form-group">
          <label class="form-label">Responsaveis Autorizados</label>
          <input type="text" id="cAuthorized" class="form-input" placeholder="Nome, Nome... (separados por virgula)"/>
        </div>
        <div class="form-group">
          <label class="form-label">Informacoes Medicas <span class="text-muted text-sm">(opcional)</span></label>
          <textarea id="cMedical" class="form-input" placeholder="Alergias, medicamentos, condicoes..."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="UI.closeModal('childModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="Forms.submitChild()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
        Guardar
      </button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="payModal" class="modal-ov" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Registar Pagamento</h3>
      <button class="modal-close-btn" onclick="UI.closeModal('payModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="payForm" novalidate>
        <div class="form-group">
          <label class="form-label">Descricao</label>
          <input type="text" id="pDesc" class="form-input" placeholder="Ex: Mensalidade Junho 2025"/>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Valor (Kz)</label>
            <input type="number" id="pAmount" class="form-input" placeholder="15000" min="0"/>
          </div>
          <div class="form-group">
            <label class="form-label">Estado</label>
            <select id="pStatus" class="form-input"><option value="paid">Pago</option><option value="pending">Pendente</option></select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Metodo de Pagamento</label>
          <select id="pMethod" class="form-input">
            <option value="multicaixa">Multicaixa Express</option>
            <option value="transfer">Transferencia Bancaria</option>
            <option value="cash">Numerario</option>
            <option value="unitel">Unitel Money</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="UI.closeModal('payModal')">Cancelar</button>
      <button class="btn btn-orange" onclick="Forms.submitPayment()">Registar Pagamento</button>
    </div>
  </div>
</div>

<!-- Driver Modal -->
<div id="driverModal" class="modal-ov" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Adicionar Motorista</h3>
      <button class="modal-close-btn" onclick="UI.closeModal('driverModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="driverForm" novalidate>
        <div class="form-group">
          <label class="form-label">Nome Completo</label>
          <input type="text" id="drName" class="form-input" placeholder="Nome do motorista"/>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Telefone</label>
            <input type="tel" id="drPhone" class="form-input" placeholder="+244 9XX XXX XXX"/>
          </div>
          <div class="form-group">
            <label class="form-label">N. Carta de Conducao</label>
            <input type="text" id="drLicense" class="form-input" placeholder="AO-XXXX-XXX"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Viatura</label>
            <input type="text" id="drVehicle" class="form-input" placeholder="Toyota Hiace"/>
          </div>
          <div class="form-group">
            <label class="form-label">Rota Atribuida</label>
            <select id="drRoute" class="form-input">
              <option value="A1">Manha — Grupo A</option>
              <option value="A2">Manha — Grupo B</option>
              <option value="A3">Manha — Grupo C</option>
              <option value="P1">Tarde — Grupo A</option>
              <option value="P2">Tarde — Grupo B</option>
              <option value="P3">Tarde — Grupo C</option>
            </select>
          </div>
        </div>
        <hr class="divider"/>
        <div class="form-group">
          <label class="form-label">Email de Acesso</label>
          <input type="email" id="drEmail" class="form-input" placeholder="motorista@katutransporte.ao"/>
        </div>
        <div class="form-group">
          <label class="form-label">Senha de Acesso</label>
          <input type="password" id="drPwd" class="form-input" placeholder="Minimo 6 caracteres"/>
        </div>
      </form>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="UI.closeModal('driverModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="Forms.submitDriver()">Adicionar Motorista</button>
    </div>
  </div>
</div>

<div id="spinOv" class="spin-ov"><div class="spinner"></div></div>
<div id="toasts" aria-live="polite"></div>

<script>
/* =======================================
   DATABASE
======================================= */
const DB={
  _k:n=>`katu_${n}`,
  get(t){try{return JSON.parse(localStorage.getItem(this._k(t)))||[]}catch{return[]}},
  save(t,d){localStorage.setItem(this._k(t),JSON.stringify(d))},
  find(t,fn){return this.get(t).find(fn)},
  filter(t,fn){return this.get(t).filter(fn)},
  insert(t,row){const d=this.get(t);d.push(row);this.save(t,d);return row},
  update(t,id,u){const d=this.get(t).map(r=>r.id===id?{...r,...u}:r);this.save(t,d);return d.find(r=>r.id===id)},
  remove(t,id){this.save(t,this.get(t).filter(r=>r.id!==id))},
  nextId(t){const d=this.get(t);return d.length?Math.max(...d.map(r=>r.id))+1:1},
  seed(){
    if(this.find('users',u=>u.email==='pai@katutransporte.ao'))return;
    this.insert('users',{id:1,name:'Maria Mbunga',email:'pai@katutransporte.ao',password:'katu123',phone:'+244 923 456 789',role:'parent',createdAt:new Date().toISOString()});
    this.insert('users',{id:2,name:'Carlos Mendes',email:'motorista@katutransporte.ao',password:'katu123',phone:'+244 912 111 222',role:'driver',vehicle:'Toyota Hiace',license:'AO-2021-XK7',route:'A1',createdAt:new Date().toISOString()});
    this.insert('users',{id:3,name:'Admin Sistema',email:'admin@katutransporte.ao',password:'admin123',phone:'+244 900 000 001',role:'admin',createdAt:new Date().toISOString()});
    [{id:1,userId:1,name:'Ana Mbunga',age:8,gender:'F',school:'Colegio Santo Antonio',address:'Rua do Kilamba, 12',status:'transit',medical_info:'',group:'A1',authorized:'Maria Mbunga, Jose Mbunga',pin:'4821'},
     {id:2,userId:1,name:'Joao Ngueve',age:11,gender:'M',school:'Escola Primaria Sol',address:'Av. Brasil, 45',status:'picked',medical_info:'',group:'A2',authorized:'Maria Mbunga',pin:'7364'},
     {id:3,userId:1,name:'Sofia Lemos',age:7,gender:'F',school:'Colegio Santo Antonio',address:'Rua Mae Isabel, 3',status:'waiting',medical_info:'Alergica a amendoim',group:'A1',authorized:'Maria Mbunga, Luisa Lemos',pin:'2957'}
    ].forEach(c=>this.insert('children',c));
    const ts=s=>new Date(Date.now()-s).toISOString();
    [{id:1,userId:1,type:'departure',message:'O veiculo partiu do deposito as 06h30.',createdAt:ts(3600000),read:true},
     {id:2,userId:1,type:'pickup',message:'Ana Mbunga foi recolhida com seguranca.',createdAt:ts(1800000),read:true},
     {id:3,userId:1,type:'arrival',message:'O veiculo esta a 5 minutos do destino.',createdAt:ts(600000),read:false},
     {id:4,userId:1,type:'payment',message:'Pagamento de Maio 2025 esta pendente.',createdAt:ts(86400000),read:false}
    ].forEach(n=>this.insert('notifications',n));
    [{id:1,userId:1,description:'Mensalidade Marco 2025',amount:15000,status:'paid',method:'multicaixa',createdAt:ts(86400000*60)},
     {id:2,userId:1,description:'Mensalidade Abril 2025',amount:15000,status:'paid',method:'transfer',createdAt:ts(86400000*30)},
     {id:3,userId:1,description:'Mensalidade Maio 2025',amount:15000,status:'pending',method:'',createdAt:ts(86400000)}
    ].forEach(p=>this.insert('payments',p));
  }
};

const Session={
  _k:'katu_sess',
  set(u){localStorage.setItem(this._k,JSON.stringify({userId:u.id,role:u.role,name:u.name}))},
  get(){try{return JSON.parse(localStorage.getItem(this._k))}catch{return null}},
  clear(){localStorage.removeItem(this._k)},
  active(){return!!this.get()}
};

const Auth={
  login(email,pwd){
    const u=DB.find('users',u=>u.email.toLowerCase()===email.trim().toLowerCase());
    if(!u)throw new Error('Email nao encontrado.');
    if(u.password!==pwd)throw new Error('Senha incorreta.');
    Session.set(u);return u;
  },
  register(data){
    if(DB.find('users',u=>u.email.toLowerCase()===data.email.trim().toLowerCase()))
      throw new Error('Este email ja esta registado.');
    return DB.insert('users',{id:DB.nextId('users'),name:data.name.trim(),email:data.email.trim().toLowerCase(),password:data.password,phone:data.phone||'',role:data.role,createdAt:new Date().toISOString()});
  },
  logout(){Realtime.stop();MapMod.destroy();Session.clear();AppState.reset();UI.showAuth();Toast.show('Sessao terminada.','info')},
  currentUser(){const s=Session.get();return s?DB.find('users',u=>u.id===s.userId)||null:null}
};

const AppState={
  user:null,children:[],notifs:[],payments:[],
  load(){
    const u=Auth.currentUser();if(!u)return false;
    this.user=u;
    this.children=u.role==='admin'?DB.get('children'):DB.filter('children',c=>c.userId===u.id);
    this.notifs=(u.role==='admin'?DB.get('notifications'):DB.filter('notifications',n=>n.userId===u.id)).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    this.payments=u.role==='admin'?DB.get('payments'):DB.filter('payments',p=>p.userId===u.id).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    return true;
  },
  reset(){this.user=null;this.children=[];this.notifs=[];this.payments=[]},
  addChild(data){
    const c=DB.insert('children',{id:DB.nextId('children'),userId:this.user.id,status:'waiting',pin:Math.floor(1000+Math.random()*9000)+'', ...data});
    this.children.push(c);return c;
  },
  updateStatus(id,status){
    DB.update('children',id,{status});
    this.children=this.children.map(c=>c.id===id?{...c,status}:c);
  },
  addNotif(msg,type='info'){
    const n=DB.insert('notifications',{id:DB.nextId('notifications'),userId:this.user.id,message:msg,type,createdAt:new Date().toISOString(),read:false});
    this.notifs.unshift(n);
  },
  clearNotifs(){
    DB.filter('notifications',n=>n.userId===this.user.id).forEach(n=>DB.remove('notifications',n.id));
    this.notifs=[];
  },
  unread(){return this.notifs.filter(n=>!n.read).length}
};

/* =========== NAV CONFIG =========== */
const NAVS={
  parent:[
    {id:'overview',label:'Visao Geral',ico:'grid'},
    {id:'children',label:'Criancas',ico:'users'},
    {id:'tracking',label:'Rastreamento',ico:'map'},
    {id:'notifications',label:'Notificacoes',ico:'bell',badge:true},
    {id:'payments',label:'Pagamentos',ico:'credit'},
    {id:'security',label:'Seguranca QR',ico:'shield'},
  ],
  driver:[
    {id:'overview',label:'Resumo',ico:'grid'},
    {id:'routes',label:'Rota do Dia',ico:'route'},
    {id:'tracking',label:'Mapa',ico:'map'},
    {id:'notifications',label:'Notificacoes',ico:'bell',badge:true},
  ],
  admin:[
    {id:'overview',label:'Dashboard',ico:'grid'},
    {id:'admin',label:'Administracao',ico:'settings'},
    {id:'tracking',label:'Rastreamento',ico:'map'},
    {id:'notifications',label:'Notificacoes',ico:'bell',badge:true},
    {id:'payments',label:'Financeiro',ico:'credit'},
    {id:'security',label:'Seguranca',ico:'shield'},
  ]
};

/* =========== SVG ICONS =========== */
const ICO={
  grid:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>`,
  users:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  map:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1,6 1,22 8,18 16,22 23,18 23,2 16,6 8,2"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>`,
  bell:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
  credit:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>`,
  shield:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
  route:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="6" r="3"/><path d="M8 6h9a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H8"/><circle cx="5" cy="18" r="3"/></svg>`,
  settings:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>`,
  bus:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>`,
  check:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20,6 9,17 4,12"/></svg>`
};

/* =========== VALIDATORS =========== */
const V={
  email:v=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim()),
  pwd:v=>v.length>=6,
  name:v=>v.trim().length>=2,
  age:v=>Number(v)>=3&&Number(v)<=18,
  str:v=>v.trim().length>=2,
  addr:v=>v.trim().length>=4,
  f(id,fn,eid,msg){
    const el=g(id),er=g(eid);
    const ok=fn(el.value);
    el.classList.toggle('invalid',!ok);el.classList.toggle('valid',ok);
    if(er)er.textContent=ok?'':msg;
    return ok;
  },
  live(id,fn,eid,msg){
    const el=g(id);if(!el)return;
    const chk=()=>this.f(id,fn,eid,msg);
    el.addEventListener('blur',chk);
    el.addEventListener('input',()=>{if(el.classList.contains('invalid'))chk()});
  }
};

/* =========== RENDER =========== */
const Render={
  all(){
    this.sOverview();
    const r=AppState.user?.role;
    if(r==='parent'||r==='admin'){this.sChildren();this.sPayments();this.sSecurity();}
    if(r==='driver'||r==='admin')this.sRoutes();
    if(r==='admin')this.sAdmin();
    this.sTracking();this.sNotifications();this.notifBadge();
  },

  sOverview(){
    const c=AppState.children,u=AppState.user;
    g('heroName').textContent=u.name.split(' ')[0];
    if(u.role==='admin'){
      const users=DB.get('users'),pays=DB.get('payments');
      g('overviewStats').innerHTML=
        this._stat('Familias',users.filter(x=>x.role==='parent').length,'#E3F2FD','#1565C0',ICO.users)+
        this._stat('Motoristas',users.filter(x=>x.role==='driver').length,'#E0F2F1','#00796B',ICO.bus)+
        this._stat('Criancas',DB.get('children').length,'#EDE7F6','#5C35CC',ICO.users)+
        this._stat('Receita',pays.filter(p=>p.status==='paid').reduce((s,p)=>s+Number(p.amount),0).toLocaleString('pt-PT')+' Kz','#FFF3EF','#E65100',ICO.credit);
    } else {
      const pend=AppState.payments.filter(p=>p.status==='pending').reduce((s,p)=>s+Number(p.amount),0);
      g('overviewStats').innerHTML=
        this._stat('Criancas',c.length,'#E3F2FD','#1565C0',ICO.users)+
        this._stat('Em Transporte',c.filter(x=>x.status==='transit'||x.status==='picked').length,'#E0F2F1','#00796B',ICO.bus)+
        this._stat('Entregues',c.filter(x=>x.status==='delivered').length,'#DCFCE7','#2E7D32',ICO.check)+
        (pend>0?this._stat('Pendente',pend.toLocaleString('pt-PT')+' Kz','#FFEBEE','#C62828',ICO.credit):'');
    }
    g('recentAct').innerHTML=AppState.notifs.slice(0,5).map(n=>`
      <div class="notif-item">
        <div class="notif-ico-wrap" style="background:${this._nColor(n.type)}18;color:${this._nColor(n.type)}">${this._nIcon(n.type)}</div>
        <div class="notif-text"><div class="notif-time">${this._dt(n.createdAt)}</div><div class="notif-msg">${n.message}</div></div>
      </div>`).join('')||this._empty('Sem actividade recente.');
    g('statusSum').innerHTML=c.length?c.map(k=>`
      <div class="list-item">
        <div class="li-av" style="background:${this._av(k.name)};">${k.name[0]}</div>
        <div class="li-info"><div class="li-name">${k.name}</div><div class="li-meta">${k.school}</div></div>
        ${this._sbadge(k.status)}
      </div>`).join(''):this._empty('Nenhuma crianca registada.');
  },

  sChildren(){
    const el=g('childrenList');
    el.innerHTML=AppState.children.length?AppState.children.map(c=>this._childRow(c)).join(''):this._empty('Nenhuma crianca registada. Adicione a primeira crianca.');
  },

  sTracking(){
    const el=g('trackingList');
    el.innerHTML=AppState.children.length?AppState.children.map(c=>`
      <div class="list-item">
        <div class="li-av" style="background:${this._av(c.name)};">${c.name[0]}</div>
        <div class="li-info">
          <div class="li-name">${c.name}</div>
          <div class="li-meta">${c.school} ? ${c.address}</div>
          <div class="li-meta" style="color:#00796B;font-weight:600">${this._eta(c.status)}</div>
        </div>
        ${this._sbadge(c.status)}
      </div>`).join(''):this._empty('Sem dados de rastreamento.');
  },

  sNotifications(){
    const items=AppState.notifs.map(n=>`
      <div class="notif-item${n.read?'':' unread'}">
        <div class="notif-ico-wrap" style="background:${this._nColor(n.type)}18;color:${this._nColor(n.type)}">${this._nIcon(n.type)}</div>
        <div class="notif-text">
          <div class="notif-time">${this._dt(n.createdAt)}${!n.read?' &nbsp;<span class="badge b-info" style="font-size:.6rem">Novo</span>':''}</div>
          <div class="notif-msg">${n.message}</div>
        </div>
      </div>`).join('');
    const html=items||this._empty('Sem notificacoes.');
    if(g('notifMain'))g('notifMain').innerHTML=html;
    if(g('notifSideList'))g('notifSideList').innerHTML=html;
  },

  sPayments(){
    const pays=AppState.payments;
    const paid=pays.filter(p=>p.status==='paid').reduce((s,p)=>s+Number(p.amount),0);
    const pend=pays.filter(p=>p.status==='pending').reduce((s,p)=>s+Number(p.amount),0);
    const tot=paid+pend;
    g('financeSummary').innerHTML=`
      <div class="fin-card"><div class="fin-card-bar" style="background:linear-gradient(90deg,#2E7D32,#43A047)"></div><div class="fin-label">Total Recebido</div><div class="fin-amount" style="color:#1B5E20">${paid.toLocaleString('pt-PT')} Kz</div></div>
      <div class="fin-card"><div class="fin-card-bar" style="background:linear-gradient(90deg,#C62828,#E53935)"></div><div class="fin-label">Em Atraso</div><div class="fin-amount" style="color:#B71C1C">${pend.toLocaleString('pt-PT')} Kz</div></div>
      <div class="fin-card"><div class="fin-card-bar" style="background:linear-gradient(90deg,#1565C0,#1E88E5)"></div><div class="fin-label">Total</div><div class="fin-amount">${tot.toLocaleString('pt-PT')} Kz</div></div>`;
    g('paymentList').innerHTML=pays.length?pays.map(p=>`
      <div class="pay-card">
        <div class="pay-desc">
          <h4>${p.description}</h4>
          <p>${this._dt(p.createdAt)} ? ${{multicaixa:'Multicaixa Express',transfer:'Transferencia Bancaria',cash:'Numerario',unitel:'Unitel Money','':'?'}[p.method]||p.method}</p>
        </div>
        <div>
          <div class="pay-val">${Number(p.amount).toLocaleString('pt-PT')} Kz</div>
          <div class="mt-s"><span class="badge ${p.status==='paid'?'b-paid':'b-pending'}">${p.status==='paid'?'Pago':'Pendente'}</span></div>
        </div>
      </div>`).join(''):this._empty('Sem pagamentos registados.');
  },

  sRoutes(){
    const kids=AppState.children;
    const done=kids.filter(c=>c.status==='delivered').length;
    if(g('routeProg'))g('routeProg').textContent=`${done} / ${kids.length} entregues`;
    if(g('routeList'))g('routeList').innerHTML=kids.length?`<div style="padding:.5rem 1.4rem">`+kids.map((c,i)=>`
      <div class="queue-item${c.status==='delivered'?' done':''}">
        <div class="flex items-center gap-m">
          <div class="queue-num">${i+1}</div>
          <div class="li-av" style="background:${this._av(c.name)};width:38px;height:38px;font-size:.88rem;">${c.name[0]}</div>
          <div class="li-info">
            <div class="li-name">${c.name}</div>
            <div class="li-meta">${c.address}</div>
            <div class="li-meta">${c.school} ? ${c.age} anos${c.medical_info?` <span style="color:#C62828">| ${c.medical_info}</span>`:''}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.4rem;margin-left:auto">
            ${this._sbadge(c.status)}
            <div class="flex gap-s" style="margin-top:.2rem">
              <button class="btn btn-teal btn-sm" onclick="Driver.upd(${c.id},'picked')">Recolher</button>
              <button class="btn btn-orange btn-sm" onclick="Driver.upd(${c.id},'delivered')">Entregar</button>
            </div>
          </div>
        </div>
      </div>`).join('')+'</div>':this._empty('Sem rota atribuida. Contacte o administrador.');
  },

  sSecurity(){
    const el=g('securityContent');if(!el)return;
    const kids=AppState.children;
    if(!kids.length){el.innerHTML=this._empty('Adicione criancas para gerir a seguranca.');return;}
    el.innerHTML=`<p class="text-muted text-sm mb-m">Cada crianca possui um PIN exclusivo. Apresente ao motorista no momento da entrega para confirmacao segura.</p>
    <div class="qr-grid">${kids.map(c=>`
      <div class="qr-card">
        <div class="li-av" style="background:${this._av(c.name)};width:44px;height:44px;margin:0 auto .6rem;">${c.name[0]}</div>
        <div style="font-weight:800;font-size:.9rem;margin-bottom:.15rem">${c.name}</div>
        <div class="qr-vis">
          <svg width="70" height="70" viewBox="0 0 70 70">
            <rect width="70" height="70" fill="#F8FAFF"/>
            <rect x="5" y="5" width="25" height="25" rx="3" fill="none" stroke="#0B2447" stroke-width="2"/>
            <rect x="10" y="10" width="15" height="15" rx="1" fill="#0B2447"/>
            <rect x="40" y="5" width="25" height="25" rx="3" fill="none" stroke="#0B2447" stroke-width="2"/>
            <rect x="45" y="10" width="15" height="15" rx="1" fill="#0B2447"/>
            <rect x="5" y="40" width="25" height="25" rx="3" fill="none" stroke="#0B2447" stroke-width="2"/>
            <rect x="10" y="45" width="15" height="15" rx="1" fill="#0B2447"/>
            <rect x="40" y="40" width="8" height="8" fill="#0B2447"/>
            <rect x="52" y="40" width="8" height="8" fill="#0B2447"/>
            <rect x="40" y="52" width="8" height="8" fill="#0B2447"/>
            <rect x="52" y="52" width="8" height="8" fill="#0B2447"/>
          </svg>
          <div style="font-size:.68rem;font-weight:800;color:var(--navy);letter-spacing:.08em">PIN: ${c.pin}</div>
        </div>
        <div class="text-sm text-muted mb-s">Autorizados: ${c.authorized||'Nao definido'}</div>
        <button class="btn btn-outline btn-sm" style="width:100%" onclick="UI.showQR(${c.id})">Ver Detalhes</button>
      </div>`).join('')}</div>`;
  },

  sAdmin(){
    const users=DB.get('users'),kids=DB.get('children'),pays=DB.get('payments');
    const paid=pays.filter(p=>p.status==='paid').reduce((s,p)=>s+Number(p.amount),0);
    const pend=pays.filter(p=>p.status==='pending').reduce((s,p)=>s+Number(p.amount),0);
    g('adminStats').innerHTML=
      this._stat('Familias',users.filter(x=>x.role==='parent').length,'#E3F2FD','#1565C0',ICO.users)+
      this._stat('Motoristas',users.filter(x=>x.role==='driver').length,'#E0F2F1','#00796B',ICO.bus)+
      this._stat('Criancas',kids.length,'#EDE7F6','#5C35CC',ICO.users)+
      this._stat('Receita',paid.toLocaleString('pt-PT')+' Kz','#F1FBF4','#2E7D32',ICO.credit);
    g('adminUsers').innerHTML=users.map(u=>`
      <div class="list-item">
        <div class="li-av" style="background:${this._av(u.name)};">${u.name[0]}</div>
        <div class="li-info"><div class="li-name">${u.name}</div><div class="li-meta">${u.email} ? ${kids.filter(c=>c.userId===u.id).length} crianca(s)</div></div>
        <span class="badge b-navy" style="font-size:.64rem">${{parent:'Responsavel',driver:'Motorista',admin:'Admin'}[u.role]||u.role}</span>
      </div>`).join('');
    const tot=paid+pend;
    g('adminFinance').innerHTML=`
      <div class="sec-label">Resumo do Mes</div>
      <div class="flex justify-between items-center" style="padding:.7rem 0;border-bottom:1px solid var(--border2)"><span class="text-sm">Recebido</span><span style="font-weight:800;color:#1B5E20">${paid.toLocaleString('pt-PT')} Kz</span></div>
      <div class="flex justify-between items-center" style="padding:.7rem 0;border-bottom:1px solid var(--border2)"><span class="text-sm">Em Atraso</span><span style="font-weight:800;color:#B71C1C">${pend.toLocaleString('pt-PT')} Kz</span></div>
      <div class="flex justify-between items-center" style="padding:.7rem 0"><span class="text-sm">Total</span><span style="font-weight:800">${tot.toLocaleString('pt-PT')} Kz</span></div>
      <div class="prog-bar mt-s"><div class="prog-fill pf-green" style="width:${tot>0?Math.round(paid/tot*100):0}%"></div></div>
      <div class="text-sm text-muted mt-s">${tot>0?Math.round(paid/tot*100):0}% cobrado</div>`;
    const drivers=users.filter(u=>u.role==='driver');
    g('adminDrivers').innerHTML=drivers.length?drivers.map(d=>`
      <div class="list-item">
        <div class="li-av" style="background:var(--navy);color:#fff;">${d.name[0]}</div>
        <div class="li-info">
          <div class="li-name">${d.name}</div>
          <div class="li-meta">${d.phone||'?'} ? ${d.vehicle||'Sem viatura'} ? Carta: ${d.license||'?'}</div>
          <div class="li-meta">Rota: ${d.route||'Nao atribuida'}</div>
        </div>
        <span class="badge b-teal"><span class="sd sd-g"></span>Activo</span>
      </div>`).join(''):this._empty('Nenhum motorista registado.');
  },

  notifBadge(){
    const n=AppState.unread();
    const pip=g('notifPip');
    if(pip){pip.textContent=n;pip.classList.toggle('hidden',n===0)}
    document.querySelectorAll('.nav-badge').forEach(el=>{el.textContent=n;el.style.display=n>0?'':'none'});
  },

  /* helpers */
  _stat(label,val,bg,color,ico){return`<div class="stat-card"><div class="stat-card-glow" style="background:${color}"></div><div class="stat-top"><span class="stat-label">${label}</span><div class="stat-ico" style="background:${bg};color:${color}">${ico}</div></div><div class="stat-val">${val}</div></div>`},
  _sbadge(s){const m={waiting:['b-waiting','Aguardando'],picked:['b-picked','Recolhida'],transit:['b-transit','Em Transporte'],delivered:['b-delivered','Entregue']};const[c,l]=m[s]||['b-info',s];return`<span class="badge ${c}">${l}</span>`},
  _childRow(c){return`<div class="list-item"><div class="li-av" style="background:${this._av(c.name)};">${c.name[0]}</div><div class="li-info"><div class="li-name">${c.name}</div><div class="li-meta">${c.school} ? ${c.age} anos ? Grupo: ${c.group||'?'}</div><div class="li-meta">${c.address}${c.medical_info?` <span style="color:#C62828">| ${c.medical_info}</span>`:''}</div></div><div class="li-actions">${this._sbadge(c.status)}</div></div>`},
  _eta(s){return{waiting:'Previsao de recolha: ~20 min',picked:'Recolhida ? a caminho da escola',transit:'Em transporte ? chegada em ~10 min',delivered:'Entregue com sucesso'}[s]||''},
  _av(name){const c=['#1565C0','#00796B','#5C35CC','#E65100','#C62828','#19376D','#2E7D32'];return c[name.charCodeAt(0)%c.length]},
  _nColor(t){return{departure:'#1565C0',pickup:'#2E7D32',arrival:'#00796B',payment:'#C62828',delay:'#E65100',info:'#1565C0'}[t]||'#1565C0'},
  _nIcon(t){const m={departure:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/></svg>`,pickup:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20,6 9,17 4,12"/></svg>`,arrival:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>`,payment:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>`};return m[t]||m.arrival},
  _dt(iso){try{return new Date(iso).toLocaleString('pt-PT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}catch{return iso}},
  _empty(msg){return`<div class="empty-state"><div class="empty-illo"><svg width="52" height="52" viewBox="0 0 52 52"><circle cx="26" cy="26" r="25" fill="#EEF2FA"/><path d="M18 30l-4-4 4-4M34 30l4-4-4-4M22 34l4-10 4 10" stroke="#95A8BE" stroke-width="2" stroke-linecap="round" fill="none"/></svg></div><h4>Sem dados</h4><p>${msg}</p></div>`}
};

/* =========== DRIVER =========== */
const Driver={
  upd(id,status){
    AppState.updateStatus(id,status);
    const c=AppState.children.find(x=>x.id===id);
    const lbl={picked:'recolhida',delivered:'entregue'}[status]||status;
    AppState.addNotif(`${c?.name||'Crianca'} marcada como ${lbl}.`,status==='picked'?'pickup':'arrival');
    Render.all();Toast.show(`${c?.name} ? ${lbl}.`,'success');
  }
};

/* =========== MAP =========== */
const MapMod={
  _m:null,_mk:null,_iv:null,_i:0,
  _pts:[[-8.838,13.234],[-8.841,13.240],[-8.845,13.248],[-8.849,13.255],[-8.854,13.261],[-8.857,13.268],[-8.852,13.275],[-8.847,13.270],[-8.843,13.262]],
  init(){
    if(this._m){setTimeout(()=>this._m.invalidateSize(),200);return}
    this._m=L.map('map').setView(this._pts[0],14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'(c) OpenStreetMap',maxZoom:19}).addTo(this._m);
    const ico=L.divIcon({html:`<div style="background:#F4511E;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(244,81,30,.5);border:2px solid white">${ICO.bus.replace('currentColor','white').replace('width="15" height="15"','width="16" height="16"')}</div>`,className:'',iconSize:[34,34],iconAnchor:[17,17]});
    this._mk=L.marker(this._pts[0],{icon:ico,alt:'Veiculo'}).addTo(this._m).bindPopup('<strong>Katutransporte</strong><br>Em rota',{closeButton:false}).openPopup();
    L.polyline(this._pts,{color:'#1565C0',weight:3,opacity:.5,dashArray:'7 5'}).addTo(this._m);
    this._pts.forEach((p,i)=>L.circleMarker(p,{radius:6,fillColor:'#26A69A',color:'#fff',weight:2,fillOpacity:1}).addTo(this._m).bindTooltip(`Paragem ${i+1}`));
    this._iv=setInterval(()=>{
      this._i=(this._i+1)%this._pts.length;
      this._mk.setLatLng(this._pts[this._i]);
      this._m.panTo(this._pts[this._i],{animate:true,duration:1.2});
      const b=g('busBadge');if(b)b.innerHTML=`<span class="sd sd-g"></span>Paragem ${this._i+1}`;
    },4000);
  },
  destroy(){clearInterval(this._iv);this._iv=null;if(this._m){this._m.remove();this._m=null;}}
};

/* =========== REALTIME =========== */
const Realtime={
  _t:null,_i:0,
  _msgs:[['O veiculo partiu do deposito.','departure'],['O veiculo esta a 5 minutos da sua zona.','arrival'],['Uma crianca foi recolhida com seguranca.','pickup'],['O veiculo chegou a escola.','arrival'],['Rota de regresso iniciada.','departure'],['Entrega prevista em 15 minutos.','arrival']],
  start(){
    if(this._t)return;
    this._t=setInterval(()=>{
      if(!AppState.user)return;
      const[msg,type]=this._msgs[this._i%this._msgs.length];this._i++;
      AppState.addNotif(msg,type);
      Render.sNotifications();Render.notifBadge();
      Toast.show(msg,'info');
    },22000);
  },
  stop(){clearInterval(this._t);this._t=null;}
};

/* =========== FORMS =========== */
const Forms={
  submitChild(){
    const ok=V.f('cName',V.name,'cNameErr','Minimo 2 caracteres.')+
      V.f('cAge',V.age,'cAgeErr','Entre 3 e 18 anos.')+
      V.f('cSchool',V.str,'cSchoolErr','Insira o nome da escola.')+
      V.f('cAddress',V.addr,'cAddressErr','Endereco muito curto.');
    if(!ok)return;
    UI.spin(true);
    setTimeout(()=>{
      const c=AppState.addChild({name:g('cName').value.trim(),age:Number(g('cAge').value),gender:g('cGender').value,group:g('cGroup').value,school:g('cSchool').value.trim(),address:g('cAddress').value.trim(),emergency_contact:g('cEmergency').value.trim(),authorized:g('cAuthorized').value.trim(),medical_info:g('cMedical').value.trim()});
      AppState.addNotif(`${c.name} foi registada no servico.`,'pickup');
      UI.spin(false);UI.closeModal('childModal');Render.all();
      Toast.show(`${c.name} registada.`,'success');
    },450);
  },
  submitPayment(){
    const desc=g('pDesc').value.trim(),amt=g('pAmount').value;
    if(!desc||!amt){Toast.show('Preencha todos os campos.','error');return;}
    UI.spin(true);
    setTimeout(()=>{
      const p=DB.insert('payments',{id:DB.nextId('payments'),userId:AppState.user.id,description:desc,amount:Number(amt),status:g('pStatus').value,method:g('pMethod').value,createdAt:new Date().toISOString()});
      AppState.payments.unshift(p);
      if(p.status==='pending')AppState.addNotif(`Pagamento "${desc}" esta pendente.`,'payment');
      UI.spin(false);UI.closeModal('payModal');Render.sPayments();
      Toast.show('Pagamento registado.','success');
    },400);
  },
  submitDriver(){
    const name=g('drName').value.trim(),email=g('drEmail').value.trim(),pwd=g('drPwd').value;
    if(!name||!email||!pwd){Toast.show('Preencha os campos obrigatorios.','error');return;}
    if(!V.email(email)){Toast.show('Email invalido.','error');return;}
    if(!V.pwd(pwd)){Toast.show('Senha minimo 6 caracteres.','error');return;}
    UI.spin(true);
    setTimeout(()=>{
      try{
        Auth.register({name,email,password:pwd,phone:g('drPhone').value,role:'driver'});
        const u=DB.find('users',u=>u.email===email.toLowerCase());
        DB.update('users',u.id,{vehicle:g('drVehicle').value,license:g('drLicense').value,route:g('drRoute').value});
        UI.spin(false);UI.closeModal('driverModal');Render.sAdmin();
        Toast.show(`Motorista ${name} adicionado.`,'success');
      }catch(err){UI.spin(false);Toast.show(err.message,'error');}
    },450);
  }
};

/* =========== UI =========== */
const UI={
  showAuth(){
    g('authScreen').classList.add('active');g('authScreen').style.display='flex';
    g('appShell').classList.remove('active');g('appShell').style.display='none';
    g('loginForm')?.reset();g('loginAlert').innerHTML='';
  },
  authTab(tab){
    g('tabEntrar').classList.toggle('active',tab==='login');
    g('tabRegist').classList.toggle('active',tab==='register');
    g('loginPane').classList.toggle('active',tab==='login');
    g('registerPane').classList.toggle('active',tab==='register');
  },
  showApp(){
    g('authScreen').classList.remove('active');g('authScreen').style.display='none';
    g('appShell').classList.add('active');g('appShell').style.display='flex';
    const u=AppState.user;
    g('sUserAv').textContent=u.name[0];g('sUserName').textContent=u.name;
    const roles={parent:'Responsavel',driver:'Motorista',admin:'Administrador'};
    g('sUserRole').textContent=roles[u.role]||u.role;
    g('topbarAv').textContent=u.name[0];g('topbarName').textContent=u.name.split(' ')[0];
    this._buildNav(u.role);
    this.navTo('overview');
    setTimeout(()=>MapMod.init(),700);
    Realtime.start();
  },
  _buildNav(role){
    const items=NAVS[role]||NAVS.parent;
    g('sidebarNav').innerHTML='<div class="nav-group-label">Menu Principal</div>'+
      items.map(it=>`
        <div class="nav-item${it.id==='overview'?' active':''}" id="ni-${it.id}" onclick="UI.navTo('${it.id}',this)" role="button" tabindex="0">
          <div class="nav-ico-wrap">${ICO[it.ico]||''}</div>
          ${it.label}
          ${it.badge?`<span class="nav-badge" style="display:${AppState.unread()>0?'':'none'}">${AppState.unread()}</span>`:''}
        </div>`).join('');
  },
  navTo(id,el){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    const s=g('s-'+id);if(s)s.classList.add('active');
    const n=el||g('ni-'+id);if(n)n.classList.add('active');
    const titles={overview:'Visao Geral',children:'Criancas',tracking:'Rastreamento',notifications:'Notificacoes',payments:'Pagamentos',routes:'Rota do Dia',security:'Seguranca QR',admin:'Administracao'};
    if(g('topbarTitle'))g('topbarTitle').textContent=titles[id]||id;
    if(id==='tracking')setTimeout(()=>MapMod._m&&MapMod._m.invalidateSize(),200);
    if(id==='notifications'){AppState.notifs.forEach(n=>n.read=true);Render.notifBadge();}
    this.closeSidebar();
  },
  toggleSidebar(){
    g('sidebar').classList.toggle('mobile-open');
    g('sidebarOverlay').classList.toggle('active');
  },
  closeSidebar(){
    if(window.innerWidth<=900){
      g('sidebar').classList.remove('mobile-open');
      g('sidebarOverlay').classList.remove('active');
    }
  },
  toggleNotifDrawer(){
    g('notifDrawer').classList.toggle('open');
    AppState.notifs.forEach(n=>n.read=true);
    Render.sNotifications();Render.notifBadge();
  },
  openModal(id){
    g(id).classList.add('active');
    setTimeout(()=>{const f=g(id).querySelector('input');if(f)f.focus();},120);
  },
  closeModal(id){g(id).classList.remove('active')},
  spin(on){g('spinOv').classList.toggle('active',on)},
  showQR(childId){
    const c=AppState.children.find(x=>x.id===childId);
    if(!c)return;
    const msg='Crianca: '+c.name+'\nPIN: '+c.pin+'\nAutorizados: '+(c.authorized||'Nao definido');
    window.alert(msg);
  },
  alert(eid,msg,type){g(eid).innerHTML=`<div class="alert-box ${type}">${msg}</div>`;setTimeout(()=>{const e=g(eid);if(e)e.innerHTML=''},5500)}
};

const Toast={
  show(msg,type='info',ms=4000){
    const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;
    g('toasts').appendChild(el);
    setTimeout(()=>{el.style.animation='toastOut .25s ease forwards';setTimeout(()=>el.remove(),250)},ms);
  }
};

function g(id){return document.getElementById(id)}

/* =========== BOOT =========== */
document.addEventListener('DOMContentLoaded',()=>{
  DB.seed();

  /* Star field */
  const stars=g('authStars');
  for(let i=0;i<60;i++){
    const s=document.createElement('div');
    s.className='star';
    const sz=Math.random()*2.5+.8;
    Object.assign(s.style,{width:sz+'px',height:sz+'px',top:Math.random()*70+'%',left:Math.random()*100+'%',animationDuration:(Math.random()*3+2)+'s',animationDelay:Math.random()*4+'s'});
    stars.appendChild(s);
  }

  /* Hamburger visibility */
  const mq=window.matchMedia('(max-width:900px)');
  const setHam=()=>{const h=g('hamburger');if(h)h.style.display=mq.matches?'flex':'none'};
  mq.addEventListener('change',setHam);setHam();

  /* LOGIN */
  g('loginForm').addEventListener('submit',e=>{
    e.preventDefault();
    const em=g('lEmail').value,pw=g('lPwd').value;
    let ok=true;
    if(!V.email(em)){g('lEmailErr').textContent='Email invalido.';g('lEmail').classList.add('invalid');ok=false;}
    if(!V.pwd(pw)){g('lPwdErr').textContent='Minimo 6 caracteres.';g('lPwd').classList.add('invalid');ok=false;}
    if(!ok)return;
    UI.spin(true);
    setTimeout(()=>{
      try{
        const u=Auth.login(em,pw);AppState.load();
        UI.spin(false);UI.showApp();Render.all();
        Toast.show(`Bem-vindo, ${u.name.split(' ')[0]}.`,'success');
      }catch(err){UI.spin(false);UI.alert('loginAlert',err.message,'error');}
    },500);
  });

  /* REGISTER */
  g('registerForm').addEventListener('submit',e=>{
    e.preventDefault();
    const a=V.f('rName',V.name,'rNameErr','Minimo 2 caracteres.');
    const b=V.f('rEmail',V.email,'rEmailErr','Email invalido.');
    const c=V.f('rPwd',V.pwd,'rPwdErr','Minimo 6 caracteres.');
    if(!a||!b||!c)return;
    UI.spin(true);
    setTimeout(()=>{
      try{
        Auth.register({name:g('rName').value,email:g('rEmail').value,phone:g('rPhone').value,password:g('rPwd').value,role:g('rRole').value});
        UI.spin(false);UI.alert('registerAlert','Conta criada. Pode fazer login agora.','success');
        setTimeout(()=>UI.authTab('login'),1800);
      }catch(err){UI.spin(false);UI.alert('registerAlert',err.message,'error');}
    },500);
  });

  /* Live validation */
  V.live('lEmail',V.email,'lEmailErr','Email invalido.');
  V.live('lPwd',V.pwd,'lPwdErr','Minimo 6 caracteres.');
  V.live('rName',V.name,'rNameErr','Minimo 2 caracteres.');
  V.live('rEmail',V.email,'rEmailErr','Email invalido.');
  V.live('rPwd',V.pwd,'rPwdErr','Minimo 6 caracteres.');

  /* Modal backdrop close + ESC */
  document.querySelectorAll('.modal-ov').forEach(m=>{
    m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active')});
  });
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
      document.querySelectorAll('.modal-ov.active').forEach(m=>m.classList.remove('active'));
      g('notifDrawer').classList.remove('open');
    }
  });

  /* Notif drawer close on outside click */
  document.addEventListener('click',e=>{
    const d=g('notifDrawer'),t=e.target.closest('.notif-trigger');
    if(!t&&d?.classList.contains('open')&&!d.contains(e.target))d.classList.remove('open');
  });

  /* Restore session */
  if(Session.active()&&AppState.load()){UI.showApp();Render.all();}
  else{Session.clear();UI.showAuth();}
});
</script>
</body>
</html>
