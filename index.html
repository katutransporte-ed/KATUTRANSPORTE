<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#0B2447"/>
<title>Katutransporte</title>
<link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --navy:#0B1D35;--navy2:#162847;--blue:#1A56DB;--blue-l:#3B82F6;--blue-gl:#EFF6FF;
  --orange:#F05A28;--orange-l:#FB7948;--orange-pale:#FFF2EE;
  --teal:#0D9488;--teal-l:#14B8A6;--teal-pale:#F0FDFA;
  --violet:#6D28D9;--violet-l:#8B5CF6;--violet-pale:#F5F3FF;
  --green:#059669;--green-l:#10B981;--green-pale:#ECFDF5;
  --red:#DC2626;--amber:#D97706;
  --white:#fff;
  --bg:#F0F4FA;--surface:#fff;--surface2:#F8FAFF;
  --border:#E2E8F4;--border2:#EEF2FA;
  --txt:#0B1929;--muted:#64748B;--light:#94A3B8;
  --sh0:0 1px 3px rgba(11,29,53,.06);
  --sh1:0 4px 12px rgba(11,29,53,.10);
  --sh2:0 12px 32px rgba(11,29,53,.14);
  --sh3:0 24px 56px rgba(11,29,53,.18);
  --r:12px;--rm:16px;--rl:22px;
  --ease:cubic-bezier(.4,0,.2,1);
  --spring:cubic-bezier(.34,1.56,.64,1);
  --bottom-nav-h:68px;
  --safe-b:env(safe-area-inset-bottom,0px);
  --safe-t:env(safe-area-inset-top,0px);
}
html{scroll-behavior:smooth}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);color:var(--txt);
  min-height:100vh;overflow-x:hidden;
  font-size:15px;line-height:1.5;
  -webkit-font-smoothing:antialiased;
}
h1,h2,h3,h4,h5{font-family:'Clash Display',sans-serif;line-height:1.2;letter-spacing:-.01em}
input,select,textarea,button{font-family:'DM Sans',sans-serif}
:focus-visible{outline:2px solid var(--blue-l);outline-offset:2px;border-radius:6px}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}
.hidden{display:none!important}

/* ══════ AUTH SCREEN ══════ */
.auth-screen{
  min-height:100vh;min-height:100dvh;
  display:none;flex-direction:column;
  background:var(--navy);position:relative;overflow:hidden;
}
.auth-screen.active{display:flex}

/* Animated background */
.auth-bg{
  position:absolute;inset:0;z-index:0;
  background:radial-gradient(ellipse 80% 60% at 20% -10%,#1e3a5f 0%,transparent 60%),
             radial-gradient(ellipse 60% 50% at 80% 110%,rgba(240,90,40,.2) 0%,transparent 60%),
             linear-gradient(170deg,#0B1D35 0%,#0e2241 40%,#112a50 100%);
}
.auth-orb{
  position:absolute;border-radius:50%;filter:blur(60px);opacity:.5;z-index:1;
  animation:orbFloat 8s ease-in-out infinite;
}
.auth-orb1{width:400px;height:400px;background:radial-gradient(circle,#1A56DB,transparent 70%);top:-150px;right:-100px;animation-delay:0s}
.auth-orb2{width:300px;height:300px;background:radial-gradient(circle,#F05A28,transparent 70%);bottom:-50px;left:-80px;animation-delay:-4s}
@keyframes orbFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

/* Noise texture overlay */
.auth-noise{
  position:absolute;inset:0;z-index:2;opacity:.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
}

/* Stars */
.star{position:absolute;background:#fff;border-radius:50%;animation:twinkle ease-in-out infinite}
@keyframes twinkle{0%,100%{opacity:.15;transform:scale(1)}50%{opacity:.7;transform:scale(1.3)}}

/* Road scene at bottom */
.auth-road-scene{position:absolute;bottom:0;left:0;right:0;z-index:3;height:180px;pointer-events:none}

/* Feature pills */
.auth-pills{
  position:relative;z-index:10;
  display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;
  padding:calc(var(--safe-t) + 1.2rem) 1.2rem .8rem;
  flex-shrink:0;
}
.auth-pill{
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
  border-radius:50px;padding:.38rem .9rem;
  font-size:.73rem;color:rgba(255,255,255,.8);font-weight:500;
  backdrop-filter:blur(10px);display:flex;align-items:center;gap:.45rem;
  white-space:nowrap;
}
.sd{display:inline-block;width:7px;height:7px;border-radius:50%;flex-shrink:0}
.sd-g{background:#4ADE80;box-shadow:0 0 0 3px rgba(74,222,128,.2)}
.sd-a{background:#FB923C;box-shadow:0 0 0 3px rgba(251,146,60,.2)}

/* Auth Card */
.auth-card-wrap{
  position:relative;z-index:10;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;flex:1;padding:1rem 1rem;
  padding-bottom:calc(1rem + var(--safe-b));
}
.auth-card{
  background:rgba(255,255,255,.97);
  border-radius:28px;width:100%;max-width:420px;
  box-shadow:0 32px 80px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.1);
  overflow:hidden;backdrop-filter:blur(20px);
  animation:cardRise .55s var(--spring) both;
}
@keyframes cardRise{from{opacity:0;transform:translateY(40px) scale(.94)}to{opacity:1;transform:none}}

/* Card header */
.auth-card-header{
  padding:1.5rem 1.5rem 1.2rem;
  background:linear-gradient(145deg,var(--navy),#1A3660);
  position:relative;overflow:hidden;
}
.auth-card-header::before{
  content:'';position:absolute;inset:0;
  background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);
  background-size:20px 20px;
}
.auth-header-top{
  position:relative;z-index:1;
  display:flex;align-items:center;gap:.85rem;margin-bottom:1.2rem;
}
.auth-logo-badge{
  width:46px;height:46px;border-radius:14px;flex-shrink:0;
  background:linear-gradient(135deg,var(--orange),var(--orange-l));
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 20px rgba(240,90,40,.45);
}
.auth-logo-text h1{font-size:1.2rem;color:#fff;font-weight:700;line-height:1;font-family:'Clash Display',sans-serif}
.auth-logo-text p{font-size:.68rem;color:rgba(255,255,255,.45);letter-spacing:.1em;text-transform:uppercase;margin-top:.15rem}

/* Mini scene in header */
.auth-mini-scene{position:relative;z-index:1;height:55px;overflow:hidden}

/* Body */
.auth-card-body{padding:1.5rem}
.auth-tabs{display:flex;background:var(--bg);border-radius:12px;padding:3px;margin-bottom:1.5rem;gap:3px}
.auth-tab-btn{
  flex:1;padding:.6rem;border:none;background:transparent;
  border-radius:10px;font-size:.84rem;font-weight:600;
  cursor:pointer;transition:all .22s;color:var(--muted);
  font-family:'DM Sans',sans-serif;
}
.auth-tab-btn.active{background:#fff;color:var(--navy);box-shadow:var(--sh0)}
.auth-form-pane{display:none}.auth-form-pane.active{display:block}

/* Form elements */
.form-group{margin-bottom:.9rem}
.form-label{
  display:block;font-size:.75rem;font-weight:600;
  color:var(--txt);margin-bottom:.35rem;letter-spacing:.02em;
}
.form-input{
  width:100%;padding:.78rem 1.05rem;border:2px solid var(--border);
  border-radius:12px;font-size:.92rem;background:#fff;
  color:var(--txt);transition:all .18s;font-family:'DM Sans',sans-serif;
  -webkit-appearance:none;appearance:none;
}
.form-input:focus{outline:none;border-color:var(--blue-l);box-shadow:0 0 0 4px rgba(59,130,246,.12)}
.form-input.invalid{border-color:var(--red)}
.form-input.valid{border-color:var(--green)}
.field-err{font-size:.72rem;color:var(--red);margin-top:.22rem;display:block;min-height:15px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
select.form-input{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='7'%3E%3Cpath fill='%2364748B' d='M5.5 7L0 0h11z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 1rem center;
  padding-right:2.5rem;cursor:pointer;
}
textarea.form-input{resize:vertical;min-height:80px}

/* Buttons */
.btn{
  padding:.76rem 1.4rem;border:none;border-radius:12px;
  font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:600;
  cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;
  gap:.5rem;position:relative;overflow:hidden;letter-spacing:.01em;
  white-space:nowrap;user-select:none;
}
.btn:active:not(:disabled){transform:scale(.96)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{
  background:linear-gradient(135deg,var(--navy),var(--blue));
  color:#fff;box-shadow:0 4px 16px rgba(26,86,219,.32);
}
.btn-primary:hover:not(:disabled){box-shadow:0 6px 24px rgba(26,86,219,.42);transform:translateY(-1px)}
.btn-orange{
  background:linear-gradient(135deg,var(--orange),var(--orange-l));
  color:#fff;box-shadow:0 4px 16px rgba(240,90,40,.32);
}
.btn-orange:hover:not(:disabled){box-shadow:0 6px 24px rgba(240,90,40,.42);transform:translateY(-1px)}
.btn-teal{background:linear-gradient(135deg,var(--teal),var(--teal-l));color:#fff;box-shadow:0 4px 12px rgba(13,148,136,.28)}
.btn-teal:hover:not(:disabled){transform:translateY(-1px)}
.btn-outline{background:transparent;color:var(--navy);border:2px solid var(--border)}
.btn-outline:hover:not(:disabled){border-color:var(--blue-l);background:var(--blue-gl)}
.btn-ghost{background:transparent;color:var(--muted);border:none}
.btn-ghost:hover:not(:disabled){background:var(--bg);color:var(--txt)}
.btn-sm{padding:.44rem .9rem;font-size:.78rem;border-radius:9px}
.btn-lg{padding:.88rem 1.8rem;font-size:.94rem;border-radius:14px}
.btn-block{width:100%;justify-content:center}

/* Alert boxes */
.alert-box{
  padding:.78rem 1rem;border-radius:12px;margin-bottom:.9rem;
  border:1px solid;font-size:.82rem;font-weight:500;
  display:flex;align-items:center;gap:.55rem;animation:fadeUp .22s ease;
}
.alert-box.success{background:var(--green-pale);color:#065F46;border-color:#A7F3D0}
.alert-box.error{background:#FEF2F2;color:#991B1B;border-color:#FECACA}
.alert-box.info{background:var(--blue-gl);color:#1E3A8A;border-color:#BFDBFE}
@keyframes fadeUp{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}

/* ══════ APP SHELL ══════ */
.app{display:none;flex-direction:column;min-height:100vh;min-height:100dvh}
.app.active{display:flex}

/* Top header */
.app-topbar{
  position:fixed;top:0;left:0;right:0;z-index:200;
  background:rgba(11,29,53,.96);backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border-bottom:1px solid rgba(255,255,255,.08);
  padding:calc(var(--safe-t) + .6rem) 1.1rem .6rem;
  display:flex;align-items:center;gap:.7rem;
}
.app-logo{display:flex;align-items:center;gap:.6rem}
.app-logo-badge{
  width:34px;height:34px;border-radius:10px;flex-shrink:0;
  background:linear-gradient(135deg,var(--orange),var(--orange-l));
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 3px 12px rgba(240,90,40,.4);
}
.app-logo-text{font-family:'Clash Display',sans-serif;font-size:1rem;font-weight:600;color:#fff;letter-spacing:-.01em}
.app-topbar-mid{flex:1}
.page-title{
  font-family:'Clash Display',sans-serif;font-size:1rem;
  font-weight:600;color:#fff;letter-spacing:-.01em;
}
.app-topbar-actions{display:flex;align-items:center;gap:.45rem}
.icon-btn{
  width:38px;height:38px;border-radius:11px;border:none;
  background:rgba(255,255,255,.1);color:rgba(255,255,255,.75);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  transition:all .18s;flex-shrink:0;position:relative;
}
.icon-btn:active{transform:scale(.9);background:rgba(255,255,255,.18)}
.icon-btn:hover{background:rgba(255,255,255,.16);color:#fff}
.notif-pip{
  position:absolute;top:-4px;right:-4px;width:17px;height:17px;
  background:var(--orange);border-radius:50%;border:2px solid var(--navy);
  display:flex;align-items:center;justify-content:center;
  font-size:.52rem;font-weight:700;color:#fff;
}

/* Avatar */
.user-av{
  width:34px;height:34px;border-radius:50%;
  background:linear-gradient(135deg,var(--orange),var(--violet-l,#8B5CF6));
  color:#fff;font-weight:700;font-size:.84rem;
  display:flex;align-items:center;justify-content:center;
  border:2px solid rgba(255,255,255,.25);cursor:pointer;
  transition:all .18s;flex-shrink:0;
}
.user-av:active{transform:scale(.9)}

/* Main content area */
.main-content{
  flex:1;
  padding-top:calc(var(--safe-t) + 58px);
  padding-bottom:calc(var(--bottom-nav-h) + var(--safe-b) + .5rem);
  overflow-y:auto;overflow-x:hidden;
}

/* ══════ BOTTOM NAV ══════ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:rgba(255,255,255,.95);backdrop-filter:blur(24px) saturate(200%);
  -webkit-backdrop-filter:blur(24px) saturate(200%);
  border-top:1px solid rgba(0,0,0,.06);
  padding:.6rem 0 calc(.6rem + var(--safe-b));
  display:flex;align-items:stretch;justify-content:space-around;
  box-shadow:0 -4px 24px rgba(11,29,53,.08);
}
.nav-btn{
  display:flex;flex-direction:column;align-items:center;
  gap:.2rem;padding:.3rem .8rem;border:none;background:transparent;
  cursor:pointer;border-radius:12px;transition:all .18s;
  font-family:'DM Sans',sans-serif;min-width:52px;position:relative;
}
.nav-btn:active{transform:scale(.9)}
.nav-icon{
  width:26px;height:26px;display:flex;align-items:center;justify-content:center;
  border-radius:10px;transition:all .22s;position:relative;
}
.nav-icon svg{transition:all .22s}
.nav-btn.active .nav-icon{
  background:var(--navy);
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(11,29,53,.25);
}
.nav-btn.active .nav-icon svg{stroke:#fff}
.nav-label{font-size:.62rem;font-weight:500;color:var(--light);transition:all .2s;line-height:1}
.nav-btn.active .nav-label{color:var(--navy);font-weight:700}
.nav-ico-color{stroke:var(--light)}
.nav-badge{
  position:absolute;top:-4px;right:-4px;
  width:16px;height:16px;background:var(--orange);
  border-radius:50%;border:2px solid #fff;
  display:flex;align-items:center;justify-content:center;
  font-size:.52rem;font-weight:700;color:#fff;
}

/* ══════ SECTIONS ══════ */
.section{display:none;animation:sectionIn .25s var(--ease) both}
.section.active{display:block}
@keyframes sectionIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.page-body{padding:.9rem 1rem 1rem}

/* Pull indicator */
.pull-indicator{
  text-align:center;padding:.5rem;font-size:.72rem;color:var(--light);
  display:flex;align-items:center;justify-content:center;gap:.4rem;
}

/* ══════ HERO STRIPS ══════ */
.page-hero{
  margin:.9rem 1rem;border-radius:20px;padding:1.4rem 1.5rem;
  position:relative;overflow:hidden;color:#fff;
}
.page-hero-bg{position:absolute;inset:0;z-index:0}
.page-hero-dots{
  position:absolute;inset:0;
  background-image:radial-gradient(rgba(255,255,255,.08) 1px,transparent 1px);
  background-size:20px 20px;z-index:1;
}
.page-hero-content{position:relative;z-index:2}
.page-hero h2{font-size:1.3rem;font-weight:700;margin-bottom:.2rem}
.page-hero p{font-size:.8rem;opacity:.75;line-height:1.6;max-width:280px}

/* ══════ STATS GRID ══════ */
.stats-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:.7rem;padding:0 1rem;margin-bottom:.9rem;
}
.stat-card{
  background:#fff;border-radius:16px;padding:1.1rem;
  border:1px solid var(--border2);box-shadow:var(--sh0);
  position:relative;overflow:hidden;transition:all .18s;
}
.stat-card:active{transform:scale(.97)}
.stat-glow{
  position:absolute;top:-20px;right:-20px;width:80px;height:80px;
  border-radius:50%;filter:blur(30px);opacity:.45;pointer-events:none;
}
.stat-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.55rem}
.stat-label{font-size:.68rem;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);font-weight:600}
.stat-ico{
  width:32px;height:32px;border-radius:9px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.stat-val{font-family:'Clash Display',sans-serif;font-size:1.7rem;font-weight:700;color:var(--txt);line-height:1}
.stat-sub{font-size:.7rem;color:var(--light);margin-top:.25rem}

/* ══════ PANELS ══════ */
.panel{
  background:#fff;border-radius:18px;border:1px solid var(--border2);
  box-shadow:var(--sh0);margin:0 1rem .8rem;overflow:hidden;
}
.panel-head{
  display:flex;justify-content:space-between;align-items:center;
  padding:.9rem 1.2rem;border-bottom:1px solid var(--border2);
}
.panel-head h3{font-size:.92rem;font-family:'Clash Display',sans-serif;font-weight:600}
.panel-body{padding:1.2rem}
.panel-body.np{padding:0}
.panel-al{border-left:3px solid var(--orange)}
.panel-at{border-left:3px solid var(--teal)}
.panel-av{border-left:3px solid var(--violet)}
.panel-ab{border-left:3px solid var(--blue-l)}

/* ══════ LIST ITEMS ══════ */
.list-item{
  display:flex;align-items:center;gap:.8rem;
  padding:.9rem 1.2rem;border-bottom:1px solid var(--border2);
  transition:background .15s;cursor:default;
}
.list-item:last-child{border-bottom:none}
.list-item:active{background:var(--surface2)}
.li-av{
  width:44px;height:44px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:.95rem;flex-shrink:0;
  border:2px solid rgba(255,255,255,.7);
}
.li-info{flex:1;min-width:0}
.li-name{font-size:.9rem;font-weight:600;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-meta{font-size:.74rem;color:var(--muted);margin-top:.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-actions{display:flex;align-items:center;gap:.4rem;flex-shrink:0}

/* ══════ BADGES ══════ */
.badge{
  padding:.22rem .65rem;border-radius:6px;
  font-size:.68rem;font-weight:700;letter-spacing:.04em;
  text-transform:uppercase;white-space:nowrap;display:inline-block;
}
.b-waiting{background:#FFF7ED;color:#C2410C;border:1px solid #FED7AA}
.b-picked{background:#F0FDF4;color:#166534;border:1px solid #BBF7D0}
.b-transit{background:#EFF6FF;color:#1D4ED8;border:1px solid #BFDBFE}
.b-delivered{background:#F0FDF4;color:#166534;border:1px solid #BBF7D0}
.b-paid{background:#F0FDF4;color:#166534;border:1px solid #BBF7D0}
.b-pending{background:#FEF2F2;color:#991B1B;border:1px solid #FECACA}
.b-info{background:#EFF6FF;color:#1D4ED8;border:1px solid #BFDBFE}
.b-teal{background:#F0FDFA;color:#0F766E;border:1px solid #99F6E4}
.b-navy{background:var(--navy);color:#fff;border:1px solid transparent}
.b-violet{background:#F5F3FF;color:#5B21B6;border:1px solid #DDD6FE}

/* ══════ NOTIF ITEMS ══════ */
.notif-item{
  display:flex;align-items:flex-start;gap:.75rem;
  padding:.95rem 1.2rem;border-bottom:1px solid var(--border2);
  transition:background .15s;
}
.notif-item:last-child{border-bottom:none}
.notif-item.unread{background:linear-gradient(90deg,#FFF7F4,#fff);border-left:3px solid var(--orange)}
.notif-ico-wrap{
  width:34px;height:34px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:.05rem;
}
.notif-time{font-size:.68rem;color:var(--light);margin-bottom:.18rem;display:flex;align-items:center;gap:.4rem}
.notif-msg{font-size:.82rem;color:var(--txt);line-height:1.55;font-weight:500}

/* ══════ MAP ══════ */
#map{height:280px;border-radius:14px;overflow:hidden;z-index:1}
.map-legend{display:flex;gap:1rem;margin-top:.65rem;flex-wrap:wrap;padding:0 .2rem}
.legend-item{display:flex;align-items:center;gap:.4rem;font-size:.73rem;color:var(--muted);font-weight:500}
.legend-dot{width:9px;height:9px;border-radius:50%}

/* ══════ MODAL (bottom sheet on mobile) ══════ */
.modal-ov{
  display:none;position:fixed;inset:0;
  background:rgba(11,29,53,.6);z-index:1000;
  align-items:flex-end;justify-content:center;
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  padding:0;
}
.modal-ov.active{display:flex}
.modal-box{
  background:#fff;border-radius:24px 24px 0 0;
  width:100%;max-width:600px;
  max-height:92vh;overflow-y:auto;
  box-shadow:0 -8px 48px rgba(11,29,53,.2);
  animation:sheetUp .3s var(--spring) both;
  padding-bottom:var(--safe-b);
}
@keyframes sheetUp{from{transform:translateY(100%);opacity:.5}to{transform:none;opacity:1}}
.modal-handle{
  width:40px;height:4px;background:var(--border);
  border-radius:50px;margin:12px auto 4px;
}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1.4rem .6rem}
.modal-head h3{font-size:1rem;font-family:'Clash Display',sans-serif;font-weight:600}
.modal-close-btn{
  width:32px;height:32px;border-radius:50%;background:var(--bg);
  border:none;cursor:pointer;color:var(--muted);font-size:1.1rem;
  display:flex;align-items:center;justify-content:center;transition:all .18s;
}
.modal-close-btn:active{transform:scale(.88)}
.modal-body{padding:.4rem 1.4rem 1rem}
.modal-foot{
  padding:.8rem 1.4rem 1rem;border-top:1px solid var(--border);
  display:flex;justify-content:flex-end;gap:.6rem;
  background:var(--surface2);
}

/* ══════ NOTIF DRAWER ══════ */
.notif-drawer{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:#fff;z-index:500;
  transform:translateY(100%);transition:transform .32s var(--spring);
  display:flex;flex-direction:column;
  padding-top:var(--safe-t);
  padding-bottom:var(--safe-b);
}
.notif-drawer.open{transform:none}
.notif-drawer-head{
  padding:1rem 1.2rem;border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,var(--navy),var(--navy2));
  display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.notif-drawer-head h3{font-family:'Clash Display',sans-serif;font-size:.95rem;font-weight:600;color:#fff}
.notif-scroll{overflow-y:auto;flex:1;padding-bottom:1rem}

/* ══════ QUEUE / ROUTE ══════ */
.queue-item{
  border:1px solid var(--border2);border-radius:14px;
  padding:.95rem 1.1rem;margin:0 1rem .65rem;
  background:#fff;transition:all .18s;position:relative;overflow:hidden;
}
.queue-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--orange);border-radius:0}
.queue-item:active{transform:scale(.98)}
.queue-item.done::before{background:var(--green)}
.queue-item.done{opacity:.65}
.queue-num{
  width:30px;height:30px;border-radius:50%;
  background:linear-gradient(135deg,var(--navy),var(--blue));
  color:#fff;font-weight:700;font-size:.8rem;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;box-shadow:0 2px 8px rgba(26,86,219,.28);
}

/* ══════ PAYMENTS ══════ */
.pay-card{
  border-bottom:1px solid var(--border2);padding:1rem 1.2rem;
  display:flex;justify-content:space-between;align-items:center;
  background:#fff;transition:background .15s;
}
.pay-card:last-child{border-bottom:none}
.pay-card:active{background:var(--surface2)}
.pay-desc h4{font-size:.88rem;font-weight:600;margin-bottom:.12rem}
.pay-desc p{font-size:.73rem;color:var(--muted)}
.pay-val{font-family:'Clash Display',sans-serif;font-size:1.05rem;font-weight:700;text-align:right}

/* Finance cards */
.finance-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;padding:0 1rem;margin-bottom:.8rem}
.fin-card{padding:1rem 1.1rem;border-radius:14px;border:1px solid var(--border2);background:#fff;position:relative;overflow:hidden}
.fin-card-bar{position:absolute;top:0;left:0;right:0;height:3px}
.fin-label{font-size:.68rem;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);font-weight:600;margin-bottom:.5rem}
.fin-amount{font-family:'Clash Display',sans-serif;font-size:1.3rem;font-weight:700}

/* Progress bar */
.prog-bar{height:6px;background:var(--border);border-radius:50px;overflow:hidden;margin:.4rem 0}
.prog-fill{height:100%;border-radius:50px;transition:width 1s ease}
.pf-blue{background:linear-gradient(90deg,var(--blue),var(--blue-l))}
.pf-orange{background:linear-gradient(90deg,var(--orange),var(--orange-l))}
.pf-teal{background:linear-gradient(90deg,var(--teal),var(--teal-l))}
.pf-green{background:linear-gradient(90deg,var(--green),var(--green-l))}

/* QR cards */
.qr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.8rem}
.qr-card{border:1px solid var(--border2);border-radius:16px;padding:1.1rem .9rem;text-align:center;background:#fff;transition:all .18s}
.qr-card:active{transform:scale(.97)}
.qr-vis{width:100px;height:100px;margin:.6rem auto;border-radius:10px;display:flex;align-items:center;justify-content:center;border:1.5px dashed var(--border);background:var(--surface2);flex-direction:column;gap:.15rem}

/* Spinner */
.spin-ov{display:none;position:fixed;inset:0;background:rgba(255,255,255,.85);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.spin-ov.active{display:flex}
.spinner{width:42px;height:42px;border:3px solid var(--border);border-top-color:var(--blue-l);border-radius:50%;animation:spin .65s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toasts */
#toasts{position:fixed;bottom:calc(var(--bottom-nav-h) + var(--safe-b) + .8rem);left:1rem;right:1rem;z-index:3000;display:flex;flex-direction:column;gap:.4rem;pointer-events:none}
.toast{
  padding:.75rem 1.1rem;border-radius:14px;font-size:.82rem;font-weight:600;
  box-shadow:0 4px 20px rgba(0,0,0,.15);
  animation:toastIn .28s var(--spring);border:1px solid;
  display:flex;align-items:center;gap:.55rem;
  pointer-events:auto;
}
@keyframes toastIn{from{opacity:0;transform:translateY(20px) scale(.92)}to{opacity:1;transform:none}}
@keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateY(10px) scale(.96)}}
.toast.success{background:#F0FDF4;color:#166534;border-color:#BBF7D0}
.toast.error{background:#FEF2F2;color:#991B1B;border-color:#FECACA}
.toast.info{background:#EFF6FF;color:#1E3A8A;border-color:#BFDBFE}

/* Utilities */
.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}
.gap-s{gap:.4rem}.gap-m{gap:.8rem}
.mt-s{margin-top:.5rem}.mt-m{margin-top:.9rem}.mt-l{margin-top:1.4rem}
.mb-s{margin-bottom:.5rem}.mb-m{margin-bottom:.9rem}
.text-r{text-align:right}.text-c{text-align:center}
.text-muted{color:var(--muted)}.text-sm{font-size:.75rem}
.sec-label{font-size:.68rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:700;margin-bottom:.7rem;font-family:'Clash Display',sans-serif}
.divider{border:none;border-top:1px solid var(--border);margin:.9rem 0}
.chip{display:inline-flex;align-items:center;gap:.35rem;background:var(--surface2);border:1px solid var(--border2);border-radius:50px;padding:.2rem .7rem;font-size:.72rem;font-weight:600;color:var(--muted)}

/* Empty state */
.empty-state{text-align:center;padding:3rem 1.5rem}
.empty-state h4{font-size:.95rem;color:var(--txt);margin-bottom:.35rem;font-family:'Clash Display',sans-serif;font-weight:600}
.empty-state p{font-size:.8rem;color:var(--muted);max-width:230px;margin:0 auto .9rem;line-height:1.6}

/* ══════ CHAT ══════ */
.conv-list{flex:1;overflow-y:auto;background:#fff}
.conv-item{
  display:flex;align-items:center;gap:.85rem;
  padding:.9rem 1.1rem;border-bottom:1px solid var(--border2);
  cursor:pointer;transition:background .15s;position:relative;background:#fff;
}
.conv-item:active{background:var(--surface2)}
.conv-item.unread-conv{background:linear-gradient(90deg,#F0F6FF,#fff)}
.conv-av{
  width:50px;height:50px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:1rem;color:#fff;
  border:2.5px solid rgba(255,255,255,.7);position:relative;
}
.conv-online{
  position:absolute;bottom:1px;right:1px;width:12px;height:12px;
  background:#4ADE80;border-radius:50%;border:2px solid #fff;
}
.conv-info{flex:1;min-width:0}
.conv-name{font-size:.9rem;font-weight:700;color:var(--txt);margin-bottom:.15rem}
.conv-preview{font-size:.77rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv-preview.bold-p{color:var(--txt);font-weight:600}
.conv-meta{display:flex;flex-direction:column;align-items:flex-end;gap:.3rem;flex-shrink:0}
.conv-time{font-size:.67rem;color:var(--light)}
.conv-badge{
  min-width:20px;height:20px;background:var(--orange);padding:0 4px;
  border-radius:50px;display:flex;align-items:center;justify-content:center;
  font-size:.6rem;font-weight:800;color:#fff;
}
.chat-group-label{
  font-size:.67rem;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:.1em;
  padding:.75rem 1.1rem .3rem;background:var(--bg);
}

/* Message view — full screen overlay */
.msg-view{
  display:none;flex-direction:column;
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:var(--bg);z-index:450;
}
.msg-view.open{display:flex;animation:slideInMsg .28s var(--ease) both}
@keyframes slideInMsg{from{transform:translateX(100%)}to{transform:none}}

.msg-topbar{
  background:rgba(11,29,53,.97);backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  padding:calc(var(--safe-t) + .55rem) 1rem .55rem;
  display:flex;align-items:center;gap:.75rem;flex-shrink:0;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.msg-back{
  width:36px;height:36px;border-radius:10px;border:none;
  background:rgba(255,255,255,.1);color:#fff;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0;transition:all .15s;
}
.msg-back:active{transform:scale(.88);background:rgba(255,255,255,.18)}
.msg-contact-av{
  width:38px;height:38px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:.88rem;color:#fff;
  border:2px solid rgba(255,255,255,.25);
}
.msg-contact-info{flex:1;min-width:0}
.msg-contact-name{font-size:.92rem;font-weight:700;color:#fff;font-family:'Clash Display',sans-serif;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.msg-contact-status{font-size:.67rem;color:rgba(255,255,255,.5);display:flex;align-items:center;gap:.3rem;margin-top:.1rem}

/* Chat wallpaper */
.msg-body{
  flex:1;overflow-y:auto;padding:.9rem 1rem;
  background:#E8EFF9;
  display:flex;flex-direction:column;gap:.5rem;
  position:relative;
}
.msg-body::before{
  content:'';position:absolute;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg width='52' height='52' viewBox='0 0 52 52' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 10c0-2.21 1.79-4 4-4 .34 0 .67.04 1 .13C15.79 3.36 18.72 2 22 2c4.41 0 8 3.59 8 8v2h2c3.31 0 6 2.69 6 6 0 .36-.04.71-.1 1.05C40.27 20.51 42 23.08 42 26c0 4.41-3.59 8-8 8h-2v2c0 3.31-2.69 6-6 6-1.8 0-3.41-.8-4.53-2.06C20.72 41.24 18.43 42 16 42c-4.41 0-8-3.59-8-8v-2H6c-3.31 0-6-2.69-6-6 0-1.53.57-2.92 1.5-3.98C.85 21.05.5 20.07.5 19 .5 14.86 3.55 11.5 7.5 11.5c.9 0 1.76.18 2.5.5V10z' fill='%23c4cedf' fill-opacity='0.12' fill-rule='evenodd'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;
}
.msg-body>*{position:relative;z-index:1}

.msg-date-div{text-align:center;margin:.4rem 0}
.msg-date-div span{
  background:rgba(148,163,184,.25);backdrop-filter:blur(6px);
  color:#475569;font-size:.67rem;font-weight:600;
  padding:.22rem .75rem;border-radius:50px;
}

.bubble-row{display:flex;align-items:flex-end;gap:.45rem}
.bubble-row.sent{flex-direction:row-reverse}
.bubble-av-sm{
  width:26px;height:26px;border-radius:50%;flex-shrink:0;margin-bottom:2px;
  display:flex;align-items:center;justify-content:center;
  font-size:.6rem;font-weight:700;color:#fff;
}
.bubble{
  max-width:72%;padding:.58rem .82rem;border-radius:18px;
  font-size:.84rem;line-height:1.55;word-break:break-word;
  box-shadow:0 1px 3px rgba(0,0,0,.1);
}
.bubble.received{background:#fff;color:var(--txt);border-bottom-left-radius:5px}
.bubble.sent{background:linear-gradient(135deg,#0B1D35,#1A3A7E);color:#fff;border-bottom-right-radius:5px}
.bubble-sender{font-size:.67rem;font-weight:700;margin-bottom:.2rem;opacity:.7}
.bubble-time{font-size:.61rem;opacity:.5;margin-top:.28rem;display:flex;align-items:center;gap:.25rem}
.bubble.sent .bubble-time{justify-content:flex-end}

/* Typing */
.typing-row{display:flex;align-items:flex-end;gap:.45rem}
.typing-bubble{
  display:flex;align-items:center;gap:4px;
  padding:.6rem .85rem;background:#fff;border-radius:18px;
  border-bottom-left-radius:5px;box-shadow:0 1px 3px rgba(0,0,0,.1);
}
.typing-dot{width:7px;height:7px;border-radius:50%;background:var(--light);animation:typeDot 1.2s ease-in-out infinite}
.typing-dot:nth-child(2){animation-delay:.18s}
.typing-dot:nth-child(3){animation-delay:.36s}
@keyframes typeDot{0%,60%,100%{transform:translateY(0);opacity:.35}30%{transform:translateY(-6px);opacity:1}}

/* Input */
.msg-input-bar{
  padding:.6rem 1rem calc(.6rem + var(--safe-b));
  background:#fff;border-top:1px solid var(--border);
  display:flex;align-items:flex-end;gap:.55rem;flex-shrink:0;
}
.msg-input{
  flex:1;padding:.68rem 1rem;border:1.5px solid var(--border);
  border-radius:22px;font-size:.87rem;background:var(--bg);
  color:var(--txt);font-family:'DM Sans',sans-serif;
  resize:none;max-height:110px;line-height:1.4;
  transition:border-color .15s;outline:none;overflow:hidden;
}
.msg-input:focus{border-color:var(--blue-l);background:#fff}
.msg-send-btn{
  width:42px;height:42px;border-radius:50%;border:none;flex-shrink:0;
  background:linear-gradient(135deg,var(--navy),var(--blue));color:#fff;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .15s;
  box-shadow:0 3px 10px rgba(26,86,219,.32);
}
.msg-send-btn:active{transform:scale(.88)}
.msg-send-btn:disabled{opacity:.38;transform:none;box-shadow:none}

/* Chat empty */
.chat-empty{
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:.5rem;color:var(--muted);
  padding:2rem;text-align:center;min-height:180px;
}
.chat-empty h4{font-size:.92rem;font-family:'Clash Display',sans-serif;font-weight:600;color:var(--txt);opacity:.6}
.chat-empty p{font-size:.77rem;line-height:1.6;max-width:210px}

/* ══════ DESKTOP ADAPTATIONS ══════ */
@media(min-width:640px){
  .modal-ov{align-items:center;padding:1rem}
  .modal-box{border-radius:24px;max-height:88vh}
  .modal-handle{display:none}
  #map{height:340px}
  .page-body{padding:1rem 1.2rem 1.2rem}
  .page-hero{margin:1rem 1.2rem}
  .stats-grid{padding:0 1.2rem;grid-template-columns:repeat(4,1fr);gap:.9rem}
  .panel{margin:0 1.2rem .9rem}
  .finance-row{padding:0 1.2rem;grid-template-columns:repeat(3,1fr)}
  .queue-item{margin:0 1.2rem .7rem}
  .qr-grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
}
@media(min-width:960px){
  .app-topbar{padding:.7rem 2rem}
  .page-body{padding:1.2rem 2rem 2rem;max-width:1080px;margin:0 auto}
  .page-hero{margin:1.2rem 2rem}
  .stats-grid{padding:0 2rem}
  .panel{margin:0 2rem .9rem}
  .finance-row{padding:0 2rem}
  .queue-item{margin:0 2rem .7rem}
  .main-content{padding-top:calc(var(--safe-t) + 62px)}
  /* On desktop, show sidebar instead of bottom nav (optional) */
}
@media(max-width:400px){
  .stats-grid{grid-template-columns:1fr 1fr}
  .finance-row{grid-template-columns:1fr 1fr}
  .form-row{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- ╔══════════════════════ AUTH ══════════════════════╗ -->
<div id="authScreen" class="auth-screen active">
  <div class="auth-bg"></div>
  <div class="auth-orb auth-orb1"></div>
  <div class="auth-orb auth-orb2"></div>
  <div class="auth-noise"></div>
  <div id="authStars" style="position:absolute;inset:0;z-index:2;pointer-events:none"></div>

  <!-- Road scene -->
  <div class="auth-road-scene">
    <svg viewBox="0 0 800 180" preserveAspectRatio="xMidYMax meet" style="position:absolute;bottom:0;left:0;width:100%;height:180px">
      <defs>
        <linearGradient id="skyGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="rgba(15,40,80,.0)"/>
          <stop offset="100%" stop-color="rgba(15,40,80,.6)"/>
        </linearGradient>
      </defs>
      <rect y="100" width="800" height="80" fill="#111827"/>
      <rect y="97" width="800" height="6" fill="#1E293B"/>
      <!-- Center line -->
      <rect x="30" y="135" width="60" height="5" rx="2.5" fill="rgba(255,255,255,.2)"/>
      <rect x="160" y="135" width="60" height="5" rx="2.5" fill="rgba(255,255,255,.2)"/>
      <rect x="290" y="135" width="60" height="5" rx="2.5" fill="rgba(255,255,255,.2)"/>
      <rect x="420" y="135" width="60" height="5" rx="2.5" fill="rgba(255,255,255,.2)"/>
      <rect x="550" y="135" width="60" height="5" rx="2.5" fill="rgba(255,255,255,.2)"/>
      <rect x="680" y="135" width="60" height="5" rx="2.5" fill="rgba(255,255,255,.2)"/>
      <!-- Sidewalk -->
      <rect y="92" width="800" height="10" fill="#293548"/>
      <!-- Trees -->
      <rect x="10" y="45" width="7" height="48" fill="#3D2B1F"/>
      <ellipse cx="13" cy="40" rx="18" ry="20" fill="#1A5C2E"/>
      <rect x="80" y="55" width="6" height="38" fill="#3D2B1F"/>
      <ellipse cx="83" cy="50" rx="15" ry="17" fill="#1F6E34"/>
      <rect x="160" y="48" width="7" height="44" fill="#3D2B1F"/>
      <ellipse cx="163" cy="44" rx="17" ry="18" fill="#166428"/>
      <rect x="620" y="44" width="7" height="48" fill="#3D2B1F"/>
      <ellipse cx="623" cy="40" rx="18" ry="20" fill="#1A5C2E"/>
      <rect x="700" y="52" width="6" height="40" fill="#3D2B1F"/>
      <ellipse cx="703" cy="48" rx="15" ry="17" fill="#1F6E34"/>
      <rect x="770" y="46" width="7" height="46" fill="#3D2B1F"/>
      <ellipse cx="773" cy="42" rx="17" ry="18" fill="#166428"/>
      <!-- Buildings -->
      <rect x="310" y="15" width="45" height="85" fill="#1E293B" rx="2"/>
      <rect x="316" y="22" width="8" height="8" fill="#38BDF8" rx="1" opacity=".8"/>
      <rect x="330" y="22" width="8" height="8" fill="#60A5FA" rx="1" opacity=".7"/>
      <rect x="316" y="36" width="8" height="8" fill="#38BDF8" rx="1" opacity=".9"/>
      <rect x="330" y="36" width="8" height="8" fill="rgba(255,255,255,.15)" rx="1"/>
      <rect x="316" y="50" width="8" height="8" fill="#60A5FA" rx="1" opacity=".8"/>
      <rect x="330" y="50" width="8" height="8" fill="#38BDF8" rx="1" opacity=".6"/>
      <rect x="316" y="64" width="8" height="8" fill="#60A5FA" rx="1" opacity=".5"/>
      <rect x="330" y="64" width="8" height="8" fill="#38BDF8" rx="1" opacity=".7"/>
      <rect x="365" y="28" width="40" height="72" fill="#162032" rx="2"/>
      <rect x="371" y="35" width="7" height="7" fill="#FCD34D" rx="1" opacity=".8"/>
      <rect x="383" y="35" width="7" height="7" fill="#38BDF8" rx="1" opacity=".7"/>
      <rect x="371" y="48" width="7" height="7" fill="#60A5FA" rx="1" opacity=".8"/>
      <rect x="383" y="48" width="7" height="7" fill="#FCD34D" rx="1" opacity=".6"/>
      <rect x="371" y="61" width="7" height="7" fill="#38BDF8" rx="1" opacity=".7"/>
      <rect x="383" y="61" width="7" height="7" fill="#60A5FA" rx="1" opacity=".9"/>
      <rect x="371" y="74" width="7" height="7" fill="#FCD34D" rx="1" opacity=".5"/>
      <rect x="383" y="74" width="7" height="7" fill="#38BDF8" rx="1" opacity=".7"/>
      <!-- School -->
      <rect x="460" y="22" width="75" height="78" fill="#1A3A7E" rx="3"/>
      <rect x="472" y="13" width="52" height="12" fill="#122B62" rx="2"/>
      <rect x="494" y="1" width="3" height="14" fill="#E2E8F0"/>
      <rect x="497" y="1" width="15" height="10" fill="#F05A28"/>
      <!-- School windows -->
      <rect x="470" y="32" width="11" height="11" fill="#93C5FD" rx="1"/>
      <rect x="487" y="32" width="11" height="11" fill="#BAE6FD" rx="1"/>
      <rect x="504" y="32" width="11" height="11" fill="#93C5FD" rx="1"/>
      <rect x="521" y="32" width="11" height="11" fill="#BAE6FD" rx="1"/>
      <rect x="470" y="50" width="11" height="11" fill="#BAE6FD" rx="1"/>
      <rect x="487" y="50" width="11" height="11" fill="#93C5FD" rx="1"/>
      <rect x="504" y="50" width="11" height="11" fill="#BAE6FD" rx="1"/>
      <rect x="521" y="50" width="11" height="11" fill="#93C5FD" rx="1"/>
      <!-- School door -->
      <rect x="487" y="70" width="22" height="30" fill="#122B62" rx="1"/>
      <!-- Animated Bus -->
      <g id="authBus" style="animation:authBusMove 14s linear infinite">
        <rect x="30" y="65" width="90" height="36" rx="6" fill="#F05A28"/>
        <rect x="32" y="67" width="86" height="7" fill="#FB7948"/>
        <rect x="36" y="71" width="15" height="11" rx="1.5" fill="#BAE6FD"/>
        <rect x="56" y="71" width="15" height="11" rx="1.5" fill="#E0F2FE"/>
        <rect x="76" y="71" width="15" height="11" rx="1.5" fill="#BAE6FD"/>
        <rect x="96" y="71" width="12" height="11" rx="1.5" fill="#E0F2FE"/>
        <circle cx="41" cy="76" r="4" fill="#1D4ED8" opacity=".9"/>
        <circle cx="61" cy="76" r="4" fill="#7C3AED" opacity=".9"/>
        <circle cx="81" cy="76" r="4" fill="#0F766E" opacity=".9"/>
        <rect x="32" y="90" width="86" height="4" fill="#C2410C"/>
        <circle cx="52" cy="101" r="9" fill="#1F2937"/><circle cx="52" cy="101" r="4.5" fill="#374151"/>
        <circle cx="98" cy="101" r="9" fill="#1F2937"/><circle cx="98" cy="101" r="4.5" fill="#374151"/>
        <ellipse cx="118" cy="77" rx="3" ry="5" fill="#FDE047"/>
        <text x="76" y="88" text-anchor="middle" font-size="6" fill="white" font-family="sans-serif" font-weight="bold">KATUTRANSPORTE</text>
      </g>
      <style>@keyframes authBusMove{0%{transform:translateX(-130px)}100%{transform:translateX(950px)}}</style>
      <!-- Kids at stop -->
      <circle cx="260" cy="80" r="7" fill="#FCD34D"/>
      <rect cx="256" cy="85" width="10" height="12" rx="3" fill="#1D4ED8"/>
      <rect x="256" y="86" width="10" height="12" rx="3" fill="#1D4ED8"/>
      <circle cx="280" cy="83" r="6" fill="#FDBA74"/>
      <rect x="276" y="87" width="9" height="10" rx="3" fill="#7C3AED"/>
      <circle cx="297" cy="81" r="6" fill="#FCD34D"/>
      <rect x="293" y="85" width="9" height="11" rx="3" fill="#0D9488"/>
    </svg>
  </div>

  <!-- Feature pills -->
  <div class="auth-pills">
    <div class="auth-pill"><span class="sd sd-g"></span>GPS ao Vivo</div>
    <div class="auth-pill">
      <svg width="9" height="9" viewBox="0 0 24 24" fill="rgba(255,255,255,.8)"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      QR Seguro
    </div>
    <div class="auth-pill">
      <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.8)" stroke-width="2.5"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      Pagamentos
    </div>
  </div>

  <!-- Auth Card -->
  <div class="auth-card-wrap">
    <div class="auth-card">
      <div class="auth-card-header">
        <div class="auth-card-banner-pattern" style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.05) 1px,transparent 1px);background-size:18px 18px;z-index:0"></div>
        <div class="auth-header-top">
          <div class="auth-logo-badge">
            <svg width="21" height="21" viewBox="0 0 24 24" fill="white"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
          </div>
          <div class="auth-logo-text">
            <h1>Katutransporte</h1>
            <p>Transporte Escolar Seguro</p>
          </div>
        </div>
        <!-- Mini bus scene -->
        <div class="auth-mini-scene">
          <svg width="100%" height="55" viewBox="0 0 380 55">
            <rect y="36" width="380" height="19" fill="rgba(0,0,0,.3)"/>
            <rect y="33" width="380" height="5" fill="rgba(0,0,0,.35)"/>
            <rect x="45" y="10" width="72" height="26" rx="5" fill="#FF7043"/>
            <rect x="47" y="12" width="68" height="5" fill="#FF8A65"/>
            <rect x="51" y="14" width="11" height="9" rx="1.5" fill="#BAE6FD"/>
            <rect x="66" y="14" width="11" height="9" rx="1.5" fill="#E0F2FE"/>
            <rect x="81" y="14" width="11" height="9" rx="1.5" fill="#BAE6FD"/>
            <circle cx="57" cy="36" r="7" fill="#1F2937"/><circle cx="57" cy="36" r="3.5" fill="#374151"/>
            <circle cx="96" cy="36" r="7" fill="#1F2937"/><circle cx="96" cy="36" r="3.5" fill="#374151"/>
            <ellipse cx="115" cy="20" rx="2.5" ry="4" fill="#FDE047"/>
            <text x="76" y="29" text-anchor="middle" font-size="5" fill="white" font-family="sans-serif" font-weight="bold">KATU</text>
            <circle cx="230" cy="26" r="6" fill="#FCD34D"/>
            <rect x="224" y="30" width="12" height="10" rx="3" fill="#1D4ED8"/>
            <circle cx="250" cy="28" r="5.5" fill="#FDBA74"/>
            <rect x="245" y="32" width="10" height="9" rx="3" fill="#7C3AED"/>
            <circle cx="268" cy="27" r="5.5" fill="#FCD34D"/>
            <rect x="263" y="31" width="10" height="9" rx="3" fill="#E53935"/>
            <rect x="300" y="5" width="3" height="30" fill="#94A3B8"/>
            <polygon points="301.5,5 310,12 310,22 301.5,30 293,22 293,12" fill="#DC2626"/>
            <text x="301.5" y="20" text-anchor="middle" font-size="4.5" fill="white" font-family="sans-serif" font-weight="bold">STOP</text>
          </svg>
        </div>
      </div>

      <div class="auth-card-body">
        <div class="auth-tabs">
          <button class="auth-tab-btn active" id="tabEntrar" onclick="UI.authTab('login')">Entrar</button>
          <button class="auth-tab-btn" id="tabRegist" onclick="UI.authTab('register')">Criar Conta</button>
        </div>

        <!-- LOGIN -->
        <div id="loginPane" class="auth-form-pane active">
          <div id="loginAlert"></div>
          <form id="loginForm" novalidate>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="lEmail" class="form-input" placeholder="utilizador@email.com" autocomplete="email" inputmode="email"/>
              <span class="field-err" id="lEmailErr"></span>
            </div>
            <div class="form-group">
              <label class="form-label">Senha</label>
              <input type="password" id="lPwd" class="form-input" placeholder="A sua senha" autocomplete="current-password"/>
              <span class="field-err" id="lPwdErr"></span>
            </div>
            <button type="submit" class="btn btn-primary btn-block btn-lg" style="margin-top:.6rem">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10,17 15,12 10,7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
              Iniciar Sessao
            </button>
          </form>
        </div>

        <!-- REGISTER -->
        <div id="registerPane" class="auth-form-pane">
          <div id="registerAlert"></div>
          <form id="registerForm" novalidate>
            <div class="form-group">
              <label class="form-label">Nome Completo</label>
              <input type="text" id="rName" class="form-input" placeholder="O seu nome completo" autocomplete="name"/>
              <span class="field-err" id="rNameErr"></span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="rEmail" class="form-input" placeholder="email@dominio.com" inputmode="email"/>
                <span class="field-err" id="rEmailErr"></span>
              </div>
              <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="tel" id="rPhone" class="form-input" placeholder="+244 9XX XXX" inputmode="tel"/>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Senha</label>
              <input type="password" id="rPwd" class="form-input" placeholder="Minimo 6 caracteres"/>
              <span class="field-err" id="rPwdErr"></span>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo de Conta</label>
              <select id="rRole" class="form-input">
                <option value="parent">Pai / Responsavel</option>
                <option value="driver">Motorista</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <button type="submit" class="btn btn-orange btn-block btn-lg" style="margin-top:.3rem">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
              Criar Conta
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ╔══════════════════════ APP ══════════════════════╗ -->
<div id="appShell" class="app">

  <!-- Top bar -->
  <header class="app-topbar">
    <div class="app-logo">
      <div class="app-logo-badge">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
      </div>
    </div>
    <div class="app-topbar-mid">
      <div class="page-title" id="topbarTitle">Visao Geral</div>
    </div>
    <div class="app-topbar-actions">
      <button class="icon-btn" onclick="UI.toggleNotifDrawer()" style="position:relative">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <span class="notif-pip hidden" id="notifPip">0</span>
      </button>
      <div class="user-av" id="topbarAv" onclick="Auth.logout()">?</div>
    </div>
  </header>

  <!-- Main content -->
  <main class="main-content" id="mainContent">

    <!-- ── OVERVIEW ── -->
    <div id="s-overview" class="section active">
      <div class="page-hero" style="background:linear-gradient(145deg,#0B1D35,#1A3A7E)">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content">
          <h2>Bom dia! <span id="heroName">Utilizador</span> 👋</h2>
          <p>Tudo sob controlo. Resumo do transporte de hoje.</p>
        </div>
      </div>
      <div class="stats-grid" id="overviewStats"></div>
      <div class="panel panel-al">
        <div class="panel-head"><h3>Atividade Recente</h3></div>
        <div class="panel-body np" id="recentAct"></div>
      </div>
      <div class="panel panel-at">
        <div class="panel-head"><h3>Estado das Criancas</h3></div>
        <div class="panel-body np" id="statusSum"></div>
      </div>
    </div>

    <!-- ── TRACKING ── -->
    <div id="s-tracking" class="section">
      <div class="page-hero" style="background:linear-gradient(145deg,#064E3B,#0D9488)">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content">
          <h2>Rastreamento GPS</h2>
          <p>Localizacao do veiculo em tempo real.</p>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Mapa ao Vivo</h3>
          <span id="busBadge" class="badge b-teal"><span class="sd sd-g"></span>Activo</span>
        </div>
        <div class="panel-body">
          <div id="map"></div>
          <div class="map-legend mt-s">
            <div class="legend-item"><div class="legend-dot" style="background:#F05A28"></div>Veiculo</div>
            <div class="legend-item"><div class="legend-dot" style="background:#14B8A6"></div>Paragens</div>
          </div>
          <p class="text-sm text-muted mt-s" style="font-size:.7rem">Posicao simulada — GPS ao vivo disponivel em producao.</p>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Estado das Criancas</h3></div>
        <div class="panel-body np" id="trackingList"></div>
      </div>
    </div>

    <!-- ── CHILDREN ── -->
    <div id="s-children" class="section">
      <div class="page-hero" style="background:linear-gradient(145deg,#3B1F8C,#6D28D9)">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content">
          <h2>As Minhas Criancas</h2>
          <p>Criancas inscritas no servico de transporte.</p>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Listagem</h3>
          <button class="btn btn-primary btn-sm" onclick="UI.openModal('childModal')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Adicionar
          </button>
        </div>
        <div class="panel-body np" id="childrenList"></div>
      </div>
      <div class="panel panel-av">
        <div class="panel-head"><h3>Seguranca QR</h3></div>
        <div class="panel-body" id="securityContent" style="padding:.8rem 1rem"></div>
      </div>
    </div>

    <!-- ── NOTIFICATIONS ── -->
    <div id="s-notifications" class="section">
      <div class="page-hero" style="background:linear-gradient(145deg,#1E1B4B,#4338CA)">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content">
          <h2>Notificacoes</h2>
          <p>Avisos de recolha, entrega e pagamentos.</p>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Todas</h3>
          <button class="btn btn-ghost btn-sm" onclick="AppState.clearNotifs();Render.sNotifications()">Limpar</button>
        </div>
        <div class="panel-body np" id="notifMain" aria-live="polite"></div>
      </div>
    </div>

    <!-- ── PAYMENTS ── -->
    <div id="s-payments" class="section">
      <div class="page-hero" style="background:linear-gradient(145deg,#7C2D12,#F05A28)">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content">
          <h2>Pagamentos</h2>
          <p>Mensalidades e historico financeiro.</p>
        </div>
      </div>
      <div class="finance-row" id="financeSummary"></div>
      <div class="panel">
        <div class="panel-head">
          <h3>Historico</h3>
          <button class="btn btn-orange btn-sm" onclick="UI.openModal('payModal')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Registar
          </button>
        </div>
        <div class="panel-body np" id="paymentList"></div>
      </div>
    </div>

    <!-- ── ROUTES (driver) ── -->
    <div id="s-routes" class="section">
      <div class="page-hero" style="background:linear-gradient(145deg,#14532D,#059669)">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content">
          <h2>Rota do Dia</h2>
          <p>Recolhas e entregas por ordem de percurso.</p>
        </div>
      </div>
      <div class="panel panel-at" style="margin-bottom:.5rem">
        <div class="panel-head">
          <h3>Fila de Recolha</h3>
          <span id="routeProg" class="chip">0 / 0</span>
        </div>
      </div>
      <div id="routeList"></div>
    </div>

    <!-- ── ADMIN ── -->
    <div id="s-admin" class="section">
      <div class="page-hero" style="background:linear-gradient(145deg,#0B1D35,#1A3A7E)">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content">
          <h2>Administracao</h2>
          <p>Gestao de utilizadores, motoristas e relatorios.</p>
        </div>
      </div>
      <div class="stats-grid" id="adminStats"></div>
      <div class="panel panel-ab">
        <div class="panel-head"><h3>Utilizadores</h3></div>
        <div class="panel-body np" id="adminUsers"></div>
      </div>
      <div class="panel panel-al">
        <div class="panel-head"><h3>Relatorio Financeiro</h3></div>
        <div class="panel-body" id="adminFinance"></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Motoristas</h3>
          <button class="btn btn-primary btn-sm" onclick="UI.openModal('driverModal')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Adicionar
          </button>
        </div>
        <div class="panel-body np" id="adminDrivers"></div>
      </div>
    </div>


    <!-- ── CHAT ── -->
    <div id="s-chat" class="section">
      <div class="page-hero" style="background:linear-gradient(145deg,#0F172A,#1E3A5F);padding:1.2rem 1.5rem">
        <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,.06) 1px,transparent 1px);background-size:22px 22px;z-index:1"></div>
        <div class="page-hero-content" style="display:flex;align-items:center;gap:.8rem">
          <div style="background:rgba(255,255,255,.12);border-radius:14px;padding:.65rem;border:1px solid rgba(255,255,255,.15)">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div>
            <h2 style="font-size:1.15rem">Mensagens</h2>
            <p style="font-size:.77rem">Chat entre encarregados, Edna e motorista</p>
          </div>
        </div>
      </div>
      <div id="chatConvList">
        <!-- conversations rendered by JS -->
      </div>
    </div>

  </main>

  <!-- Bottom navigation -->
  <nav class="bottom-nav" id="bottomNav"></nav>

  <!-- Notif Drawer (slides from bottom) -->
  <div id="notifDrawer" class="notif-drawer">
    <div class="notif-drawer-head">
      <h3>Notificacoes</h3>
      <button class="icon-btn" style="background:rgba(255,255,255,.15);border:none;color:#fff" onclick="UI.toggleNotifDrawer()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="notif-scroll" id="notifSideList"></div>
  </div>
</div>

<!-- ══ MODALS ══ -->
<!-- Add Child -->
<div id="childModal" class="modal-ov" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-head">
      <h3>Registar Crianca</h3>
      <button class="modal-close-btn" onclick="UI.closeModal('childModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="childForm" novalidate>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nome</label>
            <input type="text" id="cName" class="form-input" placeholder="Nome completo"/>
            <span class="field-err" id="cNameErr"></span>
          </div>
          <div class="form-group">
            <label class="form-label">Idade</label>
            <input type="number" id="cAge" class="form-input" min="3" max="18" placeholder="3–18" inputmode="numeric"/>
            <span class="field-err" id="cAgeErr"></span>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Genero</label>
            <select id="cGender" class="form-input"><option value="F">Feminino</option><option value="M">Masculino</option></select>
          </div>
          <div class="form-group">
            <label class="form-label">Grupo</label>
            <select id="cGroup" class="form-input">
              <option value="A1">Manha A</option><option value="A2">Manha B</option><option value="A3">Manha C</option>
              <option value="P1">Tarde A</option><option value="P2">Tarde B</option><option value="P3">Tarde C</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Escola</label>
          <input type="text" id="cSchool" class="form-input" placeholder="Nome da escola"/>
          <span class="field-err" id="cSchoolErr"></span>
        </div>
        <div class="form-group">
          <label class="form-label">Endereco</label>
          <input type="text" id="cAddress" class="form-input" placeholder="Rua, numero, bairro"/>
          <span class="field-err" id="cAddressErr"></span>
        </div>
        <div class="form-group">
          <label class="form-label">Contacto de Emergencia</label>
          <input type="tel" id="cEmergency" class="form-input" placeholder="+244 9XX XXX XXX" inputmode="tel"/>
        </div>
        <div class="form-group">
          <label class="form-label">Responsaveis Autorizados</label>
          <input type="text" id="cAuthorized" class="form-input" placeholder="Nome1, Nome2..."/>
        </div>
        <div class="form-group">
          <label class="form-label">Info Medica <span class="text-muted" style="font-weight:400">(opcional)</span></label>
          <textarea id="cMedical" class="form-input" placeholder="Alergias, medicamentos..."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="UI.closeModal('childModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="Forms.submitChild()">Guardar</button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="payModal" class="modal-ov" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-head">
      <h3>Registar Pagamento</h3>
      <button class="modal-close-btn" onclick="UI.closeModal('payModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="payForm" novalidate>
        <div class="form-group">
          <label class="form-label">Descricao</label>
          <input type="text" id="pDesc" class="form-input" placeholder="Ex: Mensalidade Junho 2025"/>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Valor (Kz)</label>
            <input type="number" id="pAmount" class="form-input" placeholder="15000" min="0" inputmode="numeric"/>
          </div>
          <div class="form-group">
            <label class="form-label">Estado</label>
            <select id="pStatus" class="form-input"><option value="paid">Pago</option><option value="pending">Pendente</option></select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Metodo</label>
          <select id="pMethod" class="form-input">
            <option value="multicaixa">Multicaixa Express</option>
            <option value="transfer">Transferencia Bancaria</option>
            <option value="cash">Numerario</option>
            <option value="unitel">Unitel Money</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="UI.closeModal('payModal')">Cancelar</button>
      <button class="btn btn-orange" onclick="Forms.submitPayment()">Registar</button>
    </div>
  </div>
</div>

<!-- Driver Modal -->
<div id="driverModal" class="modal-ov" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-head">
      <h3>Adicionar Motorista</h3>
      <button class="modal-close-btn" onclick="UI.closeModal('driverModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="driverForm" novalidate>
        <div class="form-group">
          <label class="form-label">Nome Completo</label>
          <input type="text" id="drName" class="form-input" placeholder="Nome do motorista"/>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Telefone</label>
            <input type="tel" id="drPhone" class="form-input" placeholder="+244 9XX XXX" inputmode="tel"/>
          </div>
          <div class="form-group">
            <label class="form-label">Carta</label>
            <input type="text" id="drLicense" class="form-input" placeholder="AO-XXXX-XXX"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Viatura</label>
            <input type="text" id="drVehicle" class="form-input" placeholder="Toyota Hiace"/>
          </div>
          <div class="form-group">
            <label class="form-label">Rota</label>
            <select id="drRoute" class="form-input">
              <option value="A1">Manha A</option><option value="A2">Manha B</option><option value="A3">Manha C</option>
              <option value="P1">Tarde A</option><option value="P2">Tarde B</option><option value="P3">Tarde C</option>
            </select>
          </div>
        </div>
        <hr class="divider"/>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="drEmail" class="form-input" placeholder="motorista@katutransporte.ao" inputmode="email"/>
        </div>
        <div class="form-group">
          <label class="form-label">Senha</label>
          <input type="password" id="drPwd" class="form-input" placeholder="Minimo 6 caracteres"/>
        </div>
      </form>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="UI.closeModal('driverModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="Forms.submitDriver()">Adicionar</button>
    </div>
  </div>
</div>


<!-- Message view (full screen) -->
<div id="msgView" class="msg-view">
  <div class="msg-topbar">
    <button class="msg-back" onclick="ChatUI.closeConv()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15,18 9,12 15,6"/></svg>
    </button>
    <div class="msg-contact-av" id="msgContactAv">?</div>
    <div class="msg-contact-info">
      <div class="msg-contact-name" id="msgContactName">Contacto</div>
      <div class="msg-contact-status" id="msgContactStatus">
        <span class="sd sd-g"></span><span>Online</span>
      </div>
    </div>
    <div style="display:flex;gap:.4rem">
      <div class="icon-btn" id="msgCallBtn" title="Ligar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.62 3.41 2 2 0 0 1 3.6 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.6a16 16 0 0 0 6.29 6.29l.96-.96a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
      </div>
    </div>
  </div>
  <div class="msg-body" id="msgBody"></div>
  <div class="msg-input-bar">
    <textarea class="msg-input" id="msgInput" placeholder="Escreva uma mensagem..." rows="1" maxlength="1000"></textarea>
    <button class="msg-send-btn" id="msgSendBtn" onclick="ChatUI.send()" disabled>
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>
    </button>
  </div>
</div>

<div id="spinOv" class="spin-ov"><div class="spinner"></div></div>
<div id="toasts" aria-live="polite"></div>

<script>
/* ═══════════ DATABASE ═══════════ */
const DB={
  _k:n=>`katu_${n}`,
  get(t){try{return JSON.parse(localStorage.getItem(this._k(t)))||[]}catch{return[]}},
  save(t,d){localStorage.setItem(this._k(t),JSON.stringify(d))},
  find(t,fn){return this.get(t).find(fn)},
  filter(t,fn){return this.get(t).filter(fn)},
  insert(t,row){const d=this.get(t);d.push(row);this.save(t,d);return row},
  update(t,id,u){const d=this.get(t).map(r=>r.id===id?{...r,...u}:r);this.save(t,d);return d.find(r=>r.id===id)},
  remove(t,id){this.save(t,this.get(t).filter(r=>r.id!==id))},
  nextId(t){const d=this.get(t);return d.length?Math.max(...d.map(r=>r.id))+1:1},
  seed(){
    if(this.find('users',u=>u.email==='pai@katutransporte.ao'))return;
    this.insert('users',{id:1,name:'Maria Mbunga',email:'pai@katutransporte.ao',password:'katu123',phone:'+244 923 456 789',role:'parent',createdAt:new Date().toISOString()});
    this.insert('users',{id:2,name:'Carlos Mendes',email:'motorista@katutransporte.ao',password:'katu123',phone:'+244 912 111 222',role:'driver',vehicle:'Toyota Hiace',license:'AO-2021-XK7',route:'A1',createdAt:new Date().toISOString()});
    this.insert('users',{id:3,name:'Admin Sistema',email:'admin@katutransporte.ao',password:'admin123',phone:'+244 900 000 001',role:'admin',createdAt:new Date().toISOString()});
    [{id:1,userId:1,name:'Ana Mbunga',age:8,gender:'F',school:'Colegio Santo Antonio',address:'Rua do Kilamba, 12',status:'transit',medical_info:'',group:'A1',authorized:'Maria Mbunga, Jose Mbunga',pin:'4821'},
     {id:2,userId:1,name:'Joao Ngueve',age:11,gender:'M',school:'Escola Primaria Sol',address:'Av. Brasil, 45',status:'picked',medical_info:'',group:'A2',authorized:'Maria Mbunga',pin:'7364'},
     {id:3,userId:1,name:'Sofia Lemos',age:7,gender:'F',school:'Colegio Santo Antonio',address:'Rua Mae Isabel, 3',status:'waiting',medical_info:'Alergica a amendoim',group:'A1',authorized:'Maria Mbunga, Luisa Lemos',pin:'2957'}
    ].forEach(c=>this.insert('children',c));
    const ts=s=>new Date(Date.now()-s).toISOString();
    [{id:1,userId:1,type:'departure',message:'O veiculo partiu do deposito as 06h30.',createdAt:ts(3600000),read:true},
     {id:2,userId:1,type:'pickup',message:'Ana Mbunga foi recolhida com seguranca.',createdAt:ts(1800000),read:true},
     {id:3,userId:1,type:'arrival',message:'O veiculo esta a 5 minutos do destino.',createdAt:ts(600000),read:false},
     {id:4,userId:1,type:'payment',message:'Pagamento de Maio 2025 esta pendente.',createdAt:ts(86400000),read:false}
    ].forEach(n=>this.insert('notifications',n));
    [{id:1,userId:1,description:'Mensalidade Marco 2025',amount:15000,status:'paid',method:'multicaixa',createdAt:ts(86400000*60)},
     {id:2,userId:1,description:'Mensalidade Abril 2025',amount:15000,status:'paid',method:'transfer',createdAt:ts(86400000*30)},
     {id:3,userId:1,description:'Mensalidade Maio 2025',amount:15000,status:'pending',method:'',createdAt:ts(86400000)}
    ].forEach(p=>this.insert('payments',p));
  }
};

const Session={
  _k:'katu_sess',
  set(u){localStorage.setItem(this._k,JSON.stringify({userId:u.id,role:u.role,name:u.name}))},
  get(){try{return JSON.parse(localStorage.getItem(this._k))}catch{return null}},
  clear(){localStorage.removeItem(this._k)},
  active(){return!!this.get()}
};

const Auth={
  login(email,pwd){
    const u=DB.find('users',u=>u.email.toLowerCase()===email.trim().toLowerCase());
    if(!u)throw new Error('Email nao encontrado.');
    if(u.password!==pwd)throw new Error('Senha incorreta.');
    Session.set(u);return u;
  },
  register(data){
    if(DB.find('users',u=>u.email.toLowerCase()===data.email.trim().toLowerCase()))
      throw new Error('Este email ja esta registado.');
    return DB.insert('users',{id:DB.nextId('users'),name:data.name.trim(),email:data.email.trim().toLowerCase(),password:data.password,phone:data.phone||'',role:data.role,createdAt:new Date().toISOString()});
  },
  logout(){Realtime.stop();MapMod.destroy();Session.clear();AppState.reset();UI.showAuth();Toast.show('Sessao terminada.','info')},
  currentUser(){const s=Session.get();return s?DB.find('users',u=>u.id===s.userId)||null:null}
};

const AppState={
  user:null,children:[],notifs:[],payments:[],
  load(){
    const u=Auth.currentUser();if(!u)return false;
    this.user=u;
    this.children=u.role==='admin'?DB.get('children'):DB.filter('children',c=>c.userId===u.id);
    this.notifs=(u.role==='admin'?DB.get('notifications'):DB.filter('notifications',n=>n.userId===u.id)).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    this.payments=u.role==='admin'?DB.get('payments'):DB.filter('payments',p=>p.userId===u.id).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    return true;
  },
  reset(){this.user=null;this.children=[];this.notifs=[];this.payments=[]},
  addChild(data){
    const c=DB.insert('children',{id:DB.nextId('children'),userId:this.user.id,status:'waiting',pin:Math.floor(1000+Math.random()*9000)+'',...data});
    this.children.push(c);return c;
  },
  updateStatus(id,status){
    DB.update('children',id,{status});
    this.children=this.children.map(c=>c.id===id?{...c,status}:c);
  },
  addNotif(msg,type='info'){
    const n=DB.insert('notifications',{id:DB.nextId('notifications'),userId:this.user.id,message:msg,type,createdAt:new Date().toISOString(),read:false});
    this.notifs.unshift(n);
  },
  clearNotifs(){
    DB.filter('notifications',n=>n.userId===this.user.id).forEach(n=>DB.remove('notifications',n.id));
    this.notifs=[];
  },
  unread(){return this.notifs.filter(n=>!n.read).length}
};

/* ═══════════ NAV CONFIG ═══════════ */
const NAVS={
  parent:[
    {id:'overview',label:'Inicio',ico:'grid'},
    {id:'tracking',label:'GPS',ico:'map'},
    {id:'children',label:'Criancas',ico:'users'},
    {id:'chat',label:'Chat',ico:'chat',chatBadge:true},
    {id:'payments',label:'Pagamentos',ico:'credit'},
  ],
  driver:[
    {id:'overview',label:'Inicio',ico:'grid'},
    {id:'routes',label:'Rota',ico:'route'},
    {id:'tracking',label:'Mapa',ico:'map'},
    {id:'chat',label:'Chat',ico:'chat',chatBadge:true},
    {id:'notifications',label:'Alertas',ico:'bell',badge:true},
  ],
  admin:[
    {id:'overview',label:'Inicio',ico:'grid'},
    {id:'admin',label:'Admin',ico:'settings'},
    {id:'chat',label:'Chat',ico:'chat',chatBadge:true},
    {id:'notifications',label:'Alertas',ico:'bell',badge:true},
    {id:'payments',label:'Financas',ico:'credit'},
  ]
};

/* ═══════════ SVG ICONS ═══════════ */
const ICO={
  grid:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>`,
  users:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  map:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="1,6 1,22 8,18 16,22 23,18 23,2 16,6 8,2"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>`,
  bell:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
  credit:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>`,
  shield:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
  route:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="5" cy="6" r="3"/><path d="M8 6h9a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H8"/><circle cx="5" cy="18" r="3"/></svg>`,
  settings:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>`,
  bus:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>`,
  check:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20,6 9,17 4,12"/></svg>`,
  chat:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`
};

/* ═══════════ VALIDATORS ═══════════ */
const V={
  email:v=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim()),
  pwd:v=>v.length>=6,name:v=>v.trim().length>=2,
  age:v=>Number(v)>=3&&Number(v)<=18,str:v=>v.trim().length>=2,addr:v=>v.trim().length>=4,
  f(id,fn,eid,msg){const el=g(id),er=g(eid);const ok=fn(el.value);el.classList.toggle('invalid',!ok);el.classList.toggle('valid',ok);if(er)er.textContent=ok?'':msg;return ok},
  live(id,fn,eid,msg){const el=g(id);if(!el)return;const chk=()=>this.f(id,fn,eid,msg);el.addEventListener('blur',chk);el.addEventListener('input',()=>{if(el.classList.contains('invalid'))chk()})}
};

/* ═══════════ RENDER ═══════════ */
const Render={
  all(){
    this.sOverview();
    const r=AppState.user?.role;
    if(r==='parent'||r==='admin'){this.sChildren();this.sPayments();this.sSecurity();}
    if(r==='driver'||r==='admin')this.sRoutes();
    if(r==='admin')this.sAdmin();
    this.sTracking();this.sNotifications();this.notifBadge();
  },

  sOverview(){
    const c=AppState.children,u=AppState.user;
    g('heroName').textContent=u.name.split(' ')[0];
    if(u.role==='admin'){
      const users=DB.get('users'),pays=DB.get('payments');
      g('overviewStats').innerHTML=
        this._stat('Familias',users.filter(x=>x.role==='parent').length,'#EFF6FF','#1D4ED8',ICO.users)+
        this._stat('Motoristas',users.filter(x=>x.role==='driver').length,'#F0FDFA','#0D9488',ICO.bus)+
        this._stat('Criancas',DB.get('children').length,'#F5F3FF','#6D28D9',ICO.users)+
        this._stat('Receita',pays.filter(p=>p.status==='paid').reduce((s,p)=>s+Number(p.amount),0).toLocaleString('pt-PT')+' Kz','#FFF7ED','#B45309',ICO.credit);
    } else {
      const pend=AppState.payments.filter(p=>p.status==='pending').reduce((s,p)=>s+Number(p.amount),0);
      g('overviewStats').innerHTML=
        this._stat('Criancas',c.length,'#EFF6FF','#1D4ED8',ICO.users)+
        this._stat('Em Rota',c.filter(x=>x.status==='transit'||x.status==='picked').length,'#F0FDFA','#0D9488',ICO.bus)+
        this._stat('Entregues',c.filter(x=>x.status==='delivered').length,'#ECFDF5','#059669',ICO.check)+
        (pend>0?this._stat('Divida',pend.toLocaleString('pt-PT')+' Kz','#FEF2F2','#DC2626',ICO.credit):'');
    }
    g('recentAct').innerHTML=AppState.notifs.slice(0,5).map(n=>`
      <div class="notif-item${n.read?'':' unread'}">
        <div class="notif-ico-wrap" style="background:${this._nColor(n.type)}18;color:${this._nColor(n.type)}">${this._nIcon(n.type)}</div>
        <div class="notif-text"><div class="notif-time">${this._dt(n.createdAt)}</div><div class="notif-msg">${n.message}</div></div>
      </div>`).join('')||this._empty('Sem actividade recente.');
    g('statusSum').innerHTML=c.length?c.map(k=>`
      <div class="list-item">
        <div class="li-av" style="background:${this._av(k.name)};">${k.name[0]}</div>
        <div class="li-info"><div class="li-name">${k.name}</div><div class="li-meta">${k.school}</div></div>
        ${this._sbadge(k.status)}
      </div>`).join(''):this._empty('Nenhuma crianca registada.');
  },

  sChildren(){
    const el=g('childrenList');if(!el)return;
    el.innerHTML=AppState.children.length?AppState.children.map(c=>this._childRow(c)).join(''):this._empty('Adicione a primeira crianca.');
  },

  sTracking(){
    const el=g('trackingList');if(!el)return;
    el.innerHTML=AppState.children.length?AppState.children.map(c=>`
      <div class="list-item">
        <div class="li-av" style="background:${this._av(c.name)};">${c.name[0]}</div>
        <div class="li-info">
          <div class="li-name">${c.name}</div>
          <div class="li-meta">${c.school}</div>
          <div class="li-meta" style="color:#0D9488;font-weight:600;font-size:.73rem">${this._eta(c.status)}</div>
        </div>
        ${this._sbadge(c.status)}
      </div>`).join(''):this._empty('Sem dados de rastreamento.');
  },

  sNotifications(){
    const items=AppState.notifs.map(n=>`
      <div class="notif-item${n.read?'':' unread'}">
        <div class="notif-ico-wrap" style="background:${this._nColor(n.type)}18;color:${this._nColor(n.type)}">${this._nIcon(n.type)}</div>
        <div class="notif-text">
          <div class="notif-time">${this._dt(n.createdAt)}${!n.read?' &nbsp;<span class="badge b-info" style="font-size:.58rem">Novo</span>':''}</div>
          <div class="notif-msg">${n.message}</div>
        </div>
      </div>`).join('');
    const html=items||this._empty('Sem notificacoes.');
    if(g('notifMain'))g('notifMain').innerHTML=html;
    if(g('notifSideList'))g('notifSideList').innerHTML=html;
  },

  sPayments(){
    const pays=AppState.payments;
    const paid=pays.filter(p=>p.status==='paid').reduce((s,p)=>s+Number(p.amount),0);
    const pend=pays.filter(p=>p.status==='pending').reduce((s,p)=>s+Number(p.amount),0);
    g('financeSummary').innerHTML=`
      <div class="fin-card"><div class="fin-card-bar" style="background:linear-gradient(90deg,#059669,#10B981)"></div><div class="fin-label">Recebido</div><div class="fin-amount" style="color:#065F46">${paid.toLocaleString('pt-PT')} Kz</div></div>
      <div class="fin-card"><div class="fin-card-bar" style="background:linear-gradient(90deg,#DC2626,#EF4444)"></div><div class="fin-label">Em Atraso</div><div class="fin-amount" style="color:#991B1B">${pend.toLocaleString('pt-PT')} Kz</div></div>`;
    g('paymentList').innerHTML=pays.length?pays.map(p=>`
      <div class="pay-card">
        <div class="pay-desc">
          <h4>${p.description}</h4>
          <p>${this._dt(p.createdAt)} ? ${{multicaixa:'Multicaixa',transfer:'Transferencia',cash:'Numerario',unitel:'Unitel Money','':'?'}[p.method]||p.method}</p>
        </div>
        <div>
          <div class="pay-val">${Number(p.amount).toLocaleString('pt-PT')} Kz</div>
          <div style="text-align:right;margin-top:.3rem"><span class="badge ${p.status==='paid'?'b-paid':'b-pending'}">${p.status==='paid'?'Pago':'Pendente'}</span></div>
        </div>
      </div>`).join(''):this._empty('Sem pagamentos registados.');
  },

  sRoutes(){
    const kids=AppState.children;
    const done=kids.filter(c=>c.status==='delivered').length;
    if(g('routeProg'))g('routeProg').textContent=`${done}/${kids.length} entregues`;
    if(g('routeList'))g('routeList').innerHTML=kids.length?kids.map((c,i)=>`
      <div class="queue-item${c.status==='delivered'?' done':''}">
        <div style="display:flex;align-items:flex-start;gap:.75rem">
          <div style="display:flex;flex-direction:column;align-items:center;gap:.4rem;flex-shrink:0">
            <div class="queue-num">${i+1}</div>
          </div>
          <div class="li-av" style="background:${this._av(c.name)};width:40px;height:40px;font-size:.9rem;flex-shrink:0">${c.name[0]}</div>
          <div style="flex:1;min-width:0">
            <div class="li-name">${c.name}</div>
            <div class="li-meta">${c.address}</div>
            <div class="li-meta">${c.school} ? ${c.age} anos${c.medical_info?` <span style="color:#DC2626">| ${c.medical_info}</span>`:''}</div>
            <div style="display:flex;align-items:center;gap:.4rem;margin-top:.55rem;flex-wrap:wrap">
              ${this._sbadge(c.status)}
              <button class="btn btn-teal btn-sm" onclick="Driver.upd(${c.id},'picked')" style="font-size:.72rem;padding:.32rem .65rem">Recolher</button>
              <button class="btn btn-orange btn-sm" onclick="Driver.upd(${c.id},'delivered')" style="font-size:.72rem;padding:.32rem .65rem">Entregar</button>
            </div>
          </div>
        </div>
      </div>`).join(''):this._empty('Sem rota atribuida.');
  },

  sSecurity(){
    const el=g('securityContent');if(!el)return;
    const kids=AppState.children;
    if(!kids.length){el.innerHTML=this._empty('Adicione criancas para ver os QR codes.');return;}
    el.innerHTML=`<p class="text-muted text-sm mb-m" style="font-size:.78rem">PIN exclusivo por crianca. Apresente ao motorista no momento da entrega.</p>
    <div class="qr-grid">${kids.map(c=>`
      <div class="qr-card">
        <div class="li-av" style="background:${this._av(c.name)};width:40px;height:40px;margin:0 auto .5rem">${c.name[0]}</div>
        <div style="font-weight:700;font-size:.85rem;margin-bottom:.1rem">${c.name}</div>
        <div class="qr-vis">
          <svg width="62" height="62" viewBox="0 0 62 62">
            <rect width="62" height="62" fill="#F8FAFF"/>
            <rect x="4" y="4" width="22" height="22" rx="2" fill="none" stroke="#0B1D35" stroke-width="2"/>
            <rect x="8" y="8" width="14" height="14" rx="1" fill="#0B1D35"/>
            <rect x="36" y="4" width="22" height="22" rx="2" fill="none" stroke="#0B1D35" stroke-width="2"/>
            <rect x="40" y="8" width="14" height="14" rx="1" fill="#0B1D35"/>
            <rect x="4" y="36" width="22" height="22" rx="2" fill="none" stroke="#0B1D35" stroke-width="2"/>
            <rect x="8" y="40" width="14" height="14" rx="1" fill="#0B1D35"/>
            <rect x="36" y="36" width="8" height="8" fill="#0B1D35"/>
            <rect x="48" y="36" width="8" height="8" fill="#0B1D35"/>
            <rect x="36" y="48" width="8" height="8" fill="#0B1D35"/>
            <rect x="48" y="48" width="8" height="8" fill="#0B1D35"/>
          </svg>
          <div style="font-size:.66rem;font-weight:800;color:var(--navy);letter-spacing:.1em">PIN: ${c.pin}</div>
        </div>
        <div class="text-sm text-muted" style="font-size:.7rem;margin-top:.3rem">${c.authorized||'Sem autorizados'}</div>
      </div>`).join('')}</div>`;
  },

  sAdmin(){
    const users=DB.get('users'),kids=DB.get('children'),pays=DB.get('payments');
    const paid=pays.filter(p=>p.status==='paid').reduce((s,p)=>s+Number(p.amount),0);
    const pend=pays.filter(p=>p.status==='pending').reduce((s,p)=>s+Number(p.amount),0);
    g('adminStats').innerHTML=
      this._stat('Familias',users.filter(x=>x.role==='parent').length,'#EFF6FF','#1D4ED8',ICO.users)+
      this._stat('Motoristas',users.filter(x=>x.role==='driver').length,'#F0FDFA','#0D9488',ICO.bus)+
      this._stat('Criancas',kids.length,'#F5F3FF','#6D28D9',ICO.users)+
      this._stat('Receita',paid.toLocaleString('pt-PT')+' Kz','#ECFDF5','#059669',ICO.credit);
    g('adminUsers').innerHTML=users.map(u=>`
      <div class="list-item">
        <div class="li-av" style="background:${this._av(u.name)};">${u.name[0]}</div>
        <div class="li-info"><div class="li-name">${u.name}</div><div class="li-meta">${u.email}</div></div>
        <span class="badge b-navy" style="font-size:.63rem">${{parent:'Resp.',driver:'Motorista',admin:'Admin'}[u.role]||u.role}</span>
      </div>`).join('');
    const tot=paid+pend;
    g('adminFinance').innerHTML=`
      <div class="sec-label">Resumo</div>
      <div class="flex justify-between items-center" style="padding:.65rem 0;border-bottom:1px solid var(--border2)"><span class="text-sm">Recebido</span><span style="font-weight:700;color:#065F46">${paid.toLocaleString('pt-PT')} Kz</span></div>
      <div class="flex justify-between items-center" style="padding:.65rem 0;border-bottom:1px solid var(--border2)"><span class="text-sm">Em Atraso</span><span style="font-weight:700;color:#991B1B">${pend.toLocaleString('pt-PT')} Kz</span></div>
      <div class="flex justify-between items-center" style="padding:.65rem 0"><span class="text-sm">Total</span><span style="font-weight:700">${tot.toLocaleString('pt-PT')} Kz</span></div>
      <div class="prog-bar mt-s"><div class="prog-fill pf-green" style="width:${tot>0?Math.round(paid/tot*100):0}%"></div></div>
      <div class="text-sm text-muted mt-s">${tot>0?Math.round(paid/tot*100):0}% cobrado</div>`;
    const drivers=users.filter(u=>u.role==='driver');
    g('adminDrivers').innerHTML=drivers.length?drivers.map(d=>`
      <div class="list-item">
        <div class="li-av" style="background:var(--navy);color:#fff;">${d.name[0]}</div>
        <div class="li-info">
          <div class="li-name">${d.name}</div>
          <div class="li-meta">${d.phone||'?'} ? ${d.vehicle||'Sem viatura'}</div>
          <div class="li-meta">Rota: ${d.route||'Nao atribuida'} ? Carta: ${d.license||'?'}</div>
        </div>
        <span class="badge b-teal"><span class="sd sd-g"></span>Activo</span>
      </div>`).join(''):this._empty('Nenhum motorista registado.');
  },

  notifBadge(){
    const n=AppState.unread();
    const pip=g('notifPip');if(pip){pip.textContent=n;pip.classList.toggle('hidden',n===0)}
    document.querySelectorAll('.nav-badge').forEach(el=>{el.textContent=n;el.style.display=n>0?'':'none'});
  },

  /* helpers */
  _stat(label,val,bg,color,ico){return`<div class="stat-card"><div class="stat-glow" style="background:${color}"></div><div class="stat-top"><span class="stat-label">${label}</span><div class="stat-ico" style="background:${bg};color:${color}">${ico}</div></div><div class="stat-val">${val}</div></div>`},
  _sbadge(s){const m={waiting:['b-waiting','Aguardando'],picked:['b-picked','Recolhida'],transit:['b-transit','Em Rota'],delivered:['b-delivered','Entregue']};const[c,l]=m[s]||['b-info',s];return`<span class="badge ${c}">${l}</span>`},
  _childRow(c){return`<div class="list-item"><div class="li-av" style="background:${this._av(c.name)};">${c.name[0]}</div><div class="li-info"><div class="li-name">${c.name}</div><div class="li-meta">${c.school} ? ${c.age} anos ? Grupo ${c.group||'?'}</div><div class="li-meta">${c.address}${c.medical_info?` <span style="color:#DC2626">| ${c.medical_info}</span>`:''}</div></div><div class="li-actions">${this._sbadge(c.status)}</div></div>`},
  _eta(s){return{waiting:'Recolha em ~20 min',picked:'A caminho da escola',transit:'Chegada em ~10 min',delivered:'Entregue com sucesso'}[s]||''},
  _av(n){const c=['#1D4ED8','#0D9488','#6D28D9','#C2410C','#DC2626','#0B1D35','#059669'];return c[n.charCodeAt(0)%c.length]},
  _nColor(t){return{departure:'#1D4ED8',pickup:'#059669',arrival:'#0D9488',payment:'#DC2626',info:'#1D4ED8'}[t]||'#1D4ED8'},
  _nIcon(t){const m={departure:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/></svg>`,pickup:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20,6 9,17 4,12"/></svg>`,arrival:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>`,payment:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>`};return m[t]||m.arrival},
  _dt(iso){try{return new Date(iso).toLocaleString('pt-PT',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}catch{return iso}},
  _empty(msg){return`<div class="empty-state"><svg width="48" height="48" viewBox="0 0 48 48" style="margin:0 auto .8rem;display:block"><circle cx="24" cy="24" r="23" fill="#F1F5F9"/><path d="M16 28l-4-4 4-4M32 28l4-4-4-4M20 32l4-10 4 10" stroke="#94A3B8" stroke-width="2" stroke-linecap="round" fill="none"/></svg><h4>Sem dados</h4><p>${msg}</p></div>`}
};

/* ═══════════ DRIVER ═══════════ */
const Driver={
  upd(id,status){
    AppState.updateStatus(id,status);
    const c=AppState.children.find(x=>x.id===id);
    const lbl={picked:'recolhida',delivered:'entregue'}[status]||status;
    AppState.addNotif(`${c?.name||'Crianca'} marcada como ${lbl}.`,status==='picked'?'pickup':'arrival');
    Render.all();Toast.show(`${c?.name} ? ${lbl}.`,'success');
  }
};

/* ═══════════ MAP ═══════════ */
const MapMod={
  _m:null,_mk:null,_iv:null,_i:0,
  _pts:[[-8.838,13.234],[-8.841,13.240],[-8.845,13.248],[-8.849,13.255],[-8.854,13.261],[-8.857,13.268],[-8.852,13.275],[-8.847,13.270],[-8.843,13.262]],
  init(){
    if(this._m){setTimeout(()=>this._m.invalidateSize(),200);return}
    this._m=L.map('map',{zoomControl:false}).setView(this._pts[0],14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'?? OpenStreetMap',maxZoom:19}).addTo(this._m);
    L.control.zoom({position:'bottomright'}).addTo(this._m);
    const busHtml=`<div style="background:#F05A28;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(240,90,40,.55);border:2.5px solid white"><svg width="17" height="17" viewBox="0 0 24 24" fill="white"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16,8 20,8 23,11 23,16 16,16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg></div>`;
    const ico=L.divIcon({html:busHtml,className:'',iconSize:[36,36],iconAnchor:[18,18]});
    this._mk=L.marker(this._pts[0],{icon:ico,alt:'Veiculo'}).addTo(this._m).bindPopup('<strong>Katutransporte</strong><br>Em rota activa',{closeButton:false}).openPopup();
    L.polyline(this._pts,{color:'#1A56DB',weight:3,opacity:.45,dashArray:'8 5'}).addTo(this._m);
    this._pts.forEach((p,i)=>L.circleMarker(p,{radius:7,fillColor:'#0D9488',color:'#fff',weight:2,fillOpacity:1}).addTo(this._m).bindTooltip(`Paragem ${i+1}`));
    this._iv=setInterval(()=>{
      this._i=(this._i+1)%this._pts.length;
      this._mk.setLatLng(this._pts[this._i]);
      this._m.panTo(this._pts[this._i],{animate:true,duration:1.2});
      const b=g('busBadge');if(b)b.innerHTML=`<span class="sd sd-g"></span>Paragem ${this._i+1}`;
    },4000);
  },
  destroy(){clearInterval(this._iv);this._iv=null;if(this._m){this._m.remove();this._m=null;}}
};

/* ═══════════ REALTIME ═══════════ */
const Realtime={
  _t:null,_i:0,
  _msgs:[['O veiculo partiu do deposito.','departure'],['A 5 minutos da sua zona.','arrival'],['Uma crianca foi recolhida.','pickup'],['O veiculo chegou a escola.','arrival'],['Rota de regresso iniciada.','departure'],['Entrega prevista em 15 min.','arrival']],
  start(){if(this._t)return;this._t=setInterval(()=>{if(!AppState.user)return;const[msg,type]=this._msgs[this._i%this._msgs.length];this._i++;AppState.addNotif(msg,type);Render.sNotifications();Render.notifBadge();Toast.show(msg,'info');},22000)},
  stop(){clearInterval(this._t);this._t=null;}
};

/* ═══════════ FORMS ═══════════ */
const Forms={
  submitChild(){
    const ok=V.f('cName',V.name,'cNameErr','Minimo 2 caracteres.')+V.f('cAge',V.age,'cAgeErr','Entre 3 e 18 anos.')+V.f('cSchool',V.str,'cSchoolErr','Insira o nome da escola.')+V.f('cAddress',V.addr,'cAddressErr','Endereco muito curto.');
    if(!ok)return;
    UI.spin(true);
    setTimeout(()=>{
      const c=AppState.addChild({name:g('cName').value.trim(),age:Number(g('cAge').value),gender:g('cGender').value,group:g('cGroup').value,school:g('cSchool').value.trim(),address:g('cAddress').value.trim(),emergency_contact:g('cEmergency').value.trim(),authorized:g('cAuthorized').value.trim(),medical_info:g('cMedical').value.trim()});
      AppState.addNotif(`${c.name} foi registada no servico.`,'pickup');
      UI.spin(false);UI.closeModal('childModal');Render.all();Toast.show(`${c.name} registada.`,'success');
    },400);
  },
  submitPayment(){
    const desc=g('pDesc').value.trim(),amt=g('pAmount').value;
    if(!desc||!amt){Toast.show('Preencha todos os campos.','error');return;}
    UI.spin(true);
    setTimeout(()=>{
      const p=DB.insert('payments',{id:DB.nextId('payments'),userId:AppState.user.id,description:desc,amount:Number(amt),status:g('pStatus').value,method:g('pMethod').value,createdAt:new Date().toISOString()});
      AppState.payments.unshift(p);
      if(p.status==='pending')AppState.addNotif(`Pagamento "${desc}" pendente.`,'payment');
      UI.spin(false);UI.closeModal('payModal');Render.sPayments();Toast.show('Pagamento registado.','success');
    },400);
  },
  submitDriver(){
    const name=g('drName').value.trim(),email=g('drEmail').value.trim(),pwd=g('drPwd').value;
    if(!name||!email||!pwd){Toast.show('Preencha os campos obrigatorios.','error');return;}
    if(!V.email(email)){Toast.show('Email invalido.','error');return;}
    if(!V.pwd(pwd)){Toast.show('Senha minimo 6 caracteres.','error');return;}
    UI.spin(true);
    setTimeout(()=>{
      try{
        Auth.register({name,email,password:pwd,phone:g('drPhone').value,role:'driver'});
        const u=DB.find('users',u=>u.email===email.toLowerCase());
        DB.update('users',u.id,{vehicle:g('drVehicle').value,license:g('drLicense').value,route:g('drRoute').value});
        UI.spin(false);UI.closeModal('driverModal');Render.sAdmin();Toast.show(`Motorista ${name} adicionado.`,'success');
      }catch(err){UI.spin(false);Toast.show(err.message,'error');}
    },400);
  }
};

/* ═══════════ UI ═══════════ */
const UI={
  showAuth(){
    g('authScreen').classList.add('active');g('authScreen').style.display='flex';
    g('appShell').classList.remove('active');g('appShell').style.display='none';
    g('loginForm')?.reset();g('loginAlert').innerHTML='';
  },
  authTab(tab){
    g('tabEntrar').classList.toggle('active',tab==='login');
    g('tabRegist').classList.toggle('active',tab==='register');
    g('loginPane').classList.toggle('active',tab==='login');
    g('registerPane').classList.toggle('active',tab==='register');
  },
  showApp(){
    g('authScreen').classList.remove('active');g('authScreen').style.display='none';
    g('appShell').classList.add('active');g('appShell').style.display='flex';
    const u=AppState.user;
    g('topbarAv').textContent=u.name[0];
    const roles={parent:'Responsavel',driver:'Motorista',admin:'Administrador'};
    this._buildBottomNav(u.role);
    this.navTo('overview');
    setTimeout(()=>MapMod.init(),700);
    Realtime.start();
    ChatUI.renderList();
  },
  _buildBottomNav(role){
    const items=NAVS[role]||NAVS.parent;
    g('bottomNav').innerHTML=items.map(it=>`
      <button class="nav-btn${it.id==='overview'?' active':''}" id="ni-${it.id}" onclick="UI.navTo('${it.id}',this)" type="button">
        <div class="nav-icon" style="color:${it.id==='overview'?'#fff':'var(--light)'}">
          ${ICO[it.ico]||''}
          ${it.badge?`<span class="nav-badge" style="display:${AppState.unread()>0?'flex':'none'}">${AppState.unread()}</span>`:''}
          ${it.chatBadge?`<span class="nav-badge chat-nav-badge" style="display:${ChatDB.unreadTotal(AppState.user?.id||0)>0?'flex':'none'}">${ChatDB.unreadTotal(AppState.user?.id||0)}</span>`:''}
        </div>
        <span class="nav-label">${it.label}</span>
      </button>`).join('');
  },
  navTo(id,el){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(n=>{
      n.classList.remove('active');
      const ico=n.querySelector('.nav-icon');if(ico)ico.style.color='var(--light)';
    });
    const s=g('s-'+id);if(s)s.classList.add('active');
    const n=el||g('ni-'+id);
    if(n){
      n.classList.add('active');
      const ico=n.querySelector('.nav-icon');if(ico)ico.style.color='#fff';
    }
    const titles={overview:'Inicio',children:'Criancas',tracking:'Rastreamento',notifications:'Notificacoes',payments:'Pagamentos',routes:'Rota do Dia',security:'Seguranca',admin:'Administracao'};
    if(g('topbarTitle'))g('topbarTitle').textContent=titles[id]||id;
    if(id==='tracking')setTimeout(()=>MapMod._m&&MapMod._m.invalidateSize(),200);
    if(id==='chat')ChatUI.renderList();
    if(id==='notifications'){AppState.notifs.forEach(n=>n.read=true);Render.notifBadge();}
    // scroll to top
    const mc=g('mainContent');if(mc)mc.scrollTop=0;
  },
  toggleNotifDrawer(){
    const d=g('notifDrawer');d.classList.toggle('open');
    if(d.classList.contains('open')){
      AppState.notifs.forEach(n=>n.read=true);
      Render.sNotifications();Render.notifBadge();
    }
  },
  openModal(id){
    g(id).classList.add('active');
    setTimeout(()=>{const f=g(id).querySelector('input');if(f)f.focus();},320);
  },
  closeModal(id){g(id).classList.remove('active')},
  spin(on){g('spinOv').classList.toggle('active',on)},
  alert(eid,msg,type){
    g(eid).innerHTML=`<div class="alert-box ${type}">${msg}</div>`;
    setTimeout(()=>{const e=g(eid);if(e)e.innerHTML=''},5500);
  }
};

const Toast={
  show(msg,type='info',ms=4000){
    const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;
    g('toasts').appendChild(el);
    setTimeout(()=>{el.style.animation='toastOut .22s ease forwards';setTimeout(()=>el.remove(),220)},ms);
  }
};

function g(id){return document.getElementById(id)}


/* ═══════════ CHAT ENGINE ═══════════ */
const ChatDB = {
  // Seed initial Edna user and some messages
  seed() {
    // Ensure Edna exists
    if (!DB.find('users', u => u.email === 'edna@katutransporte.ao')) {
      DB.insert('users', {
        id: 99, name: 'Edna Carvalho', email: 'edna@katutransporte.ao',
        password: 'edna123', phone: '+244 926 789 012', role: 'admin',
        createdAt: new Date().toISOString()
      });
    }
    // Seed demo conversations if none exist
    if (DB.get('chatMsgs').length > 0) return;
    const ts = s => new Date(Date.now() - s).toISOString();
    const msgs = [
      // Edna <-> pai (userId 1)
      {id:1, from:99, to:1, text:'Bom dia, Maria! O Carlos vai recolher as crianças às 06h45 amanhã. Obrigada.', ts:ts(86400000*2), read:true},
      {id:2, from:1, to:99, text:'Bom dia, Edna! Muito obrigada pela informação. A Ana estará pronta.', ts:ts(86400000*2-60000), read:true},
      {id:3, from:99, to:1, text:'Perfeito! Qualquer coisa me avise.', ts:ts(86400000*2-120000), read:true},
      {id:4, from:1, to:99, text:'Edna, a Sofia hoje não vai à escola. Pode avisar o motorista?', ts:ts(3600000), read:true},
      {id:5, from:99, to:1, text:'Certo, já avisei o Carlos. Fique descansada!', ts:ts(3500000), read:false},
      // Driver (userId 2) <-> pai (userId 1)
      {id:6, from:2, to:1, text:'Bom dia! Estou a 5 minutos. A Ana já pode ficar pronta.', ts:ts(7200000), read:true},
      {id:7, from:1, to:2, text:'Perfeito, obrigada Carlos! Ela está pronta.', ts:ts(7100000), read:true},
      {id:8, from:2, to:1, text:'Ana foi entregue na escola com segurança. Bom dia!', ts:ts(6000000), read:true},
      {id:9, from:2, to:1, text:'Aviso: hoje o regresso será às 13h30 em vez de 13h00. Obra na estrada.', ts:ts(1800000), read:false},
      // Edna <-> Driver
      {id:10, from:99, to:2, text:'Carlos, pode confirmar o estado da rota de amanhã?', ts:ts(86400000), read:true},
      {id:11, from:2, to:99, text:'Rota confirmada, Edna. Viaturas revisadas. Tudo certo!', ts:ts(86400000-300000), read:true},
    ];
    msgs.forEach(m => DB.insert('chatMsgs', m));
  },

  getConversations(userId) {
    const all = DB.get('chatMsgs');
    const myMsgs = all.filter(m => m.from === userId || m.to === userId);
    const partnerIds = [...new Set(myMsgs.map(m => m.from === userId ? m.to : m.from))];
    return partnerIds.map(pid => {
      const user = DB.find('users', u => u.id === pid);
      const conv = myMsgs.filter(m => m.from === pid || m.to === pid)
                         .sort((a,b) => new Date(b.ts) - new Date(a.ts));
      const lastMsg = conv[0];
      const unread = conv.filter(m => m.from === pid && !m.read).length;
      return { partner: user, lastMsg, unread };
    }).filter(c => c.partner).sort((a,b) => new Date(b.lastMsg?.ts||0) - new Date(a.lastMsg?.ts||0));
  },

  getMessages(userId, partnerId) {
    return DB.get('chatMsgs')
      .filter(m => (m.from===userId && m.to===partnerId)||(m.from===partnerId && m.to===userId))
      .sort((a,b) => new Date(a.ts) - new Date(b.ts));
  },

  sendMsg(from, to, text) {
    return DB.insert('chatMsgs', {
      id: DB.nextId('chatMsgs'), from, to, text: text.trim(),
      ts: new Date().toISOString(), read: false
    });
  },

  markRead(userId, partnerId) {
    const msgs = DB.get('chatMsgs').map(m =>
      (m.from === partnerId && m.to === userId) ? {...m, read: true} : m
    );
    DB.save('chatMsgs', msgs);
  },

  unreadTotal(userId) {
    return DB.get('chatMsgs').filter(m => m.to === userId && !m.read).length;
  }
};

/* ═══════════ CHAT UI ═══════════ */
const ChatUI = {
  _currentPartner: null,
  _typingTimer: null,
  _autoReplyTimer: null,

  // Render conversation list
  renderList() {
    const u = AppState.user;
    const convs = ChatDB.getConversations(u.id);
    const allUsers = DB.get('users').filter(x => x.id !== u.id);

    // Build list of who we can chat with (those not yet in convs)
    const convPartnerIds = convs.map(c => c.partner.id);
    const newContacts = allUsers.filter(x => !convPartnerIds.includes(x.id) && x.id !== u.id);

    let html = '';

    if (convs.length === 0 && newContacts.length === 0) {
      html = '<div class="chat-empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#94A3B8" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><h4>Sem mensagens</h4><p>Ainda nao ha conversas iniciadas.</p></div>';
    } else {
      if (convs.length > 0) {
        html += '<div class="chat-group-label">Conversas</div>';
        html += convs.map(c => this._convItem(c.partner, c.lastMsg, c.unread)).join('');
      }
      if (newContacts.length > 0) {
        html += '<div class="chat-group-label">Iniciar conversa</div>';
        html += newContacts.map(p => this._convItem(p, null, 0)).join('');
      }
    }

    const el = document.getElementById('chatConvList');
    if (el) el.innerHTML = '<div class="conv-list" style="background:#fff">' + html + '</div>';

    // Chat badge on nav
    const total = ChatDB.unreadTotal(u.id);
    document.querySelectorAll('.chat-nav-badge').forEach(b => {
      b.textContent = total; b.style.display = total > 0 ? 'flex' : 'none';
    });
  },

  _convItem(partner, lastMsg, unread) {
    const av = Render._av(partner.name);
    const roleLabel = {parent:'Encarregado',driver:'Motorista',admin:'Coordenadora'}[partner.role]||partner.role;
    const preview = lastMsg ? lastMsg.text.substring(0,45)+(lastMsg.text.length>45?'...':'') : 'Toque para iniciar conversa';
    const time = lastMsg ? this._fmtTime(lastMsg.ts) : '';
    const isOnline = partner.role === 'driver' || partner.role === 'admin';
    return `<div class="conv-item${unread?' unread-conv':''}" onclick="ChatUI.openConv(${partner.id})">
      <div class="conv-av" style="background:${av}">${partner.name[0]}
        ${isOnline ? '<div class="conv-online"></div>' : ''}
      </div>
      <div class="conv-info">
        <div class="conv-name">${partner.name} <span style="font-size:.66rem;font-weight:500;color:var(--muted);margin-left:.2rem">${roleLabel}</span></div>
        <div class="conv-preview${unread?' bold-p':''}">${lastMsg?(lastMsg.from===AppState.user.id?'Voce: ':'')+''+preview:preview}</div>
      </div>
      <div class="conv-meta">
        <span class="conv-time">${time}</span>
        ${unread>0?`<span class="conv-badge">${unread}</span>`:''}
      </div>
    </div>`;
  },

  openConv(partnerId) {
    const u = AppState.user;
    const partner = DB.find('users', x => x.id === partnerId);
    if (!partner) return;
    this._currentPartner = partner;

    // Mark as read
    ChatDB.markRead(u.id, partnerId);

    // Setup topbar
    const av = Render._av(partner.name);
    document.getElementById('msgContactAv').textContent = partner.name[0];
    document.getElementById('msgContactAv').style.background = av;
    document.getElementById('msgContactName').textContent = partner.name;
    const roleLabel = {parent:'Encarregado',driver:'Motorista',admin:'Coordenadora'}[partner.role]||partner.role;
    const isOnline = partner.role === 'driver' || partner.role === 'admin';
    document.getElementById('msgContactStatus').innerHTML =
      `${isOnline?'<span class="sd sd-g"></span>':''}<span>${isOnline?'Online':'Offline'} &middot; ${roleLabel}</span>`;

    // Render messages
    this.renderMessages();

    // Show view
    document.getElementById('msgView').classList.add('open');
    document.body.style.overflow = 'hidden';

    // Focus input
    setTimeout(() => {
      const inp = document.getElementById('msgInput');
      if (inp) inp.focus();
    }, 350);

    this.renderList();
  },

  renderMessages() {
    const u = AppState.user;
    const p = this._currentPartner;
    if (!p) return;
    const msgs = ChatDB.getMessages(u.id, p.id);
    const body = document.getElementById('msgBody');
    if (!body) return;

    let html = '';
    let lastDate = '';

    if (msgs.length === 0) {
      html = `<div class="chat-empty"><svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="#94A3B8" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><h4>Conversa nova</h4><p>Envie a primeira mensagem para ${p.name}!</p></div>`;
    } else {
      msgs.forEach(m => {
        const date = new Date(m.ts).toLocaleDateString('pt-PT', {day:'2-digit',month:'long'});
        if (date !== lastDate) {
          html += `<div class="msg-date-div"><span>${date}</span></div>`;
          lastDate = date;
        }
        const sent = m.from === u.id;
        const sender = DB.find('users', x => x.id === m.from);
        const senderAv = sender ? Render._av(sender.name) : '#888';
        const senderInit = sender ? sender.name[0] : '?';
        const time = new Date(m.ts).toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
        html += `<div class="bubble-row${sent?' sent':''}">
          ${!sent?`<div class="bubble-av-sm" style="background:${senderAv}">${senderInit}</div>`:''}
          <div class="bubble ${sent?'sent':'received'}">
            ${!sent&&msgs.filter(x=>x.from===m.from).length>1?`<div class="bubble-sender" style="color:${senderAv}">${sender?.name||''}</div>`:''}
            ${m.text}
            <div class="bubble-time">
              ${time}
              ${sent?`<span class="tick"><svg width="14" height="9" viewBox="0 0 16 10" fill="none"><polyline points="1,5 5,9 15,1" stroke="${m.read?'#60A5FA':'rgba(255,255,255,.5)'}" stroke-width="1.8" stroke-linecap="round"/>${m.read?'<polyline points="5,5 9,9 15,1" stroke="#60A5FA" stroke-width="1.8" stroke-linecap="round"/>':''}</svg></span>`:''}
            </div>
          </div>
          ${sent?`<div style="width:26px;flex-shrink:0"></div>`:''}
        </div>`;
      });
    }

    body.innerHTML = html;
    body.scrollTop = body.scrollHeight;
  },

  closeConv() {
    clearTimeout(this._autoReplyTimer);
    clearTimeout(this._typingTimer);
    this._currentPartner = null;
    const v = document.getElementById('msgView');
    v.style.animation = 'none';
    v.style.transform = 'translateX(100%)';
    v.style.transition = 'transform .25s cubic-bezier(.4,0,.2,1)';
    setTimeout(() => {
      v.classList.remove('open');
      v.style.transform = '';
      v.style.transition = '';
    }, 250);
    document.body.style.overflow = '';
    this.renderList();
  },

  send() {
    const inp = document.getElementById('msgInput');
    const u = AppState.user;
    const p = this._currentPartner;
    if (!inp || !p || !inp.value.trim()) return;

    ChatDB.sendMsg(u.id, p.id, inp.value.trim());
    inp.value = '';
    inp.style.height = '';
    document.getElementById('msgSendBtn').disabled = true;
    this.renderMessages();

    // Notify
    AppState.addNotif(`Mensagem enviada para ${p.name}.`, 'info');

    // Simulate auto-reply after delay
    this._scheduleAutoReply(p, u);
  },

  _scheduleAutoReply(partner, sender) {
    clearTimeout(this._autoReplyTimer);
    clearTimeout(this._typingTimer);

    const replies = {
      driver: [
        'Certo, ja estou a tratar disso!',
        'Recebido. Obrigado pelo aviso.',
        'Ok! Estarei ai a hora combinada.',
        'Compreendido. Ate ja!',
        'Perfeito, sem problema.',
        'Ja anotei. Boa tarde!'
      ],
      admin: [
        'Obrigada pela informacao, Maria!',
        'Certo, vou tratar disso imediatamente.',
        'Recebido! Qualquer duvida estou aqui.',
        'Perfeito! Pode ficar descansada.',
        'Ja registamos. Obrigada!',
        'Informacao recebida. Boa tarde!'
      ],
      parent: [
        'Obrigada pelo aviso!',
        'Recebido. Muito obrigada.',
        'Certo, ficamos a aguardar.',
        'Ok! Ate amanha.',
        'Perfeito, obrigada pela comunicacao.'
      ]
    };

    const pool = replies[partner.role] || replies.parent;
    const reply = pool[Math.floor(Math.random() * pool.length)];
    const delay = 2500 + Math.random() * 2000;

    // Show typing indicator
    this._typingTimer = setTimeout(() => {
      const body = document.getElementById('msgBody');
      if (!body || this._currentPartner?.id !== partner.id) return;
      const av = Render._av(partner.name);
      const typingEl = document.createElement('div');
      typingEl.className = 'typing-row';
      typingEl.id = 'typingIndicator';
      typingEl.innerHTML = `
        <div class="bubble-av-sm" style="background:${av}">${partner.name[0]}</div>
        <div class="typing-bubble">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>`;
      body.appendChild(typingEl);
      body.scrollTop = body.scrollHeight;
    }, 800);

    // Send reply
    this._autoReplyTimer = setTimeout(() => {
      const ti = document.getElementById('typingIndicator');
      if (ti) ti.remove();
      if (!this._currentPartner || this._currentPartner.id !== partner.id) {
        // Still store the message even if conv closed
        ChatDB.sendMsg(partner.id, sender.id, reply);
        this.renderList();
        AppState.addNotif(`${partner.name}: ${reply.substring(0,40)}...`, 'info');
        Render.notifBadge();
        return;
      }
      ChatDB.sendMsg(partner.id, sender.id, reply);
      this.renderMessages();
      this.renderList();
    }, delay);
  },

  _fmtTime(iso) {
    try {
      const d = new Date(iso);
      const now = new Date();
      const diff = now - d;
      if (diff < 86400000) return d.toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
      if (diff < 604800000) return d.toLocaleDateString('pt-PT',{weekday:'short'});
      return d.toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit'});
    } catch { return ''; }
  }
};

/* Input auto-resize and send button state */
document.addEventListener('DOMContentLoaded', () => {
  const inp = document.getElementById('msgInput');
  const btn = document.getElementById('msgSendBtn');
  if (inp && btn) {
    inp.addEventListener('input', () => {
      inp.style.height = 'auto';
      inp.style.height = Math.min(inp.scrollHeight, 110) + 'px';
      btn.disabled = !inp.value.trim();
    });
    inp.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ChatUI.send(); }
    });
  }
});

/* ═══════════ BOOT ═══════════ */
document.addEventListener('DOMContentLoaded',()=>{
  DB.seed();
  ChatDB.seed();

  // Star field
  const stars=g('authStars');
  for(let i=0;i<50;i++){
    const s=document.createElement('div');s.className='star';
    const sz=Math.random()*2+.6;
    Object.assign(s.style,{width:sz+'px',height:sz+'px',top:Math.random()*75+'%',left:Math.random()*100+'%',animationDuration:(Math.random()*3+2)+'s',animationDelay:Math.random()*5+'s'});
    stars.appendChild(s);
  }

  // Login
  g('loginForm').addEventListener('submit',e=>{
    e.preventDefault();
    const em=g('lEmail').value,pw=g('lPwd').value;
    let ok=true;
    if(!V.email(em)){g('lEmailErr').textContent='Email invalido.';g('lEmail').classList.add('invalid');ok=false;}
    if(!V.pwd(pw)){g('lPwdErr').textContent='Minimo 6 caracteres.';g('lPwd').classList.add('invalid');ok=false;}
    if(!ok)return;
    UI.spin(true);
    setTimeout(()=>{
      try{
        const u=Auth.login(em,pw);AppState.load();
        UI.spin(false);UI.showApp();Render.all();
        Toast.show(`Bem-vindo, ${u.name.split(' ')[0]}!`,'success');
      }catch(err){UI.spin(false);UI.alert('loginAlert',err.message,'error');}
    },450);
  });

  // Register
  g('registerForm').addEventListener('submit',e=>{
    e.preventDefault();
    const a=V.f('rName',V.name,'rNameErr','Minimo 2 caracteres.');
    const b=V.f('rEmail',V.email,'rEmailErr','Email invalido.');
    const c=V.f('rPwd',V.pwd,'rPwdErr','Minimo 6 caracteres.');
    if(!a||!b||!c)return;
    UI.spin(true);
    setTimeout(()=>{
      try{
        Auth.register({name:g('rName').value,email:g('rEmail').value,phone:g('rPhone').value,password:g('rPwd').value,role:g('rRole').value});
        UI.spin(false);UI.alert('registerAlert','Conta criada! Pode fazer login agora.','success');
        setTimeout(()=>UI.authTab('login'),1800);
      }catch(err){UI.spin(false);UI.alert('registerAlert',err.message,'error');}
    },450);
  });

  // Live validation
  V.live('lEmail',V.email,'lEmailErr','Email invalido.');
  V.live('lPwd',V.pwd,'lPwdErr','Minimo 6 caracteres.');
  V.live('rName',V.name,'rNameErr','Minimo 2 caracteres.');
  V.live('rEmail',V.email,'rEmailErr','Email invalido.');
  V.live('rPwd',V.pwd,'rPwdErr','Minimo 6 caracteres.');

  // Modal backdrop close + ESC + swipe down
  document.querySelectorAll('.modal-ov').forEach(m=>{
    m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active')});
    // Swipe to close
    let startY=0;
    const box=m.querySelector('.modal-box');
    if(box){
      box.addEventListener('touchstart',e=>{startY=e.touches[0].clientY},{passive:true});
      box.addEventListener('touchend',e=>{
        const dy=e.changedTouches[0].clientY-startY;
        if(dy>80)m.classList.remove('active');
      },{passive:true});
    }
  });
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
      document.querySelectorAll('.modal-ov.active').forEach(m=>m.classList.remove('active'));
      g('notifDrawer').classList.remove('open');
    }
  });

  // Swipe down to close notif drawer
  const nd=g('notifDrawer');
  if(nd){
    let sy=0;
    nd.addEventListener('touchstart',e=>{sy=e.touches[0].clientY},{passive:true});
    nd.addEventListener('touchend',e=>{if(e.changedTouches[0].clientY-sy>80)nd.classList.remove('open');},{passive:true});
  }

  // Close notif drawer on outside tap
  document.addEventListener('click',e=>{
    const d=g('notifDrawer'),t=e.target.closest('.icon-btn[onclick*="toggleNotifDrawer"]');
    if(!t&&d?.classList.contains('open')&&!d.contains(e.target))d.classList.remove('open');
  });

  // Restore session
  if(Session.active()&&AppState.load()){UI.showApp();Render.all();}
  else{Session.clear();UI.showAuth();}
});
</script>
</body>
</html>
